<! DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Cockpit - V18 Master</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare. com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2? family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM V10 --- */
        :root {
            --primary:   #4F46E5;
            --bg-app:  #F8FAFC;
            --bg-surface: #FFFFFF;
            --text-main: #1E293B;
            --text-muted: #64748B;
            --border: #E2E8F0;
            
            /* Couleurs Status */
            --c-blue: #3B82F6; --c-green: #10B981; --c-red: #EF4444;
            --success: #10B981; --warning: #F97316;
            
            /* Couleurs Gantt & Badges */
            --g-critique: #EF4444; --g-haute: #F97316; --g-moyenne: #3B82F6; --g-basse: #94A3B8;

            --radius: 10px; --shadow:   0 1px 3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background:   var(--bg-app); color: var(--text-main); margin: 0; padding:  20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        . header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; background: var(--bg-surface); padding: 15px 25px; border-radius: 12px; border: 1px solid var(--border); }
        . app-title { font-weight: 800; font-size: 1.4rem; color: var(--primary); }
        .sync-badge { font-size: 0.75rem; background: #fff; padding: 5px 12px; border-radius: 20px; border: 1px solid var(--border); display: flex; gap: 6px; align-items: center; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; border:   none; font-weight: 600; cursor: pointer; display: flex; gap: 6px; align-items: center; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-2px); }

        /* TOOLBAR */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .nav-pills { display: flex; background: #E2E8F0; padding: 4px; border-radius: 8px; }
        .nav-btn { padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--text-muted); border-radius: 6px; transition: all 0.2s; }
        .nav-btn. active { background: white; color: var(--primary); box-shadow: var(--shadow); }
        .nav-btn:hover { color: var(--primary); }
        .filters { display: flex; gap: 10px; }
        select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; min-width: 150px; background: white; cursor: pointer; }

        /* CONTENT */
        .content-card { flex: 1; background: var(--bg-surface); border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        .view-section { display: none; flex: 1; overflow-y: auto; padding: 25px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD GRID */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { padding: 20px; background: white; border:   1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .kpi-lbl { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
        .kpi-val { font-size: 2rem; font-weight: 800; }
        .kpi-sub { font-size: 0.85rem; font-weight: 600; margin-top: 5px; }

        /* STATS */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap:   20px; margin-bottom:   30px; }
        . stat-box { background: #FAFAFA; border:   1px solid var(--border); border-radius: 12px; padding: 20px; }
        .stat-head { font-weight: 700; border-bottom: 1px solid #E2E8F0; padding-bottom: 10px; margin-bottom: 10px; }
        .bar-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
        .bar-lbl { width: 130px; font-weight: 500; white-space: nowrap; overflow:   hidden; text-overflow:  ellipsis; }
        . bar-track { flex: 1; height: 8px; background: #E2E8F0; border-radius:   4px; margin:   0 10px; }
        .bar-fill { height: 100%; border-radius:  4px; }
        .bar-val { width: 30px; text-align: right; font-weight: 700; }

        . sect-head { font-size: 1.1rem; font-weight: 700; margin:   0 0 15px 0; border-left: 4px solid var(--primary); padding-left: 10px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { padding: 12px 15px; background: #F8FAFC; text-align: left; color: var(--text-muted); font-weight: 700; position: sticky; top: 0; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); vertical-align: top; }
        tr:hover td { background: #F8FAFC; cursor: pointer; }

        . badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; margin-top: 3px; }
        .badge-team { color: white; text-transform: uppercase; margin-top: 4px; border:   none; padding: 4px 10px; }
        .agent-stack { display: flex; flex-direction: column; align-items: flex-start; }

        /* GANTT CLEAN */
        .gantt-wrapper { overflow:  auto; height: 100%; }
        .gantt . grid-header { background: #fff; height: 50px; }
        .gantt .grid-row { fill: #fff; } 
        .gantt .grid-row:nth-child(even) { fill: #FCFCFC; }
        . gantt .row-line { stroke: #F1F5F9; } 
        .gantt .bar { rx: 3px; ry: 3px; stroke: none; }
        .gantt .bar-label { fill: #333; font-weight: 600; font-size: 12px; }
        .bar-critique . bar { fill: var(--g-critique) !important; }
        .bar-haute .bar { fill: var(--g-haute) !important; }
        .bar-moyenne .bar { fill: var(--g-moyenne) !important; }
        .bar-basse . bar { fill: var(--g-basse) !important; }
        .bar-termine .bar { fill: var(--c-green) !important; }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; width: 500px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-box. mini { width: 350px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .input-group { display: flex; gap: 5px; }
        .btn-plus { width: 35px; height: 36px; border:  1px solid var(--border); background: #F1F5F9; color:  var(--primary); border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .btn-plus:hover { background: var(--primary); color: white; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
        input:focus, select:focus { border-color: var(--primary); background: #F8FAFC; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .btn-ghost:hover { background: #F8FAFC; }
    </style>
</head>
<body>

    <header class="header">
        <div class="app-title">Gantt'<span>FIP</span></div>
        <div style="display: flex; align-items: center; gap: 16px;">
            <div id="syncStatus" class="sync-badge">
                <span style="display: inline-block; width: 8px; height: 8px; background: var(--warning); border-radius:50%;" id="syncDot"></span>
                <span id="syncText">Initialisation...</span>
            </div>
            <button class="btn-primary" onclick="openModal()"><span>+</span> T√¢che</button>
        </div>
    </header>

    <div class="toolbar">
        <div class="nav-pills">
            <button class="nav-btn active" onclick="switchView('dashboard', this)">Tableau de Bord</button>
            <button class="nav-btn" onclick="switchView('gantt', this)">Planning Gantt</button>
            <button class="nav-btn" onclick="switchView('list', this)">Liste</button>
        </div>
        <div class="filters">
            <select id="filterProject" onchange="applyFilters()"><option value="">Tous les Projets</option></select>
            <select id="filterTeam" onchange="applyFilters()"><option value="">Toutes les Admin. </option></select>
            <select id="filterAgent" onchange="applyFilters()"><option value="">Tous les Agents</option></select>
        </div>
    </div>

    <div class="content-card">
        
        <div id="view-dashboard" class="view-section active">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-lbl">Total</div>
                    <div class="kpi-val" id="kpi-total">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">En Cours</div>
                    <div class="kpi-val" style="color: var(--c-blue)" id="kpi-cours">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">Termin√©es</div>
                    <div class="kpi-val" style="color: var(--c-green)" id="kpi-done">0</div>
                    <div class="kpi-sub" style="color: var(--c-green)" id="kpi-rate">0%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">Retard</div>
                    <div class="kpi-val" style="color:var(--c-red)" id="kpi-retard">0</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-head">R√©partition par Priorit√©</div>
                    <div id="stats-prio"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-head">Charge par Administration</div>
                    <div id="stats-team"></div>
                </div>
            </div>

            <div class="sect-head">üìÖ T√¢ches √† venir</div>
            <table>
                <thead><tr><th>T√¢che & Projet</th><th>Responsable</th><th>√âch√©ance</th><th>Statut</th></tr></thead>
                <tbody id="upcomingListBody"></tbody>
            </table>
        </div>

        <div id="view-gantt" class="view-section">
            <div style="margin-bottom: 10px; display: flex; gap: 10px; justify-content:   flex-end;">
                <button class="nav-btn" onclick="ganttChart && ganttChart.change_view_mode('Day')">Jour</button>
                <button class="nav-btn active" onclick="ganttChart && ganttChart.change_view_mode('Week')">Semaine</button>
                <button class="nav-btn" onclick="ganttChart && ganttChart.change_view_mode('Month')">Mois</button>
            </div>
            <div id="gantt-chart" class="gantt-wrapper"></div>
        </div>

        <div id="view-list" class="view-section">
            <div class="sect-head">üóÇÔ∏è Inventaire Complet</div>
            <table>
                <thead><tr><th>T√¢che & Projet</th><th>Responsable</th><th>Fin</th><th>Priorit√©</th><th>Progression</th></tr></thead>
                <tbody id="fullListBody"></tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal-box">
            <div style="display: flex;justify-content:space-between;margin-bottom:20px">
                <h2 style="margin:  0" id="modalTitle">T√¢che</h2>
                <button onclick="closeModal()" style="border: none;background:none;font-size:1.5rem;cursor:pointer;color:#999">√ó</button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="inpId">
                <div style="margin-bottom: 15px">
                    <label>Titre</label>
                    <input type="text" id="inpTitle" required>
                </div>
                <div class="form-grid">
                    <div>
                        <label>Projet</label>
                        <div class="input-group">
                            <select id="inpProject" required></select>
                            <button type="button" class="btn-plus" onclick="openQuickCreate('Project')">+</button>
                        </div>
                    </div>
                    <div>
                        <label>Responsable</label>
                        <div class="input-group">
                            <select id="inpAgent"></select>
                            <button type="button" class="btn-plus" onclick="openQuickCreate('Agent')">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-grid">
                    <div>
                        <label>D√©but</label>
                        <input type="date" id="inpStart" required>
                    </div>
                    <div>
                        <label>Fin</label>
                        <input type="date" id="inpEnd" required>
                    </div>
                </div>
                <div class="form-grid">
                    <div>
                        <label>Avancement %</label>
                        <input type="number" id="inpProgress" min="0" max="100" value="0">
                    </div>
                    <div>
                        <label>Priorit√©</label>
                        <select id="inpPriority">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-ghost" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="qcModal">
        <div class="modal-box mini">
            <div style="display:flex;justify-content:space-between;margin-bottom:20px">
                <h3 id="qcTitle" style="margin: 0">Nouveau</h3>
                <button onclick="closeQuickCreate()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;color:#999">√ó</button>
            </div>
            <input type="hidden" id="qcType">
            <div style="margin-bottom:15px">
                <label>Nom</label>
                <input type="text" id="qcName">
            </div>
            <div id="qcExtra" style="display:none; margin-bottom:15px">
                <label>Administration</label>
                <div class="input-group">
                    <select id="qcTeamSel"></select>
                    <button type="button" class="btn-plus" onclick="openQuickCreate('Team')">+</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-ghost" onclick="closeQuickCreate()">Fermer</button>
                <button type="button" onclick="saveQuickCreate()" class="btn-primary">Cr√©er</button>
            </div>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api. js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min. js"></script>

    <script>
        // === CONFIGURATION GRIST ===
        const DB = { 
            TASKS: 'TACHES_MASTER', 
            AGENTS: 'AGENTS', 
            PROJECTS: 'PROJETS', 
            TEAMS: 'EQUIPES' 
        };
        let appData = { tasks: [], agents: [], projects: [], teams: [] };
        let ganttChart = null;

        // === INITIALISATION GRIST - CORRIG√âE ===
        grist.ready({ requiredAccess: 'full' });

        // √âv√©nement appel√© au premier chargement ET quand les donn√©es changent
        grist.onRecords(async (records, mappings) => {
            console.log('üîÑ grist.onRecords d√©clench√©');
            console.log('Records re√ßus:', records);
            console.log('Mappings:', mappings);
            
            try {
                updateSyncStatus("Chargement.. .", "var(--warning)");
                await loadAllData();
                updateSyncStatus("Pr√™t", "var(--success)");
            } catch (e) {
                console.error('‚ùå Erreur onRecords:', e);
                updateSyncStatus("Erreur", "var(--c-red)");
            }
        });

        // === CHARGEMENT DES DONN√âES - CORRIG√â ===
        async function loadAllData() {
            try {
                console.log('üì• Chargement de toutes les donn√©es...');
                
                // Charger les donn√©es via fetchTable
                const [rTasks, rAgents, rProjects, rTeams] = await Promise.all([
                    grist. docApi.fetchTable(DB.TASKS), 
                    grist. docApi.fetchTable(DB. AGENTS),
                    grist.docApi.fetchTable(DB.PROJECTS), 
                    grist. docApi.fetchTable(DB. TEAMS)
                ]);

                console.log('Raw Teams:', rTeams);
                console.log('Raw Projects:', rProjects);
                console.log('Raw Agents:', rAgents);
                console.log('Raw Tasks:', rTasks);

                // Convertir et charger les √©quipes
                appData.teams = convertTable(rTeams).map(r => ({ 
                    id: r.id, 
                    name: r. Nom || r.Nom_Equipe || "√âquipe" 
                }));
                console.log('‚úÖ √âquipes charg√©es:', appData.teams);

                // Convertir et charger les projets
                appData.projects = convertTable(rProjects).map(r => ({ 
                    id: r.id, 
                    name: r. Nom_Projet || r.Nom || "Projet"
                }));
                console. log('‚úÖ Projets charg√©s:', appData.projects);
                
                // Convertir et charger les agents
                appData.agents = convertTable(rAgents).map(r => {
                    const team = appData.teams.find(t => t.id === r. Equipe);
                    return { 
                        id: r. id, 
                        name:  r.Nom_Complet || r.Nom || "Agent", 
                        teamName: team ? team.name : null 
                    };
                });
                console.log('‚úÖ Agents charg√©s:', appData.agents);

                // Convertir et charger les t√¢ches
                appData.tasks = convertTable(rTasks).map(t => {
                    const agent = appData.agents.find(a => a.id === t. Responsable) || { name: 'Non assign√©', teamName: null };
                    const project = appData.projects.find(p => p.id === t.Projet) || { name: 'Aucun' };
                    
                    let color = 'bar-basse';
                    if(t.Avancement === 100) color = 'bar-termine';
                    else if (t.Priorite === 'Critique') color = 'bar-critique';
                    else if (t.Priorite === 'Haute') color = 'bar-haute';
                    else if (t. Priorite === 'Moyenne') color = 'bar-moyenne';

                    return {
                        ... t, 
                        id: String(t.id),
                        displayAgent: agent.name, 
                        displayTeam: agent.teamName, 
                        displayProject: project.name,
                        name: t.Titre || "Sans titre", 
                        start: formatDateIso(t.Date_Debut), 
                        end: formatDateIso(t.Date_Fin),
                        progress: t.Avancement || 0, 
                        dependencies: t.Dependances || "", 
                        custom_class: color
                    };
                });
                
                appData.tasks. sort((a,b) => new Date(a.start) - new Date(b.start));
                console.log('‚úÖ T√¢ches charg√©es:', appData.tasks);
                
                refreshUI();
            } catch (e) { 
                console.error('‚ùå Erreur loadAllData:', e); 
                updateSyncStatus("Erreur chargement", "var(--c-red)"); 
            }
        }

        // === RAFRA√éCHISSEMENT UI ===
        function refreshUI() { 
            populateSelects(); 
            applyFilters(); 
        }

        function applyFilters() {
            const fP = document.getElementById('filterProject').value;
            const fT = document.getElementById('filterTeam').value;
            const fA = document.getElementById('filterAgent').value;

            const res = appData.tasks.filter(t => 
                (fP === "" || String(t.Projet) === fP) && 
                (fT === "" || (t.displayTeam && t.displayTeam === fT)) &&
                (fA === "" || String(t.Responsable) === fA)
            );

            console.log('üîç Filtres appliqu√©s:', { fP, fT, fA, count: res.length });
            renderDashboard(res);
            renderList(res);
            renderGantt(res);
        }

        // === RENDU DASHBOARD ===
        function renderDashboard(tasks) {
            const tot = tasks.length;
            const done = tasks.filter(t=>t.progress==100).length;
            const active = tasks.filter(t=>t.progress>0 && t.progress<100).length;
            const late = tasks.filter(t=>new Date(t.end)<new Date() && t.progress<100).length;
            const rate = tot ?   Math.round((done/tot)*100) : 0;

            document.getElementById('kpi-total').innerText = tot;
            document. getElementById('kpi-cours').innerText = active;
            document.getElementById('kpi-done').innerText = done;
            document.getElementById('kpi-rate').innerText = rate + "%";
            document.getElementById('kpi-retard').innerText = late;

            // Stats Priorit√©s
            const pMap = {'Critique': 0,'Haute': 0,'Moyenne':  0,'Basse':0};
            const pCols = {'Critique':'#EF4444','Haute':'#F97316','Moyenne':'#3B82F6','Basse':'#94A3B8'};
            tasks.forEach(t => { if(pMap[t.Priorite]! ==undefined) pMap[t.Priorite]++; });
            let hP = "";
            for(const [k,v] of Object. entries(pMap)) {
                if(v>0) {
                    const pc = Math.round((v/tot)*100);
                    hP += `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${pc}%;background:  ${pCols[k]}"></div></div><div class="bar-val">${v}</div></div>`;
                }
            }
            document.getElementById('stats-prio').innerHTML = hP || "<div style='color:#999'>Rien</div>";

            // Stats Administration
            const tMap = {};
            tasks.forEach(t => { const tm = t.displayTeam||"Sans Admin"; tMap[tm]=(tMap[tm]||0)+1; });
            let hT = "";
            for(const [k,v] of Object.entries(tMap)) {
                const pc = Math.round((v/tot)*100);
                const col = strColor(k);
                hT += `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:  ${pc}%;background: ${col}"></div></div><div class="bar-val">${v}</div></div>`;
            }
            document.getElementById('stats-team').innerHTML = hT || "<div style='color:#999'>Rien</div>";

            // Liste Upcoming
            const upcoming = tasks.filter(t => t.progress<100 && new Date(t.end)>=new Date()).slice(0,5);
            const tb = document.getElementById('upcomingListBody');
            tb.innerHTML = "";
            upcoming.forEach(t => {
                const bdgT = t.displayTeam ?   `<br><span class="badge badge-team" style="background: ${strColor(t.displayTeam)}">${t.displayTeam}</span>` : '';
                tb.innerHTML += `<tr onclick="openModal(appData.tasks. find(x=>x.id=='${t.id}'))"><td><div style="font-weight: 600">${t.Titre}</div><span class="badge" style="background: ${strColor(t.displayProject)}">${t.displayProject}</span>${bdgT}</td><td>${t.displayAgent}</td><td>${t. end}</td><td><span class="badge" style="background:${getPriorityColor(t.Priorite)};color:white">${t.Priorite}</span></td></tr>`;
            });
            if(! upcoming.length) tb.innerHTML = "<tr><td colspan='4' style='text-align:center;padding:15px;color:#999'>Aucune t√¢che √† venir</td></tr>";
        }

        // === RENDU LISTE ===
        function renderList(tasks) {
            const tb = document.getElementById('fullListBody');
            tb.innerHTML = "";
            tasks.forEach(t => {
                const bdgT = t.displayTeam ?  `<br><span class="badge badge-team" style="background: ${strColor(t.displayTeam)}">${t.displayTeam}</span>` : '';
                tb.innerHTML += `<tr onclick="openModal(appData. tasks.find(x=>x. id=='${t.id}'))"><td><div style="font-weight:  600">${t.Titre}</div><span class="badge" style="background:${strColor(t.displayProject)}">${t.displayProject}</span>${bdgT}</td><td>${t. displayAgent}</td><td>${t.end}</td><td><span class="badge" style="background: ${getPriorityColor(t.Priorite)};color:white">${t.Priorite}</span></td><td><div style="width:100px;height:8px;background:#E2E8F0;border-radius:4px"><div style="height:100%;width:${t.progress}%;background:${getStatusColor(t.progress)};border-radius:4px"></div></div></td></tr>`;
            });
        }

        // === RENDU GANTT ===
        function renderGantt(tasks) {
            const el = document.getElementById('gantt-chart');
            el.innerHTML = "";
            if(! tasks.length) { 
                el.innerHTML="<p style='text-align:center;padding:20px;color:#999'>Rien √† afficher</p>"; 
                return; 
            }
            
            const gData = [... tasks].sort((a,b) => (a.displayProject > b.displayProject) ? 1 : -1);
            ganttChart = new Gantt("#gantt-chart", gData, {
                header_height: 50, column_width: 30, step: 24, view_modes: ['Day', 'Week', 'Month'],
                bar_height: 25, bar_corner_radius: 3, arrow_curve: 5, padding: 18, view_mode: 'Week',
                date_format: 'YYYY-MM-DD', language: 'fr',
                on_click: t => openModal(appData.tasks.find(x=>x.id==t.id)),
                on_date_change: (t,s,e) => saveAction('UpdateRecord', DB.TASKS, t.id, {Date_Debut: formatDateIso(s), Date_Fin: formatDateIso(e)}),
                on_progress_change: (t,p) => saveAction('UpdateRecord', DB.TASKS, t.id, {Avancement: p})
            });
            console.log('üìä Gantt rendu:', gData.length, 't√¢ches');
        }

        // === SAUVEGARDE ACTIONS ===
        async function saveAction(action, table, rowId, fields) {
            updateSyncStatus("Sauvegarde.. .", "var(--warning)");
            const args = action === 'AddRecord' ? [null, fields] : [parseInt(rowId), fields];
            try { 
                console.log('üíæ Sauvegarde:', { action, table, rowId, fields });
                const result = await grist.docApi. applyUserActions([[action, table, ... args]]);
                console.log('‚úÖ Action r√©ussie:', result);
                updateSyncStatus("Enregistr√©!", "var(--success)");
            }
            catch (e) { 
                console.error('‚ùå Erreur saveAction:', e); 
                alert("Erreur :  " + (e.message || e)); 
                updateSyncStatus("Erreur", "var(--c-red)"); 
            }
        }

        // === MODAL T√ÇCHE ===
        function openModal(task = null) {
            const form = document.getElementById('taskForm');
            if(task) {
                document.getElementById('modalTitle').innerText = "Modifier";
                document.getElementById('inpId').value = task.id;
                document.getElementById('inpTitle').value = task.Titre;
                document.getElementById('inpProject').value = task.Projet;
                document.getElementById('inpAgent').value = task.Responsable;
                document.getElementById('inpStart').value = task.start;
                document.getElementById('inpEnd').value = task.end;
                document.getElementById('inpProgress').value = task.progress;
                document.getElementById('inpPriority').value = task.Priorite;
            } else {
                form.reset();
                document.getElementById('modalTitle').innerText = "Nouveau";
                document.getElementById('inpId').value = "";
                document.getElementById('inpProgress').value = "0";
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('inpStart').value = today;
                document.getElementById('inpEnd').value = today;
            }
            document.getElementById('taskModal').style.display = 'flex';
        }

        function closeModal() { 
            document.getElementById('taskModal').style.display='none'; 
        }

        // √âv√©nement soumission formulaire t√¢che
        document.getElementById('taskForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('inpId').value;
            const data = {
                Titre: document.getElementById('inpTitle').value,
                Projet: parseInt(document.getElementById('inpProject').value),
                Responsable: parseInt(document.getElementById('inpAgent').value),
                Date_Debut: document.getElementById('inpStart').value,
                Date_Fin: document.getElementById('inpEnd').value,
                Avancement: parseInt(document.getElementById('inpProgress').value),
                Priorite: document.getElementById('inpPriority').value
            };
            await saveAction(id ?  'UpdateRecord' : 'AddRecord', DB.TASKS, id, data);
            closeModal();
        };

        // === MODAL CR√âATION RAPIDE ===
        function openQuickCreate(type) {
            document.getElementById('qcType').value = type;
            document.getElementById('qcName').value = '';
            document.getElementById('qcExtra').style.display = 'none';
            let t = "Nouveau";
            if(type=='Project') t="Nouveau Projet";
            if(type=='Team') t="Nouvelle Administration";
            if(type=='Agent') { 
                t="Nouvel Agent"; 
                document.getElementById('qcExtra').style.display = 'block'; 
                populateSelectBox('#qcTeamSel', appData.teams); 
            }
            document. getElementById('qcTitle').innerText = t;
            document.getElementById('qcModal').style.display='flex';
        }

        function closeQuickCreate() { 
            document.getElementById('qcModal').style.display='none'; 
        }

        async function saveQuickCreate() {
            const type = document.getElementById('qcType').value;
            const name = document.getElementById('qcName').value. trim();
            if(!name) { alert("Veuillez entrer un nom"); return; }
            
            let tab, fields;
            if (type === 'Project') { 
                tab = DB.PROJECTS; 
                fields = { Nom_Projet: name }; 
            }
            else if (type === 'Team') { 
                tab = DB.TEAMS; 
                fields = { Nom:  name }; 
            } 
            else if (type === 'Agent') { 
                tab = DB.AGENTS; 
                fields = { 
                    Nom_Complet: name, 
                    Equipe: parseInt(document.getElementById('qcTeamSel').value)||null 
                }; 
            }
            
            await saveAction('AddRecord', tab, null, fields);
            closeQuickCreate();
        }

        // === GESTION SELECTS ===
        function populateSelects() {
            populateSelectBox('#filterProject, #inpProject', appData.projects);
            populateSelectBox('#filterTeam', appData.teams, true); 
            populateSelectBox('#filterAgent, #inpAgent', appData. agents); 
        }

        function populateSelectBox(sel, list, useName=false) {
            document.querySelectorAll(sel).forEach(el => {
                const v = el.value; 
                const d = el.options[0]; 
                el.innerHTML = ""; 
                el.appendChild(d);
                list.forEach(i => { 
                    const o = document.createElement('option'); 
                    o. value = useName ? i.name : i. id; 
                    o.innerText = i.name; 
                    el.appendChild(o); 
                });
                if(list.some(i=>(useName?  i.name:i.id)==v)) el.value = v;
            });
        }

        // === UTILITAIRES ===
        function updateSyncStatus(msg, color) { 
            const dot = document.getElementById('syncDot'); 
            dot.style.background = color; 
            document.getElementById('syncText').textContent = msg;
        }

        function switchView(v, btn) { 
            document.querySelectorAll('. view-section').forEach(e=>e.classList.remove('active')); 
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            btn.classList. add('active');
            console.log('üîÄ Vue chang√©e:', v);
        }

        function convertTable(t) { 
            const k = Object.keys(t); 
            if(! k.length) return []; 
            const len = t.id.length; 
            const res = []; 
            for(let i=0;i<len;i++){ 
                let o = {}; 
                k.forEach(key => o[key] = t[key][i]); 
                res. push(o); 
            } 
            return res;
        }

        function formatDateIso(v) { 
            if(!v) return new Date().toISOString().split('T')[0]; 
            const d = typeof v==='number' ? new Date(v*1000) : new Date(v); 
            return d.toISOString().split('T')[0]; 
        }

        function strColor(s) { 
            let h=0;
            for(let i=0;i<s.length;i++) h=s.charCodeAt(i)+((h<<5)-h);
            return `hsl(${h%360},70%,40%)`; 
        }

        function getPriorityColor(p) {
            const colors = {
                'Critique': '#EF4444',
                'Haute': '#F97316',
                'Moyenne': '#3B82F6',
                'Basse': '#94A3B8'
            };
            return colors[p] || '#94A3B8';
        }

        function getStatusColor(progress) {
            if(progress === 100) return '#10B981';
            if(progress >= 75) return '#3B82F6';
            if(progress >= 50) return '#F97316';
            return '#EF4444';
        }
    </script>
</body>
</html>
