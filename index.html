<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt'FIP Ultimate v8.1</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        /* --- 1. DESIGN SYSTEM (IDENTIQUE V6.5) --- */
        :root {
            --primary: var(--grist-theme-cursor, #2563eb);
            --primary-light: #eff6ff;
            --bg: var(--grist-theme-page-bg, #f8fafc);
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sec: #64748b;
            --border: #e2e8f0;
            
            /* Couleurs S√©mantiques */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;

            /* Formes */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            font-size: 14px;
            line-height: 1.5;
            padding-bottom: 80px;
            user-select: none;
        }

        /* --- 2. LAYOUT & NAVIGATION --- */
        .app-header {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1.app-logo {
            font-size: 22px;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(135deg, var(--primary), #4f46e5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .nav-pills {
            display: flex;
            background: #e2e8f0;
            padding: 4px;
            border-radius: var(--radius-lg);
            width: fit-content;
            gap: 4px;
        }

        .nav-item {
            padding: 8px 20px;
            border-radius: var(--radius-md);
            border: none;
            background: transparent;
            color: var(--text-sec);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-item.active {
            background: var(--surface);
            color: var(--text-main);
            box-shadow: var(--shadow-sm);
        }

        /* --- 3. ACTIONS & FILTRES --- */
        .toolbar {
            display: grid;
            /* Modif: 3 colonnes pour les filtres + auto */
            grid-template-columns: 1fr 1fr 1fr auto; 
            gap: 12px;
            margin-bottom: 20px;
        }

        .select-modern {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--surface);
            color: var(--text-main);
            font-size: 13px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: transform 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:active { transform: scale(0.98); }

        /* AJOUT: Bouton Print Flottant (FAB) */
        .fab-print {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px; height: 50px;
            border-radius: 50%;
            background: var(--text-main);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-size: 24px;
            cursor: pointer;
            z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- 4. VUES --- */
        .view-container { display: none; animation: fadeIn 0.4s ease; }
        .view-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* VUE 1: DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--surface);
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stat-title { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-sec); letter-spacing: 0.5px; }
        .stat-value { font-size: 32px; font-weight: 800; margin: 8px 0; color: var(--text-main); }
        .stat-footer { font-size: 12px; color: var(--text-sec); display: flex; align-items: center; gap: 4px; }

        .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .chart-box { background: var(--surface); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); }
        
        .bar-group { margin-bottom: 12px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; font-weight: 500; }
        .bar-bg { height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 4px; }
        .mini-table { width: 100%; border-collapse: collapse; }
        .mini-table td { padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        /* VUE 2: GANTT (Modifi√©e pour Grouping & Red Line) */
        .gantt-wrapper {
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow-x: auto;
            padding: 0; /* Padding enlev√© pour coller les headers */
            position: relative;
            min-height: 400px;
        }
        .gantt-header { 
            display: flex; 
            border-bottom: 1px solid var(--border); 
            height: 40px; 
            position: sticky; top: 0; background: var(--surface); z-index: 20;
        }
        /* AJOUT: Sidebar Header */
        .gantt-sidebar-head { width: 200px; flex-shrink:0; border-right: 1px solid var(--border); padding: 10px; font-weight: bold; font-size:12px; display:flex; align-items:center; background:#f8fafc; }
        .gantt-timeline-head { flex-grow: 1; position: relative; }

        .gantt-line { display: flex; align-items: center; border-bottom: 1px solid #f1f5f9; height: 36px; position: relative; }
        .gantt-text { width: 200px; flex-shrink: 0; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 10px; cursor: pointer; border-right: 1px solid var(--border); background: var(--surface); position:sticky; left:0; z-index:10; display:flex; align-items:center; height:100%; }
        .gantt-timeline { flex-grow: 1; position: relative; height: 100%; }
        
        .gantt-block { 
            position: absolute; 
            height: 20px; 
            top: 8px; 
            border-radius: 4px; 
            min-width: 8px; 
            cursor: grab; 
            transition: box-shadow 0.2s, opacity 0.2s; 
            z-index: 5;
            font-size: 10px; color: white; display: flex; align-items: center; padding-left: 5px; white-space: nowrap; overflow: hidden;
        }
        .gantt-block:active { cursor: grabbing; z-index: 20; }
        
        /* AJOUT: Groupe & Red Line */
        .gantt-group-title { background: #f1f5f9; padding: 6px 10px; font-weight: 700; font-size: 12px; border-bottom: 1px solid var(--border); border-top: 1px solid var(--border); position:sticky; left:0; width:100%; z-index:15; }
        .today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: red; z-index: 8; pointer-events: none; }
        .today-label { position: absolute; top: -20px; left: -20px; background: red; color: white; padding: 2px 4px; font-size: 10px; border-radius: 3px; }

        /* VUE 3: LISTE */
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-card {
            background: var(--surface);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .task-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        .task-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #cbd5e1; }
        
        .priority-high::before { background: var(--danger); }
        .priority-medium::before { background: var(--warning); }
        .priority-low::before { background: var(--success); }

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-h3 { font-size: 15px; font-weight: 700; margin: 0; }
        .card-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 12px; font-weight: 600; color: #fff; }
        
        .card-btm { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-sec); }
        .avatar-row { display: flex; align-items: center; gap: 6px; }

        /* --- 5. MODALE (EDITION/CREATION) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }

        .modal-box {
            background: var(--surface);
            width: 100%;
            max-width: 500px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 700; margin: 0; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-sec); }
        
        .modal-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
        
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-sec); }
        
        /* AJOUT: Input avec bouton + */
        .input-row-plus { display: flex; gap: 8px; }
        .btn-plus { width: 34px; flex-shrink:0; border:1px solid var(--border); background:#f1f5f9; font-weight:bold; cursor:pointer; border-radius:var(--radius-md); font-size:16px; color:var(--primary); }
        
        .form-input { padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; width: 100%; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 10px 20px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; }
        
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .loading { text-align: center; color: var(--text-sec); margin-top: 50px; }

        /* --- 6. PRINT STYLES --- */
        @media print {
            body { background: white; padding: 0; margin: 0; overflow: visible; }
            .app-header, .toolbar, .close-btn, .modal-overlay, .btn-primary, .btn-secondary, .fab-print { display: none !important; }
            .view-container { display: block !important; width: 100% !important; animation: none; }
            .gantt-wrapper, .dashboard-grid, .task-list { border: none; box-shadow: none; width: 100%; overflow: visible; }
            .gantt-wrapper { overflow-x: hidden; }
            @page { size: landscape; margin: 1cm; }
        }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="header-top">
            <h1 class="app-logo">Gantt'FIP</h1>
            <button class="btn-primary" onclick="openModal()">
                <span>+ Nouvelle T√¢che</span>
            </button>
        </div>
        
        <nav class="nav-pills">
            <button class="nav-item active" onclick="switchView('dashboard')">Tableau de Bord</button>
            <button class="nav-item" onclick="switchView('gantt')">Gantt</button>
            <button class="nav-item" onclick="switchView('list')">Liste</button>
        </nav>
    </div>

    <div id="main-toolbar" class="toolbar" style="display:none">
        <select id="filter-project" class="select-modern" onchange="handleFilters()">
            <option value="all">Tous les projets</option>
        </select>
        <select id="filter-team" class="select-modern" onchange="handleFilters()">
            <option value="all">Toutes les administrations</option>
        </select>
        <select id="filter-assignee" class="select-modern" onchange="handleFilters()">
            <option value="all">Tous les responsables</option>
        </select>
        <select id="gantt-scale" class="select-modern" style="display:none" onchange="changeGanttScale(this.value)">
            <option value="day">Vue: Jour</option>
            <option value="week">Vue: Semaine</option>
            <option value="month">Vue: Mois</option>
        </select>
    </div>

    <button class="fab-print" onclick="window.print()" title="Imprimer">üñ®Ô∏è</button>

    <div id="app-content">
        <div class="loading">Chargement des donn√©es...</div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title">Nouvelle T√¢che</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="input-id">
                
                <div class="form-group">
                    <label class="form-label">Titre de la t√¢che</label>
                    <input type="text" id="input-title" class="form-input" placeholder="Ex: R√©diger le rapport...">
                </div>

                <div class="form-group">
                    <label class="form-label">Projet</label>
                    <div class="input-row-plus">
                        <input list="list-projects" id="input-project" class="form-input" placeholder="Choisir ou cr√©er...">
                        <button class="btn-plus" onclick="addItem('input-project')">+</button>
                    </div>
                    <datalist id="list-projects"></datalist>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Administration (Team)</label>
                    <div class="input-row-plus">
                        <input list="list-teams" id="input-team" class="form-input" placeholder="Choisir ou cr√©er...">
                        <button class="btn-plus" onclick="addItem('input-team')">+</button>
                    </div>
                    <datalist id="list-teams"></datalist>
                </div>

                <div class="form-group">
                    <label class="form-label">Responsable</label>
                    <div class="input-row-plus">
                        <input list="list-assignees" id="input-assignee" class="form-input" placeholder="Qui est en charge ?">
                        <button class="btn-plus" onclick="addItem('input-assignee')">+</button>
                    </div>
                    <datalist id="list-assignees"></datalist>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Priorit√©</label>
                        <select id="input-priority" class="form-input">
                            <option value="Low">Low (Basse)</option>
                            <option value="Normal">Normal (Normale)</option> <option value="High">High (Haute)</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date de D√©but</label>
                        <input type="date" id="input-start" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date de Fin</label>
                        <input type="date" id="input-end" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Progression (%)</label>
                    <input type="number" id="input-progress" class="form-input" min="0" max="100" value="0">
                    <input type="range" id="range-progress" min="0" max="100" value="0" style="margin-top:8px" oninput="document.getElementById('input-progress').value = this.value">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-sec" onclick="closeModal()">Annuler</button>
                <button class="btn-primary" onclick="saveTask()">Enregistrer</button>
            </div>
        </div>
    </div>

<script>
    /**
     * ===========================================
     * GANTT'FIP ULTIMATE - V8.1 (STRICT BASE V6.5)
     * ===========================================
     */

    // --- 1. CONFIGURATION STRICTE ---
    const MAPPING = [
        { name: 'Title',     title: 'Titre' },
        { name: 'Assignee',  title: 'Responsable' },
        { name: 'Team',      title: 'Administration' },
        { name: 'Project',   title: 'Projet' },
        { name: 'StartDate', title: 'D√©but', type: 'Date' },
        { name: 'EndDate',   title: 'Fin',   type: 'Date' },
        { name: 'Progress',  title: 'Progression', type: 'Numeric' },
        { name: 'Priority',  title: 'Priorit√©', type: 'Choice' }
    ];

    // STATE MANAGEMENT
    let state = {
        allRecords: [],
        filteredRecords: [],
        filters: { team: 'all', project: 'all', assignee: 'all' }, // AJOUT Assignee
        currentView: 'dashboard',
        ganttScale: 'day', // AJOUT State
        uniqueTeams: [],
        uniqueProjects: [],
        uniqueAssignees: []
    };

    // DRAG & DROP STATE
    let dragState = {
        isDragging: false, element: null, recordId: null,
        startX: 0, initialLeft: 0, timelineWidth: 0, msPerPixel: 0,
        originalStart: null, originalEnd: null,
        scalePx: 0 // Ajout helper
    };

    // --- 2. UTILITAIRES ---
    const Utils = {
        fromGristDate: (val) => {
            if (!val && val !== 0) return null;
            return val > 100000 ? new Date(val * 1000) : new Date(val * 24 * 60 * 60 * 1000);
        },
        toGristDate: (dateObj) => {
            if (!dateObj) return null;
            const utc = Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
            return Math.floor(utc / 86400000);
        },
        formatDate: (d) => d ? d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) : '-',
        inputDate: (d) => d ? d.toISOString().split('T')[0] : '', 
        stringToColor: (str) => {
            if (!str) return '#94a3b8';
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 70%, 45%)`;
        },
        cleanData: (data) => {
            if (Array.isArray(data)) return data;
            if (!data) return [];
            const cols = Object.keys(data);
            if (!cols.length) return [];
            const rows = [];
            for(let i=0; i<data[cols[0]].length; i++) {
                let rec = { id: data.id[i] };
                cols.forEach(c => { if(c!=='id') rec[c] = data[c][i]; });
                rows.push(rec);
            }
            return rows;
        }
    };

    // --- 3. INIT & EVENTS GRIST ---
    grist.ready({ columns: MAPPING, requiredAccess: 'full' });

    grist.onRecords(data => {
        state.allRecords = Utils.cleanData(data);
        extractUniqueValues();
        updateFilterSelects();
        handleFilters(); 
    });

    function extractUniqueValues() {
        state.uniqueTeams = [...new Set(state.allRecords.map(r => r.Team).filter(Boolean))].sort();
        state.uniqueProjects = [...new Set(state.allRecords.map(r => r.Project).filter(Boolean))].sort();
        state.uniqueAssignees = [...new Set(state.allRecords.map(r => r.Assignee).filter(Boolean))].sort();
    }

    // --- 4. LOGIQUE FILTRES & ACTIONS ---
    function updateFilterSelects() {
        const fill = (id, list, def) => {
            const el = document.getElementById(id);
            const val = el.value;
            el.innerHTML = `<option value="all">${def}</option>` + list.map(v => `<option value="${v}">${v}</option>`).join('');
            if(list.includes(val)) el.value = val;
        };
        fill('filter-team', state.uniqueTeams, 'Toutes les administrations');
        fill('filter-project', state.uniqueProjects, 'Tous les projets');
        fill('filter-assignee', state.uniqueAssignees, 'Tous les responsables');
    }

    function handleFilters() {
        state.filters.team = document.getElementById('filter-team').value;
        state.filters.project = document.getElementById('filter-project').value;
        state.filters.assignee = document.getElementById('filter-assignee').value;

        state.filteredRecords = state.allRecords.filter(r => {
            return (state.filters.team === 'all' || r.Team === state.filters.team) &&
                   (state.filters.project === 'all' || r.Project === state.filters.project) &&
                   (state.filters.assignee === 'all' || r.Assignee === state.filters.assignee);
        });

        renderCurrentView();
    }

    function switchView(view) {
        state.currentView = view;
        document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.nav-item[onclick="switchView('${view}')"]`).classList.add('active');
        
        // MODIF: Gestion Toolbar Visibility
        const tb = document.getElementById('main-toolbar');
        const gs = document.getElementById('gantt-scale');
        
        if (view === 'dashboard') {
            tb.style.display = 'none';
        } else {
            tb.style.display = 'grid';
            gs.style.display = (view === 'gantt') ? 'block' : 'none';
        }

        renderCurrentView();
    }
    
    // AJOUT: Changement √©chelle
    function changeGanttScale(v) {
        state.ganttScale = v;
        renderCurrentView();
    }

    function renderCurrentView() {
        const container = document.getElementById('app-content');
        container.innerHTML = '';
        const wrapper = document.createElement('div');
        wrapper.className = 'view-container active';

        if(state.currentView === 'dashboard') renderDashboard(wrapper);
        else if(state.currentView === 'gantt') renderGantt(wrapper);
        else renderList(wrapper);

        container.appendChild(wrapper);
    }

    // --- 5. MOTEURS DE RENDU ---

    /** VUE 1 : DASHBOARD **/
    function renderDashboard(container) {
        // MODIF: Dashboard ignore les filtres de la toolbar (voir demande)
        const data = state.allRecords; 
        const total = data.length;
        const now = new Date();
        const done = data.filter(r => (r.Progress||0) == 100).length;
        const late = data.filter(r => {
            const end = Utils.fromGristDate(r.EndDate);
            return end && end < now && (r.Progress||0) < 100;
        }).length;
        const inProgress = data.filter(r => (r.Progress||0) > 0 && (r.Progress||0) < 100).length;
        const donePct = total ? Math.round((done/total)*100) : 0;

        // MODIF Couleurs: Total en Noir (#000), En cours en Bleu (--info)
        container.innerHTML = `
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div><div class="stat-title">Total T√¢ches</div><div class="stat-value" style="color:#000">${total}</div></div>
                    <div class="stat-footer">Toutes t√¢ches confondues</div>
                </div>
                <div class="stat-card">
                    <div><div class="stat-title">Termin√©es</div><div class="stat-value text-success">${done}</div></div>
                    <div class="stat-footer">${donePct}% du total</div>
                </div>
                <div class="stat-card">
                    <div><div class="stat-title">En Retard</div><div class="stat-value text-danger">${late}</div></div>
                    <div class="stat-footer">√Ä traiter en urgence</div>
                </div>
                <div class="stat-card">
                    <div><div class="stat-title">En Cours</div><div class="stat-value" style="color:var(--info)">${inProgress}</div></div>
                    <div class="stat-footer">Actives</div>
                </div>
            </div>
            <div class="charts-row">
                <div class="chart-box">
                    <h4 style="margin-top:0">Par Priorit√©</h4>
                    ${renderBarChart(data, 'Priority', {High: 'var(--danger)', Normal: 'var(--warning)', Low: 'var(--success)'})}
                </div>
                <div class="chart-box">
                    <h4 style="margin-top:0">Par Administration</h4>
                    ${renderBarChart(data, 'Team', null)}
                </div>
            </div>
        `;
    }

    function renderBarChart(data, key, colorMap) {
        const counts = {};
        data.forEach(r => { const k = r[key] || 'Non d√©fini'; counts[k] = (counts[k] || 0) + 1; });
        const max = Math.max(...Object.values(counts), 1);
        return Object.keys(counts).map(k => {
            const count = counts[k];
            const pct = (count / max) * 100;
            const color = colorMap ? (colorMap[k] || '#ccc') : Utils.stringToColor(k);
            return `
                <div class="bar-group">
                    <div class="bar-label"><span>${k}</span> <span>${count}</span></div>
                    <div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${color}"></div></div>
                </div>`;
        }).join('');
    }

    /** VUE 2 : GANTT (GROUP√â + SCALE + RED LINE) **/
    function renderGantt(container) {
        const tasks = state.filteredRecords
            .filter(r => r.StartDate && r.EndDate)
            .map(r => ({...r, start: Utils.fromGristDate(r.StartDate), end: Utils.fromGristDate(r.EndDate)}))
            .sort((a,b) => a.start - b.start);

        if (!tasks.length) { container.innerHTML = '<div style="text-align:center; padding:40px; color:#999">Aucune t√¢che avec dates.</div>'; return; }

        let min = new Date(Math.min(...tasks.map(t => t.start))).getTime();
        let max = new Date(Math.max(...tasks.map(t => t.end))).getTime();
        const padding = 86400000 * 2; 
        min -= padding; max += padding;
        const totalMs = max - min;
        const totalDays = totalMs / 86400000;

        // AJOUT: Gestion Scale
        let pxPerDay = 40; // Defaut Day
        if (state.ganttScale === 'week') pxPerDay = 15;
        if (state.ganttScale === 'month') pxPerDay = 5;

        const totalWidth = totalDays * pxPerDay;

        // Header HTML Generation
        let headerHtml = '';
        let loopDate = new Date(min);
        for(let i=0; i<totalDays; i++) {
            const d = loopDate.getDate();
            const w = loopDate.getDay();
            const m = loopDate.toLocaleDateString('fr-FR', {month:'short'});
            let txt = '';
            let style = `position:absolute; left:${i*pxPerDay}px; width:${pxPerDay}px; height:100%; border-right:1px solid #f1f5f9; text-align:center; font-size:10px; padding-top:4px;`;

            if(state.ganttScale === 'day') {
                txt = `<b>${d}</b><br><span style="color:#aaa">${['D','L','M','M','J','V','S'][w]}</span>`;
                if(w===0 || w===6) style += 'background:#fafafa';
            } else if (state.ganttScale === 'week') {
                if(w===1) { // Lundi
                     style += 'border-left:1px solid #ccc;';
                     txt = `S${getWeekNum(loopDate)}<br>${m}`;
                }
            } else if (state.ganttScale === 'month') {
                if(d===1) {
                     style += 'border-left:1px solid #ccc; font-weight:bold;';
                     txt = m;
                }
            }
            if(txt) headerHtml += `<div style="${style}">${txt}</div>`;
            loopDate.setDate(loopDate.getDate() + 1);
        }

        // AJOUT: Ligne Rouge
        const now = new Date();
        const diffNow = (now.getTime() - min) / 86400000;
        let redLine = '';
        if(diffNow >= 0 && diffNow <= totalDays) {
            redLine = `<div class="today-line" style="left:${diffNow*pxPerDay}px"><div class="today-label">Auj.</div></div>`;
        }

        // AJOUT: Grouping Loop
        const projects = [...new Set(tasks.map(t => t.Project || 'Sans Projet'))].sort();
        let bodyHtml = redLine;

        projects.forEach(proj => {
            bodyHtml += `<div class="gantt-group-title">${proj}</div>`;
            
            const groupTasks = tasks.filter(t => (t.Project || 'Sans Projet') === proj);
            groupTasks.forEach(t => {
                const diffStart = (t.start.getTime() - min) / 86400000;
                const dur = (t.end.getTime() - t.start.getTime()) / 86400000 + 1;
                const color = Utils.stringToColor(t.Project);
                
                bodyHtml += `
                    <div class="gantt-line">
                        <div class="gantt-text" title="${t.Title}" onclick="openModal(${t.id})">${t.Title}</div>
                        <div class="gantt-timeline" id="timeline-${t.id}">
                            <div class="gantt-block" 
                                 id="block-${t.id}"
                                 style="left:${diffStart*pxPerDay}px; width:${Math.max(dur*pxPerDay, 5)}px; background:${color}" 
                                 title="${t.Title}"
                                 onmousedown="handleDragStart(event, ${t.id}, ${min}, ${pxPerDay})">
                                 ${t.Title}
                            </div>
                        </div>
                    </div>
                `;
            });
        });

        container.innerHTML = `
            <div class="gantt-wrapper">
                <div class="gantt-header">
                    <div class="gantt-sidebar-head">Projet / T√¢che</div>
                    <div class="gantt-timeline-head" style="width:${totalWidth}px">
                        ${headerHtml}
                    </div>
                </div>
                <div class="gantt-body" style="width:${totalWidth+200}px">
                    ${bodyHtml}
                </div>
            </div>`;
        
        // Init Listeners Global (une fois)
        if(!window.dragActive) {
            window.addEventListener('mousemove', handleDragMove);
            window.addEventListener('mouseup', handleDragEnd);
            window.dragActive = true;
        }
    }

    function getWeekNum(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    // --- DRAG & DROP LOGIC ---
    function handleDragStart(e, id, minTime, pxPerDay) {
        e.preventDefault(); e.stopPropagation();
        const block = document.getElementById(`block-${id}`);
        dragState = {
            isDragging: true, element: block, recordId: id,
            startX: e.clientX, initialLeft: parseFloat(block.style.left),
            pxPerDay: pxPerDay, minTime: minTime, hasMoved: false
        };
    }

    function handleDragMove(e) {
        if (!dragState.isDragging) return;
        dragState.hasMoved = true;
        const deltaPixels = e.clientX - dragState.startX;
        dragState.element.style.left = (dragState.initialLeft + deltaPixels) + 'px';
    }

    async function handleDragEnd(e) {
        if (!dragState.isDragging) return;

        if (dragState.hasMoved) {
            const deltaPixels = e.clientX - dragState.startX;
            const days = Math.round(deltaPixels / dragState.pxPerDay);

            if (days !== 0) {
                const r = state.allRecords.find(x => x.id === dragState.recordId);
                const newStart = Utils.fromGristDate(r.StartDate); newStart.setDate(newStart.getDate() + days);
                const newEnd = Utils.fromGristDate(r.EndDate); newEnd.setDate(newEnd.getDate() + days);
                
                try {
                    await grist.selectedTable.update({
                        id: dragState.recordId,
                        fields: { StartDate: Utils.toGristDate(newStart), EndDate: Utils.toGristDate(newEnd) }
                    });
                } catch (err) { console.error(err); renderCurrentView(); }
            } else { renderCurrentView(); }
        } else {
            openModal(dragState.recordId);
        }
        dragState.isDragging = false;
        dragState.element = null;
    }

    /** VUE 3 : LISTE **/
    function renderList(container) {
        const listDiv = document.createElement('div');
        listDiv.className = 'task-list';
        if(!state.filteredRecords.length) { container.innerHTML = '<div style="text-align:center; padding:40px; color:#999">Aucune t√¢che trouv√©e.</div>'; return; }

        state.filteredRecords.forEach(r => {
            const card = document.createElement('div');
            // Mapping de priorit√© pour la couleur de bordure (Normal par defaut)
            let prioClass = 'priority-normal';
            if(r.Priority === 'High') prioClass = 'priority-high';
            if(r.Priority === 'Low') prioClass = 'priority-low';
            
            card.className = `task-card ${prioClass}`;
            card.onclick = () => openModal(r.id);

            const badges = [];
            if(r.Team) badges.push({t: r.Team, c: Utils.stringToColor(r.Team)});
            if(r.Project) badges.push({t: r.Project, c: Utils.stringToColor(r.Project)});

            card.innerHTML = `
                <div class="card-top">
                    <h3 class="card-h3">${r.Title || 'Sans Titre'}</h3>
                    ${r.Priority ? `<span style="font-size:10px; font-weight:700; color:#666">${r.Priority}</span>` : ''}
                </div>
                <div class="card-tags">
                    ${badges.map(b => `<span class="tag" style="background:${b.c}">${b.t}</span>`).join('')}
                </div>
                <div class="card-btm">
                    <div class="avatar-row"><span>üë§ ${r.Assignee || 'Non assign√©'}</span></div>
                    <div style="display:flex; gap:10px; align-items:center">
                        <span>üìÖ ${Utils.formatDate(Utils.fromGristDate(r.EndDate))}</span>
                        ${r.Progress !== undefined ? `<strong>${r.Progress}%</strong>` : ''}
                    </div>
                </div>
            `;
            listDiv.appendChild(card);
        });
        container.appendChild(listDiv);
    }

    // --- 6. GESTION MODALE (CRUD COMPLET) ---
    function populateDatalists() {
        const fill = (id, list) => { document.getElementById(id).innerHTML = list.map(v => `<option value="${v}">`).join(''); };
        fill('list-teams', state.uniqueTeams);
        fill('list-projects', state.uniqueProjects);
        fill('list-assignees', state.uniqueAssignees);
    }
    
    // AJOUT: Helper pour bouton +
    function addItem(id) {
        const val = prompt("Ajouter une valeur :");
        if(val) document.getElementById(id).value = val;
    }

    function openModal(recordId = null) {
        populateDatalists();
        const modal = document.getElementById('modal');
        const title = document.getElementById('modal-title');
        
        document.getElementById('input-id').value = '';
        document.getElementById('input-title').value = '';
        document.getElementById('input-team').value = '';
        document.getElementById('input-project').value = '';
        document.getElementById('input-assignee').value = '';
        document.getElementById('input-priority').value = 'Normal';
        document.getElementById('input-start').value = Utils.inputDate(new Date());
        document.getElementById('input-end').value = Utils.inputDate(new Date());
        document.getElementById('input-progress').value = 0;
        document.getElementById('range-progress').value = 0;

        if (recordId) {
            const r = state.allRecords.find(x => x.id === recordId);
            if (r) {
                title.innerText = "Modifier la T√¢che";
                document.getElementById('input-id').value = r.id;
                document.getElementById('input-title').value = r.Title || '';
                document.getElementById('input-team').value = r.Team || '';
                document.getElementById('input-project').value = r.Project || '';
                document.getElementById('input-assignee').value = r.Assignee || '';
                document.getElementById('input-priority').value = r.Priority || 'Normal';
                document.getElementById('input-start').value = Utils.inputDate(Utils.fromGristDate(r.StartDate));
                document.getElementById('input-end').value = Utils.inputDate(Utils.fromGristDate(r.EndDate));
                document.getElementById('input-progress').value = r.Progress || 0;
                document.getElementById('range-progress').value = r.Progress || 0;
                grist.setSelectedRows([r.id]);
            }
        } else {
            title.innerText = "Nouvelle T√¢che";
            // Pre-fill avec les filtres
            if (state.filters.team !== 'all') document.getElementById('input-team').value = state.filters.team;
            if (state.filters.project !== 'all') document.getElementById('input-project').value = state.filters.project;
        }
        modal.classList.add('open');
    }

    function closeModal() { document.getElementById('modal').classList.remove('open'); }

    async function saveTask() {
        const id = document.getElementById('input-id').value;
        const fields = {
            Title: document.getElementById('input-title').value || 'Nouvelle T√¢che',
            Team: document.getElementById('input-team').value,
            Project: document.getElementById('input-project').value,
            Assignee: document.getElementById('input-assignee').value,
            Priority: document.getElementById('input-priority').value,
            StartDate: Utils.toGristDate(new Date(document.getElementById('input-start').value)),
            EndDate: Utils.toGristDate(new Date(document.getElementById('input-end').value)),
            Progress: parseInt(document.getElementById('input-progress').value) || 0
        };

        try {
            if (id) await grist.selectedTable.update({ id: parseInt(id), fields });
            else await grist.selectedTable.create({ fields });
            closeModal();
        } catch (e) { console.error(e); alert("Erreur lors de la sauvegarde."); }
    }

    document.getElementById('input-progress').addEventListener('input', function() {
        document.getElementById('range-progress').value = this.value;
    });
</script>
</body>
</html>
