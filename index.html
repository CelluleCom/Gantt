<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt'FIP - Ultimate V24</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. DESIGN SYSTEM & VARIABLES
           ========================================= */
        :root {
            /* Palette Principale */
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #E0E7FF;
            
            /* Backgrounds */
            --bg-body: #F1F5F9;
            --bg-surface: #FFFFFF;
            --bg-panel: #F8FAFC;
            
            /* Text Colors */
            --text-main: #0F172A;
            --text-secondary: #475569;
            --text-muted: #94A3B8;
            
            /* Borders */
            --border: #E2E8F0;
            --border-focus: #6366F1;

            /* Functional Colors */
            --success: #10B981;
            --success-light: #ECFDF5;
            --warning: #F59E0B;
            --warning-light: #FFFBEB;
            --danger: #EF4444;
            --danger-light: #FEF2F2;
            --info: #3B82F6;
            
            /* Gantt Priorities */
            --prio-critique: #EF4444;
            --prio-haute: #F97316;
            --prio-moyenne: #3B82F6;
            --prio-basse: #94A3B8;

            /* Shadows & Radius */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            padding: 24px; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* =========================================
           2. HEADER & NAVIGATION
           ========================================= */
        .top-header {
            background: var(--bg-surface);
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-shrink: 0;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand-logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -0.5px;
        }
        .brand-logo span { color: var(--text-main); }
        
        .sync-indicator {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 6px 12px;
            background: var(--bg-body);
            border-radius: 20px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #CBD5E1; transition: background 0.3s; }
        .sync-dot.active { background: var(--warning); box-shadow: 0 0 8px var(--warning); }
        .sync-dot.success { background: var(--success); }
        .sync-dot.error { background: var(--danger); }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-shrink: 0;
        }

        .nav-tabs {
            background: #E2E8F0;
            padding: 4px;
            border-radius: var(--radius-md);
            display: flex;
            gap: 2px;
        }
        .nav-item {
            padding: 8px 20px;
            border: none;
            background: transparent;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .nav-item:hover { color: var(--text-main); }
        .nav-item.active {
            background: var(--bg-surface);
            color: var(--primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .filters-area {
            display: flex;
            gap: 12px;
        }
        .custom-select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-surface);
            color: var(--text-main);
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 160px;
            transition: border-color 0.2s;
        }
        .custom-select:hover { border-color: #CBD5E1; }
        .custom-select:focus { border-color: var(--primary); }

        /* =========================================
           3. MAIN WORKSPACE
           ========================================= */
        .workspace {
            flex: 1;
            background: var(--bg-surface);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .view-container {
            position: absolute;
            inset: 0;
            padding: 32px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
            background: var(--bg-surface);
        }
        .view-container.active {
            opacity: 1;
            visibility: visible;
            z-index: 10;
        }

        /* --- DASHBOARD STYLES --- */
        .kpi-wrapper {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 40px;
        }
        .kpi-box {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }
        .kpi-box:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .kpi-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .kpi-sub { font-size: 0.85rem; font-weight: 500; margin-top: 8px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; }

        .charts-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 40px;
        }
        .chart-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
        }
        .chart-header {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        /* Bar Charts CSS */
        .bar-item { display: flex; align-items: center; margin-bottom: 12px; font-size: 0.9rem; }
        .bar-label { width: 140px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); }
        .bar-track { flex: 1; height: 10px; background: #E2E8F0; border-radius: 5px; margin: 0 16px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 5px; transition: width 0.5s ease-out; }
        .bar-value { width: 40px; text-align: right; font-weight: 700; color: var(--text-main); }

        .section-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .section-title::before { content: ''; width: 6px; height: 24px; background: var(--primary); border-radius: 4px; }

        /* --- TABLE STYLES --- */
        .table-responsive {
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        thead { background: #F8FAFC; border-bottom: 1px solid var(--border); }
        th { padding: 16px 20px; text-align: left; font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; }
        td { padding: 16px 20px; border-bottom: 1px solid var(--border); vertical-align: top; color: var(--text-secondary); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #F1F5F9; cursor: pointer; }

        .cell-main { font-weight: 600; color: var(--text-main); font-size: 0.95rem; margin-bottom: 4px; }
        .badge {
            display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 6px;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .badge.proj { background: var(--primary-light); color: var(--primary); }
        .badge.team { background: #1E293B; color: #fff; margin-top: 4px; }
        
        .prog-track { width: 100%; height: 6px; background: #E2E8F0; border-radius: 3px; margin-top: 6px; overflow: hidden; }
        .prog-fill { height: 100%; border-radius: 3px; }

        /* --- GANTT STYLES --- */
        .gantt-controls { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 16px; }
        .btn-zoom { background: white; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; color: var(--text-muted); font-size: 0.8rem; }
        .btn-zoom.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Overrides pour Frappe Gantt */
        .gantt-container { border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; background: white; }
        .gantt .grid-header { background-color: #fff; height: 50px; }
        .gantt .grid-row { fill: #fff; }
        .gantt .grid-row:nth-child(even) { fill: #F8FAFC; }
        .gantt .row-line { stroke: #E2E8F0; }
        .gantt .bar { rx: 4px; ry: 4px; stroke: none; }
        .gantt .bar-label { fill: #1E293B; font-weight: 600; font-size: 12px; }
        /* Couleurs auto */
        .fill-critique { fill: var(--prio-critique) !important; }
        .fill-haute { fill: var(--prio-haute) !important; }
        .fill-moyenne { fill: var(--prio-moyenne) !important; }
        .fill-basse { fill: var(--prio-basse) !important; }
        .fill-termine { fill: var(--success) !important; }

        /* =========================================
           4. MODALS & TOASTS
           ========================================= */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(2px); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-card {
            background: white; width: 600px; max-width: 95%;
            padding: 40px; border-radius: var(--radius-xl);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease;
        }
        .modal-card.mini { width: 400px; padding: 32px; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .modal-title { font-size: 1.5rem; font-weight: 800; margin: 0; color: var(--text-main); }
        .btn-close { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .btn-close:hover { color: var(--danger); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .input-wrapper { display: flex; gap: 8px; }
        .btn-add-mini {
            width: 42px; border: 1px solid var(--border); background: #F1F5F9;
            border-radius: var(--radius-md); color: var(--primary);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; cursor: pointer; transition: 0.2s;
        }
        .btn-add-mini:hover { background: var(--primary); color: white; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px; }
        .form-input {
            width: 100%; padding: 12px; border: 1px solid var(--border);
            border-radius: var(--radius-md); font-family: inherit; font-size: 0.95rem;
            transition: all 0.2s;
        }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; margin-top: 30px; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-secondary); padding: 10px 24px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; }
        .btn-secondary:hover { background: #F8FAFC; border-color: #CBD5E1; }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: white; padding: 16px 20px; border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg); border-left: 4px solid var(--primary);
            font-weight: 600; font-size: 0.9rem; min-width: 300px;
            animation: slideInRight 0.3s ease; display: flex; align-items: center; justify-content: space-between;
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }

        /* Loading Overlay */
        #loader {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            font-weight: 600; color: var(--primary); gap: 10px; backdrop-filter: blur(2px);
        }
        .spinner { width: 24px; height: 24px; border: 3px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div>Chargement des donn√©es...</div>
    <div id="toast-container"></div>

    <header class="top-header">
        <div class="brand">
            <div class="brand-logo">Gantt'<span>FIP</span></div>
        </div>
        <div style="display: flex; gap: 16px; align-items: center;">
            <div class="sync-indicator" id="syncStatus">
                <div class="sync-dot" id="syncDot"></div>
                <span id="syncText">Initialisation...</span>
            </div>
            <button class="btn-primary" onclick="ui.openModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                Nouvelle T√¢che
            </button>
        </div>
    </header>

    <div class="toolbar">
        <div class="nav-tabs">
            <button class="nav-item active" onclick="ui.switchView('dashboard', this)">Tableau de Bord</button>
            <button class="nav-item" onclick="ui.switchView('gantt', this)">Planning Gantt</button>
            <button class="nav-item" onclick="ui.switchView('list', this)">Liste Compl√®te</button>
        </div>
        <div class="filters-area">
            <select class="custom-select" id="fProj" onchange="ui.applyFilters()"><option value="">Tous les Projets</option></select>
            <select class="custom-select" id="fTeam" onchange="ui.applyFilters()"><option value="">Toutes les Admin.</option></select>
            <select class="custom-select" id="fAgent" onchange="ui.applyFilters()"><option value="">Tous les Agents</option></select>
        </div>
    </div>

    <div class="workspace">
        
        <div id="view-dashboard" class="view-container active">
            <div class="kpi-wrapper">
                <div class="kpi-box">
                    <div class="kpi-title">Total T√¢ches</div>
                    <div class="kpi-value" id="k-total">0</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-title">En Cours</div>
                    <div class="kpi-value" style="color:var(--info)" id="k-cours">0</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-title">Termin√©es</div>
                    <div class="kpi-value" style="color:var(--success)" id="k-done">0</div>
                    <div class="kpi-sub" style="color:var(--success)" id="k-rate">0%</div>
                </div>
                <div class="kpi-box" style="background:#FFF1F2; border-color:#FECDD3;">
                    <div class="kpi-title" style="color:var(--danger)">Retard</div>
                    <div class="kpi-value" style="color:var(--danger)" id="k-late">0</div>
                </div>
            </div>

            <div class="charts-wrapper">
                <div class="chart-card">
                    <div class="chart-header">R√©partition par Priorit√©</div>
                    <div id="stats-prio"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">Charge par Administration</div>
                    <div id="stats-team"></div>
                </div>
            </div>

            <div class="section-title">üìÖ Prochaines √âch√©ances</div>
            <div class="table-responsive">
                <table>
                    <thead><tr><th width="40%">T√¢che & Projet</th><th width="30%">Responsable</th><th width="20%">√âch√©ance</th><th width="10%">Statut</th></tr></thead>
                    <tbody id="tb-dash"></tbody>
                </table>
            </div>
        </div>

        <div id="view-gantt" class="view-container">
            <div class="gantt-controls">
                <button class="btn-zoom" onclick="ui.zoom('Day', this)">Jour</button>
                <button class="btn-zoom active" onclick="ui.zoom('Week', this)">Semaine</button>
                <button class="btn-zoom" onclick="ui.zoom('Month', this)">Mois</button>
            </div>
            <div id="gantt-chart" class="gantt-container"></div>
        </div>

        <div id="view-list" class="view-container">
            <div class="section-title">üóÇÔ∏è Inventaire D√©taill√©</div>
            <div class="table-responsive">
                <table>
                    <thead><tr><th width="35%">T√¢che & Projet</th><th width="25%">Responsable</th><th width="15%">Fin</th><th width="15%">Priorit√©</th><th width="10%">Progression</th></tr></thead>
                    <tbody id="tb-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalTask">
        <div class="modal-card">
            <div class="modal-header">
                <h2 class="modal-title" id="mTitle">√âdition T√¢che</h2>
                <button class="btn-close" onclick="ui.closeModals()">‚úï</button>
            </div>
            <form id="formTask">
                <input type="hidden" id="inpId">
                <div class="form-group">
                    <label class="form-label">Titre de la t√¢che</label>
                    <input type="text" id="inpTitle" class="form-input" required placeholder="Ex: Cadrage du projet...">
                </div>
                
                <div class="form-grid">
                    <div>
                        <label class="form-label">Projet</label>
                        <div class="input-wrapper">
                            <select id="inpProject" class="custom-select" style="width:100%" required></select>
                            <button type="button" class="btn-add-mini" onclick="ui.openQC('Project')">+</button>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Responsable</label>
                        <div class="input-wrapper">
                            <select id="inpAgent" class="custom-select" style="width:100%"></select>
                            <button type="button" class="btn-add-mini" onclick="ui.openQC('Agent')">+</button>
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div><label class="form-label">D√©but</label><input type="date" id="inpStart" class="form-input" required></div>
                    <div><label class="form-label">Fin</label><input type="date" id="inpEnd" class="form-input" required></div>
                </div>

                <div class="form-grid">
                    <div><label class="form-label">Avancement (%)</label><input type="number" id="inpProgress" class="form-input" min="0" max="100"></div>
                    <div>
                        <label class="form-label">Priorit√©</label>
                        <select id="inpPriority" class="custom-select" style="width:100%">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="ui.closeModals()">Annuler</button>
                    <button type="submit" class="btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modalQC">
        <div class="modal-card mini">
            <div class="modal-header">
                <h3 class="modal-title" id="qcTitle">Nouveau</h3>
                <button class="btn-close" onclick="ui.closeModals()">‚úï</button>
            </div>
            <input type="hidden" id="qcType">
            <div class="form-group">
                <label class="form-label">Nom</label>
                <input type="text" id="qcName" class="form-input" required>
            </div>
            <div class="form-group" id="qcExtra" style="display:none;">
                <label class="form-label">Administration (√âquipe)</label>
                <div class="input-wrapper">
                    <select id="qcTeamSel" class="custom-select" style="width:100%"></select>
                    <button type="button" class="btn-add-mini" onclick="ui.openQC('Team')">+</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="ui.closeModals()">Fermer</button>
                <button type="button" class="btn-primary" onclick="dataManager.saveQC()">Cr√©er</button>
            </div>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <script>
        // --- 1. CONFIGURATION & CONSTANTS ---
        const DB_CONFIG = {
            TASKS: 'TACHES_MASTER',
            AGENTS: 'AGENTS',
            PROJECTS: 'PROJETS',
            TEAMS: 'EQUIPES'
        };

        // --- 2. DATA MANAGER (Le Moteur Robuste) ---
        const dataManager = {
            data: { tasks: [], agents: [], projects: [], teams: [] },

            async init() {
                ui.loader(true);
                ui.syncStatus("Synchronisation...", "active");
                try {
                    // Chargement parall√®le
                    const [rawTasks, rawAgents, rawProjects, rawTeams] = await Promise.all([
                        this.fetchTable(DB_CONFIG.TASKS),
                        this.fetchTable(DB_CONFIG.AGENTS),
                        this.fetchTable(DB_CONFIG.PROJECTS),
                        this.fetchTable(DB_CONFIG.TEAMS)
                    ]);

                    // --- MAPPING (VOTRE LOGIQUE EXACTE AVEC SECURITE) ---
                    this.data.teams = rawTeams.map(r => ({ id: r.id, name: r.Nom_Equipe || r.Nom || "Sans √âquipe" }));
                    this.data.projects = rawProjects.map(r => ({ id: r.id, name: r.Nom_Projet || r.Nom || "Projet Inconnu" }));
                    
                    this.data.agents = rawAgents.map(r => {
                        const team = this.data.teams.find(t => t.id === r.Equipe);
                        return { 
                            id: r.id, 
                            name: r.Nom_Complet || r.Nom || "Agent Inconnu", 
                            teamName: team ? team.name : null 
                        };
                    });

                    this.data.tasks = rawTasks.map(t => {
                        // Gestion des r√©f√©rences vides
                        const agent = this.data.agents.find(a => a.id === t.Responsable) || { name: 'Non assign√©', teamName: null };
                        const project = this.data.projects.find(p => p.id === t.Projet) || { name: 'Hors Projet' };
                        
                        // S√©curit√© Dates
                        const now = new Date();
                        let dStart = t.Date_Debut ? new Date(t.Date_Debut * 1000) : now; // Grist envoie des secondes
                        let dEnd = t.Date_Fin ? new Date(t.Date_Fin * 1000) : now;
                        if(isNaN(dStart.getTime())) dStart = now;
                        if(isNaN(dEnd.getTime())) dEnd = now;

                        // Calculs d√©riv√©s
                        const isLate = dEnd < now && (t.Avancement || 0) < 100;
                        let color = 'fill-basse';
                        if (t.Avancement === 100) color = 'fill-termine';
                        else if (t.Priorite === 'Critique' || isLate) color = 'fill-critique';
                        else if (t.Priorite === 'Haute') color = 'fill-haute';
                        else if (t.Priorite === 'Moyenne') color = 'fill-moyenne';

                        return {
                            ...t, 
                            id: t.id.toString(),
                            // Variables UI Normalis√©es
                            displayAgent: agent.name, 
                            displayTeam: agent.teamName, 
                            displayProject: project.name,
                            name: t.Titre || "T√¢che sans titre", 
                            start: dStart.toISOString().split('T')[0], 
                            end: dEnd.toISOString().split('T')[0],
                            progress: t.Avancement || 0, 
                            dependencies: t.Dependances || "", 
                            custom_class: color
                        };
                    });

                    // Tri par date
                    this.data.tasks.sort((a,b) => new Date(a.start) - new Date(b.start));
                    
                    ui.renderAll();
                    ui.syncStatus("Connect√©", "success");
                } catch (e) {
                    console.error(e);
                    ui.toast("Erreur critique lors du chargement des donn√©es", "error");
                    ui.syncStatus("Erreur", "error");
                } finally {
                    ui.loader(false);
                }
            },

            async fetchTable(tableId) {
                try {
                    const raw = await grist.docApi.fetchTable(tableId);
                    return this.convert(raw);
                } catch(e) { return []; } // Fail-safe: retourne tableau vide
            },

            convert(tableData) {
                const keys = Object.keys(tableData);
                if (keys.length === 0) return [];
                const len = tableData.id.length;
                const result = [];
                for (let i = 0; i < len; i++) {
                    let obj = {};
                    keys.forEach(key => obj[key] = tableData[key][i]);
                    result.push(obj);
                }
                return result;
            },

            async saveRecord(table, id, fields) {
                ui.syncStatus("Sauvegarde...", "active");
                try {
                    const action = id ? 'UpdateRecord' : 'AddRecord';
                    const args = id ? [parseInt(id), fields] : [null, fields];
                    await grist.docApi.applyUserActions([[action, table, ...args]]);
                    ui.toast("Enregistrement r√©ussi", "success");
                    await this.init(); // Recharger pour mettre √† jour
                } catch(e) {
                    ui.toast("Erreur de sauvegarde: " + e.message, "error");
                    ui.syncStatus("Erreur Sauvegarde", "error");
                }
            },

            async saveQC() {
                const type = document.getElementById('qcType').value;
                const name = document.getElementById('qcName').value.trim();
                if(!name) return;

                let tab, fields;
                if(type === 'Project') { tab = DB_CONFIG.PROJECTS; fields = { Nom_Projet: name }; }
                else if(type === 'Team') { tab = DB_CONFIG.TEAMS; fields = { Nom_Equipe: name }; }
                else if(type === 'Agent') {
                    tab = DB_CONFIG.AGENTS;
                    const tid = document.getElementById('qcTeamSel').value;
                    fields = { Nom_Complet: name, Equipe: tid ? parseInt(tid) : null };
                }

                await this.saveRecord(tab, null, fields);
                ui.closeModals();
            }
        };

        // --- 3. UI MANAGER (L'Affichage V10) ---
        const ui = {
            gantt: null,

            renderAll() {
                this.fillSelects();
                this.applyFilters();
            },

            fillSelects() {
                this.fillBox('#fProj', dataManager.data.projects, true);
                this.fillBox('#inpProject', dataManager.data.projects);
                this.fillBox('#fTeam', dataManager.data.teams, true);
                this.fillBox('#fAgent', dataManager.data.agents);
                this.fillBox('#inpAgent', dataManager.data.agents);
            },

            fillBox(sel, list, useName=false) {
                document.querySelectorAll(sel).forEach(el => {
                    const v = el.value; const d = el.options[0]; el.innerHTML=""; el.appendChild(d);
                    list.forEach(i => {
                        const o = document.createElement('option');
                        o.value = useName ? i.name : i.id;
                        o.innerText = i.name;
                        el.appendChild(o);
                    });
                    if(list.some(i => (useName?i.name:i.id) == v)) el.value = v;
                });
            },

            applyFilters() {
                const fP = document.getElementById('fProj').value;
                const fT = document.getElementById('fTeam').value;
                const fA = document.getElementById('fAgent').value;

                const res = dataManager.data.tasks.filter(t => 
                    (fP === "" || t.displayProject == fP) && 
                    (fT === "" || (t.displayTeam && t.displayTeam == fT)) &&
                    (fA === "" || t.Responsable == fA)
                );

                this.renderDashboard(res);
                this.renderList(res);
                this.renderGantt(res);
            },

            renderDashboard(tasks) {
                const tot = tasks.length;
                const done = tasks.filter(t=>t.progress==100).length;
                const active = tasks.filter(t=>t.progress>0 && t.progress<100).length;
                const late = tasks.filter(t=>new Date(t.end)<new Date() && t.progress<100).length;
                const rate = tot ? Math.round((done/tot)*100) : 0;

                document.getElementById('k-total').innerText = tot;
                document.getElementById('k-cours').innerText = active;
                document.getElementById('k-done').innerText = done;
                document.getElementById('k-rate').innerText = rate + "%";
                document.getElementById('k-late').innerText = late;

                // Graphiques Barres
                this.drawBars('Priorite', 'stats-prio', tasks, {'Critique':'var(--prio-critique)','Haute':'var(--prio-haute)','Moyenne':'var(--prio-moyenne)','Basse':'var(--prio-basse)'});
                this.drawBars('displayTeam', 'stats-team', tasks, null);

                // Liste Upcoming
                const upcoming = tasks.filter(t => t.progress<100 && new Date(t.end)>=new Date()).slice(0,5);
                const tb = document.getElementById('tb-dash');
                tb.innerHTML = "";
                if(upcoming.length === 0) tb.innerHTML = "<tr><td colspan='4' style='text-align:center;padding:15px'>Aucune t√¢che urgente</td></tr>";
                upcoming.forEach(t => {
                    const bdg = t.displayTeam ? `<br><span class="badge badge-team">${t.displayTeam}</span>` : '';
                    tb.innerHTML += `<tr onclick="ui.openModal('${t.id}')"><td><div class="cell-main">${t.name}</div><span class="badge proj" style="background:${this.autoColor(t.displayProject)}33;color:${this.autoColor(t.displayProject)}">${t.displayProject}</span></td><td>${t.displayAgent}${bdg}</td><td>${t.end}</td><td><span style="color:var(--info);font-weight:700">${t.progress}%</span></td></tr>`;
                });
            },

            renderList(tasks) {
                const tb = document.getElementById('tb-list');
                tb.innerHTML = "";
                if(tasks.length === 0) tb.innerHTML = "<tr><td colspan='5' style='text-align:center;padding:20px'>Aucune donn√©e trouv√©e</td></tr>";
                tasks.forEach(t => {
                    const bdg = t.displayTeam ? `<br><span class="badge badge-team">${t.displayTeam}</span>` : '';
                    const prioColor = t.Priorite=='Critique'?'var(--danger)':(t.Priorite=='Haute'?'var(--warning)':'var(--text-secondary)');
                    tb.innerHTML += `<tr onclick="ui.openModal('${t.id}')"><td><div class="cell-main">${t.name}</div><span class="badge proj" style="background:${this.autoColor(t.displayProject)}33;color:${this.autoColor(t.displayProject)}">${t.displayProject}</span></td><td>${t.displayAgent}${bdg}</td><td>${t.end}</td><td style="color:${prioColor};font-weight:700">${t.Priorite}</td><td><div class="prog-track"><div class="prog-fill" style="width:${t.progress}%;background:var(--primary)"></div></div><div style="font-size:0.7rem;text-align:right">${t.progress}%</div></td></tr>`;
                });
            },

            renderGantt(tasks) {
                const el = document.getElementById('gantt-chart');
                el.innerHTML = "";
                if(tasks.length === 0) { el.innerHTML="<p style='text-align:center;padding:40px;color:#999'>Aucune t√¢che √† afficher dans le Gantt</p>"; return; }
                
                // Clone et Tri
                const gTasks = [...tasks].sort((a,b) => (a.displayProject > b.displayProject) ? 1 : -1);
                
                this.gantt = new Gantt("#gantt-chart", gTasks, {
                    header_height: 50, column_width: 30, step: 24, view_modes: ['Day', 'Week', 'Month'],
                    bar_height: 25, bar_corner_radius: 4, arrow_curve: 5, padding: 18, view_mode: 'Week',
                    date_format: 'YYYY-MM-DD', language: 'fr',
                    on_click: t => this.openModal(t.id),
                    on_date_change: (t,s,e) => dataManager.saveRecord(DB_CONFIG.TASKS, t.id, {Date_Debut:this.fmt(s), Date_Fin:this.fmt(e)}),
                    on_progress_change: (t,p) => dataManager.saveRecord(DB_CONFIG.TASKS, t.id, {Avancement:p})
                });
            },

            drawBars(key, divId, data, colorMap) {
                const counts = {};
                data.forEach(t => { const k = t[key]||"Non d√©fini"; counts[k] = (counts[k]||0)+1; });
                let html = "";
                for(const [k,v] of Object.entries(counts)) {
                    const pct = Math.round((v/data.length)*100);
                    const c = colorMap ? (colorMap[k]||'#ccc') : this.autoColor(k);
                    html += `<div class="bar-item"><div class="bar-label">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${c}"></div></div><div class="bar-value">${v}</div></div>`;
                }
                document.getElementById(divId).innerHTML = html || "<div style='color:#ccc'>Rien √† afficher</div>";
            },

            // --- INTERACTIONS ---
            switchView(v, btn) {
                document.querySelectorAll('.view-container').forEach(e=>e.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                document.getElementById('view-'+v).classList.add('active');
                btn.classList.add('active');
                if(v==='gantt' && this.gantt) setTimeout(()=>this.gantt.refresh(dataManager.data.tasks), 50);
            },

            openModal(id = null) {
                const f = document.getElementById('formTask');
                if(id) {
                    const t = dataManager.data.tasks.find(x=>x.id==id);
                    document.getElementById('mTitle').innerText = "Modifier T√¢che";
                    document.getElementById('inpId').value = t.id;
                    document.getElementById('inpTitle').value = t.name;
                    document.getElementById('inpProject').value = t.Projet;
                    document.getElementById('inpAgent').value = t.Responsable;
                    document.getElementById('inpStart').value = t.start;
                    document.getElementById('inpEnd').value = t.end;
                    document.getElementById('inpProgress').value = t.progress;
                    document.getElementById('inpPriority').value = t.Priorite;
                } else {
                    f.reset();
                    document.getElementById('mTitle').innerText = "Nouvelle T√¢che";
                    document.getElementById('inpId').value = "";
                    const now = new Date().toISOString().split('T')[0];
                    document.getElementById('inpStart').value = now;
                    document.getElementById('inpEnd').value = now;
                }
                document.getElementById('modalTask').style.display = 'flex';
            },

            openQC(type) {
                document.getElementById('qcType').value = type;
                document.getElementById('qcName').value = '';
                document.getElementById('qcExtra').style.display = 'none';
                
                let title = "Nouveau";
                if(type === 'Project') title = "Nouveau Projet";
                if(type === 'Team') title = "Nouvelle Administration";
                if(type === 'Agent') { 
                    title = "Nouvel Agent"; 
                    document.getElementById('qcExtra').style.display = 'block'; 
                    this.fillBox('#qcTeamSel', dataManager.data.teams);
                }
                
                document.getElementById('qcTitle').innerText = title;
                document.getElementById('modalQC').style.display = 'flex';
            },

            closeModals() {
                document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
            },

            zoom(m, btn) {
                document.querySelectorAll('.btn-zoom').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                if(this.gantt) this.gantt.change_view_mode(m);
            },

            // --- HELPERS VISUELS ---
            loader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; },
            
            toast(msg, type='info') {
                const t = document.createElement('div');
                t.className = `toast ${type}`;
                t.innerHTML = `<span>${msg}</span>`;
                document.getElementById('toast-container').appendChild(t);
                setTimeout(()=>t.remove(), 3000);
            },

            syncStatus(text, state) {
                const d = document.getElementById('syncDot');
                d.className = `sync-dot ${state}`;
                document.getElementById('syncText').innerText = text;
            },

            autoColor(str) {
                let h=0; for(let i=0;i<str.length;i++) h=str.charCodeAt(i)+((h<<5)-h);
                return `hsl(${h%360}, 70%, 40%)`;
            },
            
            fmt(v) { if(!v) return new Date().toISOString().split('T')[0]; const d = typeof v==='number'?new Date(v*1000):new Date(v); return d.toISOString().split('T')[0]; }
        };

        // --- 4. EVENTS ---
        grist.ready({ requiredAccess: 'full' });
        grist.onRecords(() => dataManager.init());

        document.getElementById('formTask').onsubmit = e => {
            e.preventDefault();
            const id = document.getElementById('inpId').value;
            const data = {
                Titre: document.getElementById('inpTitle').value,
                Projet: parseInt(document.getElementById('inpProject').value),
                Responsable: parseInt(document.getElementById('inpAgent').value),
                Date_Debut: document.getElementById('inpStart').value,
                Date_Fin: document.getElementById('inpEnd').value,
                Avancement: parseInt(document.getElementById('inpProgress').value),
                Priorite: document.getElementById('inpPriority').value
            };
            dataManager.saveRecord(DB_CONFIG.TASKS, id, data);
            ui.closeModals();
        };

        // Fermeture clic externe
        window.onclick = e => {
            if(e.target.classList.contains('modal-overlay')) ui.closeModals();
        };

    </script>
</body>
</html>
