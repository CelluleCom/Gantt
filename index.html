<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt'FIP - Pilotage V11</title>
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   
    <style>
        /* --- 1. DESIGN SYSTEM --- */
        :root {
            --primary: #4F46E5;
            --primary-dark: #3730a3;
            --bg-body: #F8FAFC;
            --bg-surface: #FFFFFF;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;

            /* Status Colors */
            --color-progress: #3b82f6;
            --color-done: #10b981;    
            --color-late: #ef4444;    
           
            /* Priorit√©s Colors */
            --prio-critique: #ef4444;
            --prio-haute: #f97316;
            --prio-moyenne: #3b82f6;
            --prio-basse: #94a3b8;

            --radius: 10px;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; padding: 20px; }

        /* HEADER */
        .topbar { background: var(--bg-surface); height: 64px; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); flex-shrink: 0; margin-bottom: 20px; }
        .logo { font-size: 1.25rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--text-main); }
        .sync-badge { font-size: 0.75rem; padding: 4px 10px; background: #f1f5f9; border-radius: 20px; color: var(--text-muted); font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--color-done); }
        .btn-create { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; transition: 0.2s; }
        .btn-create:hover { background: var(--primary-dark); }

        /* NAVIGATION */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .view-switcher { background: #e2e8f0; padding: 4px; border-radius: 8px; display: flex; }
        .view-btn { border: none; background: transparent; padding: 6px 16px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer; border-radius: 6px; }
        .view-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .filters { display: flex; gap: 10px; }
        select { padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; cursor: pointer; background: white; min-width: 150px; }

        /* WORKSPACE */
        .workspace { flex: 1; background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; position: relative; }
        .view-pane { position: absolute; inset: 0; padding: 24px; overflow-y: auto; display: none; }
        .view-pane.active { display: block; animation: fade 0.2s; }
        @keyframes fade { from{opacity:0}to{opacity:1} }

        /* --- DASHBOARD SECTION --- */
       
        /* 1. KPIs */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; }
        .kpi-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
        .kpi-num { font-size: 2rem; font-weight: 800; line-height: 1; }
        .kpi-sub { font-size: 0.85rem; font-weight: 600; margin-top: 4px; }
       
        .kpi-blue .kpi-num { color: var(--color-progress); }
        .kpi-green .kpi-num { color: var(--color-done); }
        .kpi-green .kpi-sub { color: var(--color-done); }
        .kpi-red .kpi-num { color: var(--color-late); }

        /* 2. STATS (Middle Section) */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: #FAFAFA; border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
        .stat-header { font-weight: 700; font-size: 0.95rem; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; }
       
        .stat-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; }
        .stat-label { width: 130px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-track { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; margin: 0 10px; overflow: hidden; }
        .stat-fill { height: 100%; border-radius: 4px; }
        .stat-val { width: 30px; text-align: right; font-weight: 700; }

        /* 3. UPCOMING TASKS (Bottom Section) */
        .section-header { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; color: var(--text-main); display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .section-header::before { content:''; width: 4px; height: 20px; background: var(--primary); border-radius: 2px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 12px 16px; background: #f8fafc; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); position: sticky; top: 0; }
        td { padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover td { background: #f1f5f9; cursor: pointer; }

        .badge-pill { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; border: 1px solid rgba(0,0,0,0.05); }
        .badge-team { display: inline-block; font-size: 0.7rem; font-weight: 700; background: #1e293b; color: white; padding: 2px 8px; border-radius: 12px; margin-top: 4px; text-transform: uppercase; }
       
        .agent-block { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .agent-name { font-weight: 600; font-size: 0.9rem; }
        .task-main { font-weight: 600; font-size: 0.95rem; display: block; margin-bottom: 4px; color: var(--text-main); }

        /* GANTT */
        .gantt-wrapper { overflow: auto; height: 100%; }
        .gantt .grid-header { background-color: #fff; height: 50px; }
        .gantt .grid-row { fill: #fff; }
        .gantt .grid-row:nth-child(even) { fill: #fcfcfc; }
        .gantt .row-line { stroke: #f1f5f9; }
        .gantt .bar { rx: 4px; ry: 4px; }
        .bar-critique .bar { fill: var(--prio-critique) !important; }
        .bar-haute .bar { fill: var(--prio-haute) !important; }
        .bar-moyenne .bar { fill: var(--prio-moyenne) !important; }
        .bar-basse .bar { fill: var(--prio-basse) !important; }
       
        .gantt-controls { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 10px; }
        .btn-zoom { background: white; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; color: var(--text-muted); }
        .btn-zoom.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* MODALS */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 95%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal.mini { width: 350px; border-top: 4px solid var(--primary); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
        .flex-input { display: flex; gap: 8px; }
        .btn-mini-add { width: 38px; border: 1px solid var(--border); background: #f8fafc; color: var(--primary); border-radius: 6px; cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-sec { background: transparent; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-prim { background: var(--primary); color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

    <header class="topbar">
        <div class="logo">Gantt'<span>FIP</span></div>
        <div class="sync-badge"><div class="dot" id="syncDot"></div> <span id="syncText">...</span></div>
        <button class="btn-create" onclick="openModal()">+ T√¢che</button>
    </header>

    <div class="toolbar">
        <div class="view-switcher">
            <button class="view-btn active" onclick="switchView('dashboard', this)">Tableau de Bord</button>
            <button class="view-btn" onclick="switchView('gantt', this)">Planning Gantt</button>
            <button class="view-btn" onclick="switchView('list', this)">Liste</button>
        </div>
        <div class="filters">
            <select id="fProj" onchange="refresh()"><option value="">Projets</option></select>
            <select id="fAdmin" onchange="refresh()"><option value="">Administrations</option></select>
            <select id="fAgent" onchange="refresh()"><option value="">Agents</option></select>
        </div>
    </div>

    <div class="workspace">
       
        <div id="view-dashboard" class="view-pane active">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-title">Total T√¢ches</div>
                    <div class="kpi-num" id="kpi-total">0</div>
                </div>
                <div class="kpi-card kpi-blue">
                    <div class="kpi-title">En Cours</div>
                    <div class="kpi-num" id="kpi-cours">0</div>
                </div>
                <div class="kpi-card kpi-green">
                    <div class="kpi-title">Termin√©es</div>
                    <div class="kpi-num" id="kpi-done">0</div>
                    <div class="kpi-sub" id="kpi-rate">0%</div>
                </div>
                <div class="kpi-card kpi-red">
                    <div class="kpi-title">En Retard</div>
                    <div class="kpi-num" id="kpi-late">0</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-header">R√©partition par Priorit√©</div>
                    <div id="stats-prio"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-header">Charge par Administration</div>
                    <div id="stats-team"></div>
                </div>
            </div>

            <div class="section-header">üìÖ T√¢ches √† venir</div>
            <table>
                <thead>
                    <tr>
                        <th style="width:35%">T√¢che & Projet</th>
                        <th style="width:25%">Responsable</th>
                        <th style="width:20%">√âch√©ance</th>
                        <th style="width:20%">Progression</th>
                    </tr>
                </thead>
                <tbody id="dash-list"></tbody>
            </table>
        </div>

        <div id="view-gantt" class="view-pane">
            <div class="gantt-controls">
                <button class="btn-zoom" onclick="zoomGantt('Day', this)">Jour</button>
                <button class="btn-zoom active" onclick="zoomGantt('Week', this)">Semaine</button>
                <button class="btn-zoom" onclick="zoomGantt('Month', this)">Mois</button>
            </div>
            <div id="gantt-chart" class="gantt-wrapper"></div>
        </div>

        <div id="view-list" class="view-pane">
            <div class="section-header">üóÇÔ∏è Inventaire Complet</div>
            <table>
                <thead>
                    <tr>
                        <th style="width:30%">T√¢che & Projet</th>
                        <th style="width:25%">Responsable</th>
                        <th style="width:15%">Fin</th>
                        <th style="width:15%">Priorit√©</th>
                        <th style="width:15%">Avancement</th>
                    </tr>
                </thead>
                <tbody id="full-list"></tbody>
            </table>
        </div>
    </div>

    <div class="modal-bg" id="modal-task">
        <div class="modal">
            <div class="modal-header"><h2>√âdition T√¢che</h2><button onclick="closeAll()" style="border:none;background:none;font-size:1.5rem;cursor:pointer">&times;</button></div>
            <form id="form-task">
                <input type="hidden" id="inp-id">
                <div style="margin-bottom:15px"><label>Titre</label><input type="text" id="inp-title" required></div>
                <div class="form-row">
                    <div><label>Projet</label><div class="flex-input"><select id="inp-proj" required></select><button type="button" class="btn-mini-add" onclick="openQC('proj')">+</button></div></div>
                    <div><label>Responsable</label><div class="flex-input"><select id="inp-agent"></select><button type="button" class="btn-mini-add" onclick="openQC('agent')">+</button></div></div>
                </div>
                <div class="form-row">
                    <div><label>D√©but</label><input type="date" id="inp-start" required></div>
                    <div><label>Fin</label><input type="date" id="inp-end" required></div>
                </div>
                <div class="form-row">
                    <div><label>Avancement %</label><input type="number" id="inp-prog" min="0" max="100"></div>
                    <div><label>Priorit√©</label>
                        <select id="inp-prio">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions"><button type="button" class="btn-sec" onclick="closeAll()">Annuler</button><button type="submit" class="btn-prim">Enregistrer</button></div>
            </form>
        </div>
    </div>

    <div class="modal-bg" id="modal-qc-proj">
        <div class="modal mini">
            <h3>Nouveau Projet</h3>
            <input type="text" id="qc-proj-name" placeholder="Nom du projet" style="margin:15px 0">
            <div class="modal-actions"><button type="button" class="btn-sec" onclick="closeAll()">Fermer</button><button onclick="saveQC('proj')" class="btn-prim">Cr√©er</button></div>
        </div>
    </div>
    <div class="modal-bg" id="modal-qc-agent">
        <div class="modal mini">
            <h3>Nouvel Agent</h3>
            <input type="text" id="qc-agent-name" placeholder="Nom Complet" style="margin-bottom:10px">
            <label>Administration</label>
            <div class="flex-input"><select id="qc-agent-team"></select><button class="btn-mini-add" onclick="openQC('team')">+</button></div>
            <div class="modal-actions"><button type="button" class="btn-sec" onclick="closeAll()">Fermer</button><button onclick="saveQC('agent')" class="btn-prim">Cr√©er</button></div>
        </div>
    </div>
    <div class="modal-bg" id="modal-qc-team">
        <div class="modal mini">
            <h3>Nouvelle Administration</h3>
            <input type="text" id="qc-team-name" placeholder="Ex: DGFIP, RH..." style="margin:15px 0">
            <div class="modal-actions"><button type="button" class="btn-sec" onclick="closeAll()">Fermer</button><button onclick="saveQC('team')" class="btn-prim">Cr√©er</button></div>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <script>
        const DB = { TASKS: 'TACHES_MASTER', AGENTS: 'AGENTS', PROJECTS: 'PROJETS', TEAMS: 'EQUIPES' };
        let DATA = { tasks: [], agents: [], projects: [], teams: [] };
        let gantt = null;

        grist.ready({ requiredAccess: 'full' });
        grist.onRecords(async () => await load());

        // COULEURS AUTO
        function getAutoColor(str) {
            let hash=0; for(let i=0;i<str.length;i++) hash=str.charCodeAt(i)+((hash<<5)-hash);
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 90%)`;
        }
        function getDarkAutoColor(str) {
            let hash=0; for(let i=0;i<str.length;i++) hash=str.charCodeAt(i)+((hash<<5)-hash);
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 30%)`;
        }

        async function load() {
            updateStatus("Chargement...");
            try {
                const [rT, rA, rP, rE] = await Promise.all([
                    grist.docApi.fetchTable(DB.TASKS),
                    grist.docApi.fetchTable(DB.AGENTS),
                    grist.docApi.fetchTable(DB.PROJECTS),
                    grist.docApi.fetchTable(DB.TEAMS)
                ]);

                DATA.teams = mapRaw(rE).map(x => ({ id: x.id, name: x.Nom || x.Nom_Equipe || "Autre" }));
                DATA.projects = mapRaw(rP).map(x => ({ id: x.id, name: x.Nom_Projet || x.Nom }));
               
                DATA.agents = mapRaw(rA).map(a => {
                    const t = DATA.teams.find(tm => tm.id === a.Equipe);
                    return { id: a.id, name: a.Nom_Complet || a.Nom, team: t ? t.name : null };
                });

                DATA.tasks = mapRaw(rT).map(t => {
                    const ag = DATA.agents.find(x => x.id === t.Responsable) || { name: 'Non assign√©', team: null };
                    const pr = DATA.projects.find(x => x.id === t.Projet) || { name: 'Aucun' };
                   
                    let cls = 'bar-basse';
                    if(t.Priorite === 'Critique') cls = 'bar-critique';
                    if(t.Priorite === 'Haute') cls = 'bar-haute';
                    if(t.Priorite === 'Moyenne') cls = 'bar-moyenne';

                    return {
                        ...t, id: t.id.toString(),
                        agName: ag.name, agTeam: ag.team, projName: pr.name,
                        name: t.Titre, start: fmtDate(t.Date_Debut), end: fmtDate(t.Date_Fin),
                        progress: t.Avancement||0, dependencies: t.Dependances||"", custom_class: cls
                    };
                });

                DATA.tasks.sort((a,b) => new Date(a.start) - new Date(b.start));
                render();
                updateStatus("Pr√™t");

            } catch (e) { console.error(e); updateStatus("Erreur"); }
        }

        function render() {
            populateSelects();
            const fP = document.getElementById('fProj').value;
            const fT = document.getElementById('fAdmin').value;
            const fA = document.getElementById('fAgent').value;

            const filtered = DATA.tasks.filter(t =>
                (fP === "" || t.Projet == fP) &&
                (fT === "" || (t.agTeam && t.agTeam == fT)) &&
                (fA === "" || t.Responsable == fA)
            );

            drawDashboard(filtered);
            drawGantt(filtered);
            drawList(filtered);
        }

        function drawDashboard(tasks) {
            // 1. KPIs
            const total = tasks.length;
            const done = tasks.filter(t => t.progress === 100).length;
            const active = tasks.filter(t => t.progress > 0 && t.progress < 100).length;
            const late = tasks.filter(t => new Date(t.end) < new Date() && t.progress < 100).length;
            const rate = total ? Math.round((done/total)*100) : 0;

            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-cours').innerText = active;
            document.getElementById('kpi-done').innerText = done;
            document.getElementById('kpi-rate').innerText = rate + "% Compl√©t√©";
            document.getElementById('kpi-late').innerText = late;

            // 2. STATS PRIORIT√â
            const pMap = { 'Critique':0, 'Haute':0, 'Moyenne':0, 'Basse':0 };
            const pCols = { 'Critique':'#ef4444', 'Haute':'#f97316', 'Moyenne':'#3b82f6', 'Basse':'#94a3b8' };
            tasks.forEach(t => { if(pMap[t.Priorite]!==undefined) pMap[t.Priorite]++; });
           
            let htmlP = "";
            for(const [k,v] of Object.entries(pMap)) {
                if(v>0) {
                    const pct = Math.round((v/total)*100);
                    htmlP += `<div class="stat-row"><div class="stat-label">${k}</div><div class="stat-track"><div class="stat-fill" style="width:${pct}%;background:${pCols[k]}"></div></div><div class="stat-val">${v}</div></div>`;
                }
            }
            document.getElementById('stats-prio').innerHTML = htmlP || "<p style='color:#999'>Aucune donn√©e</p>";

            // 3. STATS ADMIN
            const tMap = {};
            tasks.forEach(t => { const tm=t.agTeam||"Sans Admin"; tMap[tm]=(tMap[tm]||0)+1; });
            let htmlT = "";
            for(const [k,v] of Object.entries(tMap)) {
                const pct = Math.round((v/total)*100);
                const col = getDarkAutoColor(k);
                htmlT += `<div class="stat-row"><div class="stat-label">${k}</div><div class="stat-track"><div class="stat-fill" style="width:${pct}%;background:${col}"></div></div><div class="stat-val">${v}</div></div>`;
            }
            document.getElementById('stats-team').innerHTML = htmlT || "<p style='color:#999'>Aucune donn√©e</p>";

            // 4. LISTE T√ÇCHES √Ä VENIR
            const today = new Date();
            const upcoming = tasks
                .filter(t => t.progress < 100 && new Date(t.end) >= today)
                .sort((a,b) => new Date(a.end) - new Date(b.end))
                .slice(0, 5);

            const tb = document.getElementById('dash-list');
            tb.innerHTML = "";
            upcoming.forEach(t => {
                const badgeStyle = t.agTeam ? `style="background:${getAutoColor(t.agTeam)}; color:${getDarkAutoColor(t.agTeam)}"` : '';
                const team = t.agTeam ? `<span class="badge-pill" ${badgeStyle}>${t.agTeam}</span>` : '';
                const projStyle = `style="background:${getAutoColor(t.projName)}; color:${getDarkAutoColor(t.projName)}"`;
               
                tb.innerHTML += `
                <tr onclick="openModal('${t.id}')">
                    <td><div class="task-main">${t.Titre}</div><span class="badge-pill" ${projStyle}>${t.projName}</span></td>
                    <td><div class="agent-block"><span class="agent-name">${t.agName}</span>${team}</div></td>
                    <td>${t.end}</td>
                    <td><span style="color:var(--primary);font-weight:700">${t.progress}%</span></td>
                </tr>`;
            });
            if(!upcoming.length) tb.innerHTML = "<tr><td colspan='4' style='text-align:center;padding:15px;color:#999'>Aucune t√¢che √† venir</td></tr>";
        }

        function drawGantt(tasks) {
            document.getElementById('gantt-chart').innerHTML = "";
            if(!tasks.length) return;
            tasks.sort((a,b) => (a.projName > b.projName) ? 1 : -1);

            gantt = new Gantt("#gantt-chart", tasks, {
                header_height: 50, column_width: 30, step: 24,
                view_modes: ['Day', 'Week', 'Month'],
                bar_height: 25, bar_corner_radius: 3, arrow_curve: 5, padding: 18,
                view_mode: 'Week', date_format: 'YYYY-MM-DD', language: 'fr',
                on_click: t => openModal(t.id),
                on_date_change: (t,s,e) => save('UpdateRecord', DB.TASKS, t.id, {Date_Debut:fmtDate(s), Date_Fin:fmtDate(e)}),
                on_progress_change: (t,p) => save('UpdateRecord', DB.TASKS, t.id, {Avancement:p})
            });
        }

        function drawList(tasks) {
            const tb = document.getElementById('full-list');
            tb.innerHTML = "";
            tasks.forEach(t => {
                const badgeStyle = t.agTeam ? `style="background:${getAutoColor(t.agTeam)}; color:${getDarkAutoColor(t.agTeam)}"` : '';
                const team = t.agTeam ? `<span class="badge-pill" ${badgeStyle}>${t.agTeam}</span>` : '';
                const projStyle = `style="background:${getAutoColor(t.projName)}; color:${getDarkAutoColor(t.projName)}"`;
               
                let pc = 'var(--text-muted)';
                if(t.Priorite == 'Critique') pc = 'var(--prio-critique)';
                if(t.Priorite == 'Haute') pc = 'var(--prio-haute)';

                tb.innerHTML += `
                <tr onclick="openModal('${t.id}')">
                    <td><div class="task-main">${t.Titre}</div><span class="badge-pill" ${projStyle}>${t.projName}</span></td>
                    <td><div class="agent-block"><span class="agent-name">${t.agName}</span>${team}</div></td>
                    <td>${t.end}</td>
                    <td style="color:${pc};font-weight:700;font-size:0.8rem">${t.Priorite||'Moyenne'}</td>
                    <td><div style="display:flex;align-items:center;gap:8px"><div style="flex:1;height:6px;background:#e2e8f0;border-radius:3px"><div style="width:${t.progress}%;height:100%;background:${t.progress==100?'#10b981':'var(--primary)'};border-radius:3px"></div></div><span style="font-size:0.75rem;font-weight:600">${t.progress}%</span></div></td>
                </tr>`;
            });
        }

        // --- ACTIONS ---
        async function saveQC(type) {
            const name = document.getElementById('qc-'+type+'-name').value;
            if(!name) return;
            let table = '', fields = {};
            if(type=='proj') { table=DB.PROJECTS; fields={Nom_Projet:name}; }
            else if(type=='team') { table=DB.TEAMS; fields={Nom:name}; }
            else if(type=='agent') {
                table=DB.AGENTS;
                const tId = document.getElementById('qc-agent-team').value;
                fields={Nom_Complet:name, Equipe: tId ? parseInt(tId) : null};
            }
            await save('AddRecord', table, null, fields);
            await load(); populateSelects(); closeAll();
        }

        document.getElementById('form-task').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('inp-id').value;
            const data = {
                Titre: document.getElementById('inp-title').value,
                Projet: parseInt(document.getElementById('inp-proj').value),
                Responsable: parseInt(document.getElementById('inp-agent').value),
                Date_Debut: document.getElementById('inp-start').value,
                Date_Fin: document.getElementById('inp-end').value,
                Avancement: parseInt(document.getElementById('inp-prog').value),
                Priorite: document.getElementById('inp-prio').value
            };
            await save(id?'UpdateRecord':'AddRecord', DB.TASKS, id, data);
            closeAll();
        };

        async function save(action, table, rowId, fields) {
            updateStatus("Sauvegarde...");
            const args = action === 'AddRecord' ? [null, fields] : [parseInt(rowId), fields];
            try { await grist.docApi.applyUserActions([[action, table, ...args]]); }
            catch(e) { alert("Erreur: "+e.message); }
        }

        // UI HELPERS
        function openModal(id=null) {
            if(id && typeof id === 'string') {
                const t = DATA.tasks.find(x => x.id == id);
                document.getElementById('inp-id').value = t.id;
                document.getElementById('inp-title').value = t.Titre;
                document.getElementById('inp-proj').value = t.Projet;
                document.getElementById('inp-agent').value = t.Responsable;
                document.getElementById('inp-start').value = t.start;
                document.getElementById('inp-end').value = t.end;
                document.getElementById('inp-prog').value = t.progress;
                document.getElementById('inp-prio').value = t.Priorite;
                document.getElementById('modal-task').style.display='flex';
            } else {
                document.getElementById('form-task').reset();
                document.getElementById('inp-id').value = "";
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('inp-start').value = today;
                document.getElementById('inp-end').value = today;
                document.getElementById('modal-task').style.display='flex';
            }
        }
        function openQC(type) {
            document.getElementById('qc-'+type+'-name').value = '';
            if(type=='agent') fillSelect('#qc-agent-team', DATA.teams);
            document.getElementById('modal-qc-'+type).style.display='flex';
        }
        function closeAll() { document.querySelectorAll('.modal-bg').forEach(m => m.style.display='none'); }
       
        function populateSelects() {
            fillSelect('#fProj', DATA.projects); fillSelect('#inp-proj', DATA.projects);
            fillSelect('#fAdmin', DATA.teams);
            fillSelect('#fAgent', DATA.agents); fillSelect('#inp-agent', DATA.agents);
        }
        function fillSelect(sel, list) {
            document.querySelectorAll(sel).forEach(el => {
                const val = el.value; const def = el.options[0]; el.innerHTML = ""; el.appendChild(def);
                list.forEach(i => { const o = document.createElement('option'); o.value=i.id; o.innerText=i.name; el.appendChild(o); });
                if(list.some(i=>i.id==val)) el.value = val;
            });
        }
        function switchView(v, btn) {
            document.querySelectorAll('.view-pane').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.view-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            btn.classList.add('active');
            if(v=='gantt' && gantt) setTimeout(()=>gantt.refresh(DATA.tasks), 50);
        }
        function zoomGantt(m, btn) {
            document.querySelectorAll('.btn-zoom').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            gantt.change_view_mode(m);
        }
        function mapRaw(t) { const k=Object.keys(t); if(!k.length)return[]; const r=[]; for(let i=0;i<t.id.length;i++){ let o={}; k.forEach(key=>o[key]=t[key][i]); r.push(o); } return r; }
        function fmtDate(v) { if(!v) return new Date().toISOString().split('T')[0]; const d = typeof v==='number'?new Date(v*1000):new Date(v); return d.toISOString().split('T')[0]; }
        function updateStatus(t) { document.getElementById('syncText').innerText=t; }
    </script>
</body>
</html>
