<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Architecte V5</title>
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   
    <style>
        :root {
            /* Palette Pro & √âtat Modernis√© */
            --primary: #000091;
            --primary-light: #4F46E5;
            --bg-body: #F3F4F6;
            --bg-surface: #FFFFFF;
            --text-main: #111827;
            --text-muted: #6B7280;
            --border: #E5E7EB;
           
            /* Status Colors */
            --todo: #64748B;
            --progress: #2563EB;
            --review: #F59E0B;
            --done: #10B981;
            --danger: #EF4444;

            /* UI variables */
            --radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --trans: all 0.2s ease;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- 1. TOP BAR (COMMAND CENTER) --- */
        .topbar {
            background: var(--bg-surface); border-bottom: 1px solid var(--border);
            padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0; z-index: 50;
        }
        .brand { font-weight: 800; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .brand span { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
       
        .view-switcher { display: flex; background: var(--bg-body); padding: 3px; border-radius: 6px; }
        .view-btn {
            border: none; background: transparent; padding: 6px 14px; font-size: 0.85rem; font-weight: 600;
            color: var(--text-muted); cursor: pointer; border-radius: 4px; transition: var(--trans);
        }
        .view-btn.active { background: white; color: var(--primary); box-shadow: var(--shadow-sm); }
        .view-btn:hover:not(.active) { color: var(--text-main); }

        .actions { display: flex; gap: 10px; align-items: center; }
        .search-box {
            position: relative;
        }
        .search-input {
            padding: 8px 12px 8px 32px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.9rem; width: 250px; transition: var(--trans);
        }
        .search-input:focus { border-color: var(--primary-light); width: 300px; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 0.8rem; color: var(--text-muted); }

        .btn-new {
            background: var(--primary); color: white; border: none; padding: 8px 16px;
            border-radius: 6px; font-weight: 600; font-size: 0.9rem; cursor: pointer;
            box-shadow: var(--shadow-sm); transition: var(--trans); display: flex; align-items: center; gap: 6px;
        }
        .btn-new:hover { background: var(--primary-light); transform: translateY(-1px); }

        /* --- 2. MAIN LAYOUT --- */
        .workspace { flex: 1; overflow: hidden; position: relative; }
        .view-layer { position: absolute; inset: 0; padding: 20px; overflow-y: auto; display: none; }
        .view-layer.active { display: block; animation: fadeUpdate 0.2s; }
        @keyframes fadeUpdate { from { opacity: 0.8; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

        /* --- VUE 1: LISTE (DATA GRID) --- */
        .data-grid { width: 100%; border-collapse: collapse; background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow-sm); }
        .data-grid thead { background: #F8FAFC; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
        .data-grid th { text-align: left; padding: 12px 16px; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; }
        .data-grid td { padding: 10px 16px; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }
        .data-grid tr:hover { background: #F8FAFC; }
       
        .cell-title { font-weight: 600; color: var(--text-main); }
        .cell-sub { font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; margin-top: 2px; }
        .badge-pill { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; background: #E0E7FF; color: var(--primary); }
        .badge-team { background: #374151; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }

        /* Inline Progress Bar */
        .mini-progress { width: 80px; height: 6px; background: #E2E8F0; border-radius: 3px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .mini-fill { height: 100%; border-radius: 3px; }

        /* --- VUE 2: KANBAN (BOARD) --- */
        .kanban-board { display: flex; gap: 20px; height: 100%; overflow-x: auto; align-items: flex-start; }
        .kanban-col {
            flex: 0 0 300px; max-width: 300px; background: #F1F5F9;
            border-radius: 12px; display: flex; flex-direction: column; max-height: 100%;
        }
        .col-header { padding: 16px; font-weight: 700; color: var(--text-muted); font-size: 0.85rem; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .col-count { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
        .col-body { padding: 10px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 10px; }
       
        .kanban-card {
            background: white; padding: 14px; border-radius: 8px; box-shadow: var(--shadow-sm);
            border: 1px solid transparent; cursor: grab; transition: var(--trans);
            position: relative;
        }
        .kanban-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); border-color: var(--primary-light); }
        .kanban-card:active { cursor: grabbing; }
       
        .card-tag { display: inline-block; font-size: 0.65rem; font-weight: 700; color: var(--text-muted); background: #F3F4F6; padding: 2px 6px; border-radius: 4px; margin-bottom: 8px; }
        .card-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 10px; line-height: 1.4; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #F3F4F6; padding-top: 10px; }
        .avatar-circle { width: 24px; height: 24px; background: var(--primary); color: white; border-radius: 50%; font-size: 0.7rem; display: flex; justify-content: center; align-items: center; font-weight: 700; }

        /* --- VUE 3: TEAM LOAD (RESSOURCES) --- */
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .team-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .team-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .team-avatar-lg { width: 48px; height: 48px; background: #F3F4F6; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        .load-bar-container { margin-top: 12px; }
        .load-info { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px; font-weight: 600; }
        .load-track { height: 8px; background: #F3F4F6; border-radius: 4px; overflow: hidden; }
        .load-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-panel { background: white; width: 500px; padding: 30px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 24px; }
        .modal-header h2 { margin: 0; font-size: 1.4rem; }
       
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }

        /* UTILS */
        .hidden { display: none; }
        .text-red { color: var(--danger); }
        .text-green { color: var(--done); }
       
        /* Drag Overlay (Visual feedback) */
        .dragging { opacity: 0.5; transform: scale(0.95); }
    </style>
</head>
<body>

    <div class="topbar">
        <div class="brand">
            ‚ö° PROJET MASTER <span>V5</span>
        </div>
       
        <div class="view-switcher">
            <button class="view-btn active" onclick="switchView('list')">Liste</button>
            <button class="view-btn" onclick="switchView('kanban')">Kanban</button>
            <button class="view-btn" onclick="switchView('team')">√âquipe</button>
            <button class="view-btn" onclick="switchView('gantt')">Gantt</button>
        </div>

        <div class="actions">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Rechercher (Ctrl+K)..." onkeyup="globalSearch(this.value)">
            </div>
            <button class="btn-new" onclick="openModal()">
                <span>+</span> Cr√©er
            </button>
        </div>
    </div>

    <div class="workspace">
       
        <div id="view-list" class="view-layer active">
            <table class="data-grid">
                <thead>
                    <tr>
                        <th style="width:35%">T√¢che / Projet</th>
                        <th style="width:20%">Responsable</th>
                        <th style="width:15%">Date Fin</th>
                        <th style="width:20%">Statut & Avancement</th>
                        <th style="width:10%">Priorit√©</th>
                    </tr>
                </thead>
                <tbody id="listBody"></tbody>
            </table>
        </div>

        <div id="view-kanban" class="view-layer">
            <div class="kanban-board">
                <div class="kanban-col" data-status="A faire">
                    <div class="col-header">√Ä FAIRE <span class="col-count" id="count-todo">0</span></div>
                    <div class="col-body" id="col-todo" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="kanban-col" data-status="En cours">
                    <div class="col-header">EN COURS <span class="col-count" id="count-prog">0</span></div>
                    <div class="col-body" id="col-prog" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="kanban-col" data-status="En review">
                    <div class="col-header">EN VALIDATION <span class="col-count" id="count-rev">0</span></div>
                    <div class="col-body" id="col-rev" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
                <div class="kanban-col" data-status="Termin√©">
                    <div class="col-header">TERMIN√â <span class="col-count" id="count-done">0</span></div>
                    <div class="col-body" id="col-done" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                </div>
            </div>
        </div>

        <div id="view-team" class="view-layer">
            <div class="team-grid" id="teamGrid"></div>
        </div>

        <div id="view-gantt" class="view-layer">
            <div id="gantt-chart" style="background:white; padding:20px; border-radius:12px;"></div>
        </div>

    </div>

    <div class="modal-overlay" id="mainModal">
        <div class="modal-panel">
            <div class="modal-header">
                <h2 id="modalTitle">T√¢che</h2>
                <button style="border:none; background:none; font-size:1.5rem; cursor:pointer" onclick="closeModal()">‚úï</button>
            </div>
            <form id="mainForm">
                <input type="hidden" id="inpId">
                <div style="margin-bottom:16px;">
                    <label>Titre</label>
                    <input type="text" id="inpTitle" required>
                </div>
                <div class="form-row">
                    <div><label>Projet</label><select id="inpProject" required></select></div>
                    <div><label>Responsable</label><select id="inpAgent"></select></div>
                </div>
                <div class="form-row">
                    <div><label>D√©but</label><input type="date" id="inpStart" required></div>
                    <div><label>Fin</label><input type="date" id="inpEnd" required></div>
                </div>
                <div class="form-row">
                    <div><label>Avancement (%)</label><input type="number" id="inpProgress" min="0" max="100"></div>
                    <div><label>Statut</label>
                        <select id="inpStatus">
                            <option value="A faire">√Ä faire</option>
                            <option value="En cours">En cours</option>
                            <option value="En review">En validation</option>
                            <option value="Termin√©">Termin√©</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-save">Enregistrer</button>
            </form>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <script>
        // --- 1. CORE CONFIGURATION ---
        const DB = { TASKS: 'TACHES_MASTER', AGENTS: 'AGENTS', PROJECTS: 'PROJETS', TEAMS: 'EQUIPES' };
        let DATA = { tasks: [], agents: [], projects: [], teams: [] };
        let filteredTasks = []; // Pour la recherche
        let gantt = null;

        // --- 2. INIT ---
        grist.ready({ requiredAccess: 'full' });
        grist.onRecords(async () => await fetchAllData());

        async function fetchAllData() {
            try {
                // Fetch parall√®le pour max performance
                const [rT, rA, rP, rEq] = await Promise.all([
                    grist.docApi.fetchTable(DB.TASKS),
                    grist.docApi.fetchTable(DB.AGENTS),
                    grist.docApi.fetchTable(DB.PROJECTS),
                    grist.docApi.fetchTable(DB.TEAMS)
                ]);

                // Mapping intelligent (Jointures)
                DATA.teams = mapTable(rEq, r => ({ id: r.id, name: r.Nom || r.Nom_Equipe }));
                DATA.projects = mapTable(rP, r => ({ id: r.id, name: r.Nom_Projet || r.Nom }));
               
                DATA.agents = mapTable(rA, r => {
                    const t = DATA.teams.find(tm => tm.id === r.Equipe);
                    return { id: r.id, name: r.Nom_Complet || r.Nom, team: t ? t.name : 'N/A' };
                });

                DATA.tasks = mapTable(rT, t => {
                    const ag = DATA.agents.find(a => a.id === t.Responsable) || {name: 'Inconnu', team: ''};
                    const pr = DATA.projects.find(p => p.id === t.Projet) || {name: 'Aucun'};
                   
                    // Calcul automatique du statut si manquant
                    let status = t.Statut || 'A faire';
                    if(t.Avancement === 100) status = 'Termin√©';
                    else if(t.Avancement > 0 && status === 'A faire') status = 'En cours';

                    return {
                        ...t, id: t.id.toString(),
                        agentName: ag.name, teamName: ag.team, projectName: pr.name,
                        status: status, // Champ calcul√© ou brut
                        // Gantt format
                        name: t.Titre, start: fmtDate(t.Date_Debut), end: fmtDate(t.Date_Fin),
                        progress: t.Avancement || 0, dependencies: t.Dependances || ""
                    };
                });

                filteredTasks = [...DATA.tasks]; // Init filtre
                renderAll(); // Tout dessiner

            } catch(e) { console.error("Erreur Sync:", e); }
        }

        // --- 3. RENDERING ENGINE ---
        function renderAll() {
            populateSelects();
            renderList();
            renderKanban();
            renderTeamLoad();
            renderGantt();
        }

        // VUE 1 : LISTE OPTIMIS√âE
        function renderList() {
            const tbody = document.getElementById('listBody');
            tbody.innerHTML = filteredTasks.map(t => {
                const badgeClass = t.status === 'Termin√©' ? 'text-green' : (t.status === 'En cours' ? 'text-blue' : '');
                const isLate = new Date(t.end) < new Date() && t.progress < 100;
               
                return `
                <tr onclick="editTask(${t.id})">
                    <td>
                        <div class="cell-title">${t.Titre}</div>
                        <div class="cell-sub"><span class="badge-pill">${t.projectName}</span></div>
                    </td>
                    <td>
                        <div class="cell-title">${t.agentName}</div>
                        <div class="cell-sub">${t.teamName ? `<span class="badge-team">${t.teamName}</span>` : ''}</div>
                    </td>
                    <td style="${isLate ? 'color:var(--danger); font-weight:700' : ''}">${t.end}</td>
                    <td>
                        <div style="display:flex; align-items:center;">
                            <div class="mini-progress"><div class="mini-fill" style="width:${t.progress}%; background:${getColor(t.progress)}"></div></div>
                            <span style="font-size:0.8rem; font-weight:600 ${badgeClass}">${t.status}</span>
                        </div>
                    </td>
                    <td>${t.Priorite || 'Moyenne'}</td>
                </tr>`;
            }).join('');
        }

        // VUE 2 : KANBAN DRAG & DROP
        function renderKanban() {
            // Reset colonnes
            ['todo', 'prog', 'rev', 'done'].forEach(c => {
                document.getElementById(`col-${c}`).innerHTML = '';
                document.getElementById(`count-${c}`).innerText = '0';
            });

            const map = { 'A faire': 'todo', 'En cours': 'prog', 'En review': 'rev', 'Termin√©': 'done' };

            filteredTasks.forEach(t => {
                const colKey = map[t.status] || 'todo';
                const card = document.createElement('div');
                card.className = 'kanban-card';
                card.draggable = true;
                card.ondragstart = (e) => drag(e, t.id);
                card.onclick = () => editTask(t.id);
               
                card.innerHTML = `
                    <div class="card-tag">${t.projectName}</div>
                    <div class="card-title">${t.Titre}</div>
                    <div class="card-footer">
                        <div class="avatar-circle">${t.agentName.substring(0,2).toUpperCase()}</div>
                        <span style="font-size:0.7rem; font-weight:700; color:${getColor(t.progress)}">${t.progress}%</span>
                    </div>
                `;
               
                document.getElementById(`col-${colKey}`).appendChild(card);
                // Update compteur
                const countEl = document.getElementById(`count-${colKey}`);
                countEl.innerText = parseInt(countEl.innerText) + 1;
            });
        }

        // VUE 3 : TEAM LOAD
        function renderTeamLoad() {
            const grid = document.getElementById('teamGrid');
            grid.innerHTML = DATA.agents.map(ag => {
                const myTasks = DATA.tasks.filter(t => t.Responsable === ag.id && t.progress < 100);
                const count = myTasks.length;
                const loadPercent = Math.min(count * 20, 100); // 5 t√¢ches = 100% load (arbitraire)
                const loadColor = count > 4 ? 'var(--danger)' : (count > 2 ? 'var(--review)' : 'var(--done)');

                return `
                <div class="team-card">
                    <div class="team-header">
                        <div class="team-avatar-lg">${ag.name.charAt(0)}</div>
                        <div>
                            <div style="font-weight:700">${ag.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted)">${ag.team}</div>
                        </div>
                        <div style="margin-left:auto; font-size:1.5rem; font-weight:800; color:${loadColor}">${count}</div>
                    </div>
                    <div class="load-bar-container">
                        <div class="load-info"><span>Charge</span><span>${loadPercent}%</span></div>
                        <div class="load-track"><div class="load-fill" style="width:${loadPercent}%; background:${loadColor}"></div></div>
                    </div>
                </div>`;
            }).join('');
        }

        // VUE 4 : GANTT
        function renderGantt() {
            const el = document.getElementById('gantt-chart');
            el.innerHTML = '';
            if(filteredTasks.length === 0) return;

            // Sort by Project then Date
            const sorted = [...filteredTasks].sort((a,b) => (a.projectName > b.projectName ? 1 : -1));

            gantt = new Gantt("#gantt-chart", sorted, {
                header_height: 50, column_width: 30, step: 24,
                view_modes: ['Day', 'Week', 'Month'],
                bar_height: 25, bar_corner_radius: 4, arrow_curve: 5, padding: 18,
                view_mode: 'Week', date_format: 'YYYY-MM-DD', language: 'fr',
                on_click: t => editTask(t.id),
                on_date_change: (t, s, e) => saveAction('UpdateRecord', t.id, { Date_Debut: fmtDate(s), Date_Fin: fmtDate(e) }),
                on_progress_change: (t, p) => saveAction('UpdateRecord', t.id, { Avancement: p })
            });
        }

        // --- 4. INTERACTIONS (Drag & Drop, Search) ---
       
        // Search
        window.globalSearch = (val) => {
            val = val.toLowerCase();
            filteredTasks = DATA.tasks.filter(t =>
                t.Titre.toLowerCase().includes(val) ||
                t.agentName.toLowerCase().includes(val) ||
                t.projectName.toLowerCase().includes(val)
            );
            renderAll();
        };

        // Drag & Drop Kanban
        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev, id) { ev.dataTransfer.setData("text", id); }
        function drop(ev) {
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            // Trouver la colonne cible
            let target = ev.target;
            while (!target.classList.contains('kanban-col')) { target = target.parentElement; }
            const newStatus = target.getAttribute('data-status');
           
            // Optimistic UI update
            const task = DATA.tasks.find(t => t.id == id);
            if(task && task.status !== newStatus) {
                task.status = newStatus;
                // Si Termin√© -> 100%, sinon garder
                const updates = { Statut: newStatus }; // Supposant que vous avez une colonne Statut texte
                if(newStatus === 'Termin√©') updates.Avancement = 100;
               
                saveAction('UpdateRecord', id, updates);
                renderKanban(); // Refresh instantan√©
            }
        }

        // --- 5. CORE UTILS ---
        async function saveAction(action, rowId, fields) {
            const args = action === 'AddRecord' ? [null, fields] : [parseInt(rowId), fields];
            try { await grist.docApi.applyUserActions([[action, DB.TASKS, ...args]]); }
            catch(e) { alert(e.message); }
        }

        function editTask(id) {
            const t = DATA.tasks.find(x => x.id == id);
            if(!t) return;
            document.getElementById('modalTitle').innerText = "Modifier T√¢che";
            document.getElementById('inpId').value = t.id;
            document.getElementById('inpTitle').value = t.Titre;
            document.getElementById('inpProject').value = t.Projet;
            document.getElementById('inpAgent').value = t.Responsable;
            document.getElementById('inpStart').value = t.start;
            document.getElementById('inpEnd').value = t.end;
            document.getElementById('inpProgress').value = t.progress;
            document.getElementById('inpStatus').value = t.status;
            openModalWindow();
        }

        function openModal() {
            // Reset for new
            if(!document.getElementById('inpId').value) document.getElementById('mainForm').reset();
            openModalWindow();
        }
       
        function openModalWindow() { document.getElementById('mainModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('mainModal').style.display = 'none'; document.getElementById('inpId').value = ''; }

        document.getElementById('mainForm').onsubmit = e => {
            e.preventDefault();
            const id = document.getElementById('inpId').value;
            const data = {
                Titre: document.getElementById('inpTitle').value,
                Projet: parseInt(document.getElementById('inpProject').value),
                Responsable: parseInt(document.getElementById('inpAgent').value),
                Date_Debut: document.getElementById('inpStart').value,
                Date_Fin: document.getElementById('inpEnd').value,
                Avancement: parseInt(document.getElementById('inpProgress').value),
                // Statut: document.getElementById('inpStatus').value // Si vous avez cette colonne
            };
            saveAction(id ? 'UpdateRecord' : 'AddRecord', id, data);
            closeModal();
        };

        // Helpers
        function switchView(v) {
            document.querySelectorAll('.view-layer').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.view-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(`view-${v}`).classList.add('active');
            // Trouver le bouton correspondant est complexe ici, on simplifie
            if(v==='gantt' && gantt) setTimeout(()=>gantt.refresh(filteredTasks), 50);
        }
        function mapTable(t, fn) { const k=Object.keys(t); if(!k.length) return []; const r=[]; for(let i=0; i<t.id.length; i++){ let o={}; k.forEach(key=>o[key]=t[key][i]); r.push(fn(o)); } return r; }
        function fmtDate(v) { if(!v) return new Date().toISOString().split('T')[0]; const d = typeof v==='number'?new Date(v*1000):new Date(v); return d.toISOString().split('T')[0]; }
        function getColor(p) { return p==100 ? 'var(--done)' : (p>0 ? 'var(--progress)' : 'var(--todo)'); }
        function populateSelects() {
            const fill = (id, list) => {
                const el = document.getElementById(id);
                const v = el.value; el.innerHTML = el.options[0].outerHTML;
                list.forEach(i => { const o = document.createElement('option'); o.value=i.id; o.innerText=i.name; el.appendChild(o); });
                if(list.some(i=>i.id==v)) el.value=v;
            };
            fill('inpProject', DATA.projects); fill('inpAgent', DATA.agents);
        }
       
        window.onclick = e => { if(e.target == document.getElementById('mainModal')) closeModal(); }
    </script>
</body>
</html>
