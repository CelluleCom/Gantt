<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Grist Project Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
   
    <style>
        :root {
            --primary: #000091;
            --primary-hover: #1212ff;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --danger: #ef4444;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        /* HEADER & NAV */
        .nav-bar { background: var(--surface); padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; height: 60px; flex-shrink: 0; }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .nav-title { font-weight: 700; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
       
        /* Boutons */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; display: flex; align-items: center; gap: 6px; }
        .btn-primary:hover { background: var(--primary-hover); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .btn-ghost { background: transparent; color: #64748b; }
        .btn-ghost.active { background: #e0e7ff; color: var(--primary); }

        /* CONTENT AREAS */
        .view-section { display: none; padding: 20px; overflow-y: auto; height: 100%; }
        .view-section.active { display: block; }

        /* DASHBOARD GRID */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--surface); padding: 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .kpi-num { font-size: 2rem; font-weight: 700; color: var(--text); }
        .kpi-lbl { font-size: 0.8rem; text-transform: uppercase; color: #64748b; font-weight: 600; }
       
        .task-list { background: var(--surface); border-radius: 8px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-top: 20px; }
        .task-row { display: flex; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid var(--border); align-items: center; cursor: pointer; transition: background 0.1s; }
        .task-row:hover { background: #f8fafc; }

        /* GANTT TOOLBAR */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; background: var(--surface); padding: 10px; border-radius: 8px; align-items: center; }
        .view-mode-btn { padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .view-mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .gantt-container { background: var(--surface); border-radius: 8px; padding: 10px; overflow-x: auto; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 10px; width: 450px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .modal-header { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-bottom: 20px; display: flex; justify-content: space-between; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-col { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem; color: #334155; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* COLORS */
        .text-red { color: var(--danger); }
        .bg-green { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
        .bg-blue { background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
        .bg-red { background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }

        /* GANTT BARS */
        .bar-critique .bar { fill: #ef4444 !important; }
        .bar-haute .bar { fill: #f97316 !important; }
        .bar-normal .bar { fill: #3b82f6 !important; }
        .bar-termine .bar { fill: #10b981 !important; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-left">
            <div class="nav-title">⚡ Pilotage Projets</div>
            <div class="tabs">
                <button class="btn btn-ghost active" onclick="switchTab('dashboard', this)">Tableau de Bord</button>
                <button class="btn btn-ghost" onclick="switchTab('gantt', this)">Planning Gantt</button>
            </div>
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()">
            <span>+</span> Nouvelle Tâche
        </button>
    </div>

    <div id="view-dashboard" class="view-section active">
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-num" id="kpi-total">0</div>
                <div class="kpi-lbl">Total Tâches</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-num text-red" id="kpi-retard">0</div>
                <div class="kpi-lbl">En Retard</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-num" id="kpi-avancement">0%</div>
                <div class="kpi-lbl">Avancement Global</div>
            </div>
        </div>
       
        <h3>Tâches Récentes</h3>
        <div class="task-list" id="dashboard-list">
            </div>
    </div>

    <div id="view-gantt" class="view-section">
        <div class="toolbar">
            <span style="font-weight:600; font-size:0.9rem; margin-right:10px;">Zoom :</span>
            <button class="view-mode-btn" onclick="changeViewMode('Day', this)">Jour</button>
            <button class="view-mode-btn active" onclick="changeViewMode('Week', this)">Semaine</button>
            <button class="view-mode-btn" onclick="changeViewMode('Month', this)">Mois</button>
        </div>
        <div class="gantt-container">
            <svg id="gantt"></svg>
        </div>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal-box">
            <div class="modal-header">
                <span id="modalTitle">Nouvelle Tâche</span>
                <span style="cursor:pointer; color:#94a3b8;" onclick="closeModal()">✕</span>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId"> <div class="form-row">
                    <div class="form-col">
                        <label>Titre de la tâche</label>
                        <input type="text" id="inputTitle" required placeholder="Ex: Rédaction specs...">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>Début</label>
                        <input type="date" id="inputStart" required>
                    </div>
                    <div class="form-col">
                        <label>Fin</label>
                        <input type="date" id="inputEnd" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>Responsable</label>
                        <select id="inputAgent">
                            <option value="">-- Sélectionner --</option>
                            </select>
                    </div>
                    <div class="form-col">
                        <label>Priorité</label>
                        <select id="inputPriority">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" id="progressContainer">
                    <div class="form-col">
                        <label>Avancement (%)</label>
                        <input type="number" id="inputProgress" min="0" max="100" value="0">
                    </div>
                </div>

                <div style="display:flex; justify-content:flex-end; margin-top:20px; gap:10px;">
                    <button type="button" class="btn btn-ghost" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <script>
        const TABLE_NAME = 'TACHES_MASTER';
        let gantt;
        let tasks = [];
        let uniqueAgents = new Set(); // Pour le menu déroulant dynamique
        let currentViewMode = 'Week';

        // 1. DÉMARRAGE GRIST
        grist.ready({
            columns: [
                { name: "Titre", type: 'Text'},
                { name: "Date_Debut", type: 'Date'},
                { name: "Date_Fin", type: 'Date'},
                { name: "Avancement", type: 'Int'},
                { name: "Priorite", type: 'Choice'},
                { name: "Dependances", type: 'Text'},
                { name: "Responsable", type: 'Text'} // Référence
            ],
            requiredAccess: 'full'
        });

        grist.onRecords(function(records) {
            uniqueAgents.clear();

            tasks = records.map(rec => {
                // Logique couleurs
                const isLate = new Date(rec.Date_Fin) < new Date() && rec.Avancement < 100;
                let color = 'bar-normal';
                if(rec.Avancement === 100) color = 'bar-termine';
                else if(rec.Priorite === 'Critique' || isLate) color = 'bar-critique';
                else if(rec.Priorite === 'Haute') color = 'bar-haute';

                // Collecte des agents pour le menu
                if(rec.Responsable) uniqueAgents.add(rec.Responsable);

                return {
                    id: rec.id.toString(),
                    name: rec.Titre || "Nouvelle tâche",
                    start: formatDateIso(rec.Date_Debut),
                    end: formatDateIso(rec.Date_Fin),
                    progress: rec.Avancement || 0,
                    dependencies: rec.Dependances || "",
                    priority: rec.Priorite,
                    agent: rec.Responsable,
                    custom_class: color
                };
            });

            // Refresh UI
            renderGantt();
            renderDashboard();
            updateAgentDropdown();
        });

        // 2. GESTION GANTT
        function renderGantt() {
            const ganttEl = document.getElementById("gantt");
            ganttEl.innerHTML = "";
           
            if(tasks.length === 0) {
                ganttEl.innerHTML = "<p style='text-align:center; padding:20px;'>Aucune tâche. Cliquez sur le bouton pour en créer une !</p>";
                return;
            }

            gantt = new Gantt("#gantt", tasks, {
                header_height: 50,
                column_width: 30,
                view_mode: currentViewMode,
                language: 'fr',
                date_format: 'YYYY-MM-DD',
                on_click: task => openEditModal(task),
                on_date_change: (task, start, end) => {
                    saveToGrist('UpdateRecord', task.id, {
                        Date_Debut: formatDateIso(start),
                        Date_Fin: formatDateIso(end)
                    });
                },
                on_progress_change: (task, progress) => {
                    saveToGrist('UpdateRecord', task.id, { Avancement: progress });
                }
            });
        }

        // 3. ACTIONS MODALES (CRÉATION vs ÉDITION)
        const modal = document.getElementById('taskModal');

        function openCreateModal() {
            // Reset du formulaire
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = ""; // ID vide = CRÉATION
            document.getElementById('modalTitle').innerText = "Nouvelle Tâche";
           
            // Dates par défaut (Aujourd'hui)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inputStart').value = today;
            document.getElementById('inputEnd').value = today;
            document.getElementById('progressContainer').style.display = 'none'; // Pas d'avancement à la création

            updateAgentDropdown(); // S'assurer que la liste est à jour
            modal.style.display = 'flex';
        }

        function openEditModal(task) {
            document.getElementById('taskId').value = task.id;
            document.getElementById('modalTitle').innerText = "Éditer : " + task.name;
           
            document.getElementById('inputTitle').value = task.name;
            document.getElementById('inputStart').value = task.start;
            document.getElementById('inputEnd').value = task.end;
            document.getElementById('inputProgress').value = task.progress;
            document.getElementById('inputPriority').value = task.priority || 'Moyenne';
            document.getElementById('inputAgent').value = task.agent || "";
           
            document.getElementById('progressContainer').style.display = 'flex';
            modal.style.display = 'flex';
        }

        function closeModal() { modal.style.display = 'none'; }

        // 4. SOUMISSION DU FORMULAIRE (ADD ou UPDATE)
        document.getElementById('taskForm').onsubmit = function(e) {
            e.preventDefault();
           
            const id = document.getElementById('taskId').value;
            const data = {
                Titre: document.getElementById('inputTitle').value,
                Date_Debut: document.getElementById('inputStart').value,
                Date_Fin: document.getElementById('inputEnd').value,
                Priorite: document.getElementById('inputPriority').value,
                Responsable: document.getElementById('inputAgent').value
            };

            if(id) {
                // MODIFICATION
                data.Avancement = parseInt(document.getElementById('inputProgress').value);
                saveToGrist('UpdateRecord', id, data);
            } else {
                // CRÉATION
                data.Avancement = 0; // Défaut
                saveToGrist('AddRecord', null, data);
            }
            closeModal();
        };

        // 5. API GRIST (Générique)
        function saveToGrist(action, rowId, fields) {
            console.log(action, rowId, fields);
            // Si AddRecord, rowId est null. Si UpdateRecord, rowId est requis.
            const args = action === 'AddRecord' ? [null, fields] : [parseInt(rowId), fields];
           
            grist.docApi.applyUserActions([
                [action, TABLE_NAME, ...args]
            ]).catch(e => console.error(e));
        }

        // 6. DASHBOARD & UTILS
        function renderDashboard() {
            // KPIs
            const total = tasks.length;
            const retard = tasks.filter(t => new Date(t.end) < new Date() && t.progress < 100).length;
            const avg = total ? tasks.reduce((a,b)=>a+(b.progress||0),0)/total : 0;

            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-retard').innerText = retard;
            document.getElementById('kpi-avancement').innerText = Math.round(avg) + "%";

            // Liste
            const container = document.getElementById('dashboard-list');
            container.innerHTML = "";
            tasks.slice(0, 6).forEach(t => {
                let badge = t.progress === 100 ? `<span class="bg-green">Terminé</span>`
                          : new Date(t.end) < new Date() ? `<span class="bg-red">Retard</span>`
                          : `<span class="bg-blue">${t.progress}%</span>`;
               
                const div = document.createElement('div');
                div.className = 'task-row';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:600">${t.name}</div>
                        <div style="font-size:0.8rem; color:#64748b">${t.agent || 'Non assigné'}</div>
                    </div>
                    ${badge}
                `;
                div.onclick = () => openEditModal(t);
                container.appendChild(div);
            });
        }

        function updateAgentDropdown() {
            const sel = document.getElementById('inputAgent');
            const currentVal = sel.value;
            // Garder l'option par défaut + les agents uniques trouvés
            sel.innerHTML = '<option value="">-- Sélectionner --</option>';
            uniqueAgents.forEach(agent => {
                const opt = document.createElement('option');
                opt.value = agent;
                opt.innerText = agent;
                sel.appendChild(opt);
            });
            sel.value = currentVal;
        }

        // Navigation
        window.switchTab = function(viewId, btn) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-left .btn').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            if(btn) btn.classList.add('active');
            if(viewId === 'gantt' && gantt) setTimeout(() => gantt.refresh(tasks), 50);
        }

        window.changeViewMode = function(mode, btn) {
            currentViewMode = mode;
            document.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            renderGantt();
        }

        function formatDateIso(d) {
            if(!d) return new Date().toISOString().split('T')[0];
            let date = typeof d === 'number' ? new Date(d*1000) : new Date(d);
            return isNaN(date) ? "" : date.toISOString().split('T')[0];
        }
       
        // Clic outside modal
        window.onclick = e => { if(e.target == modal) closeModal(); }
    </script>
</body>
</html>
