<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt'FIP Manager</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        /* --- 1. VARIABLES & THÈME --- */
        :root {
            --primary: var(--grist-theme-cursor, #16b378);
            --bg: var(--grist-theme-page-bg, #ffffff);
            --text: var(--grist-theme-text, #333333);
            --border: var(--grist-theme-border, #d9d9d9);
            --card-bg: var(--grist-theme-panel-header-bg, #f7f7f7);
            --danger: #e74c3c;
            --warning: #f1c40f;
            --radius: 6px;
            --spacing: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: var(--spacing);
            font-size: 13px;
            overflow-x: hidden; /* Evite scroll horizontal global */
        }

        /* --- 2. HEADER & NAVIGATION --- */
        .header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .app-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--text);
            margin: 0;
            letter-spacing: -0.5px;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
            background: var(--card-bg);
            padding: 4px;
            border-radius: var(--radius);
            width: fit-content;
        }

        .tab-btn {
            padding: 6px 16px;
            border: none;
            background: transparent;
            border-radius: 4px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #fff;
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* --- 3. CONTRÔLES (Filtres & Action) --- */
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .control-item { flex: 1; min-width: 140px; }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg);
            color: var(--text);
        }

        .btn-add {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- 4. VUES --- */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* VUE 1: LISTE (CARDS) */
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: transform 0.1s;
        }
        .card:hover { transform: translateY(-1px); border-color: var(--primary); }
        
        .badges-row { display: flex; gap: 4px; flex-wrap: wrap; margin: 6px 0; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; color: #fff; }

        /* VUE 2: GANTT (CSS PURE) */
        .gantt-container {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg);
            overflow-x: auto;
        }
        .gantt-header {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #f0f0f0;
            font-weight: bold;
            font-size: 11px;
            border-bottom: 1px solid var(--border);
        }
        .gantt-row {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            position: relative;
            height: 36px;
        }
        .gantt-label {
            width: 120px;
            flex-shrink: 0;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px;
            font-size: 12px;
        }
        .gantt-track {
            flex-grow: 1;
            position: relative;
            height: 100%;
            background: rgba(0,0,0,0.02);
            border-radius: 4px;
        }
        .gantt-bar {
            position: absolute;
            height: 16px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 8px;
            min-width: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: width 0.5s ease;
        }
        .gantt-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px;
            font-size: 10px;
            border-radius: 4px;
            display: none;
            white-space: nowrap;
            z-index: 10;
        }
        .gantt-bar:hover .gantt-tooltip { display: block; }

        /* VUE 3: DASHBOARD */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--border);
        }
        .kpi-value { font-size: 24px; font-weight: 800; color: var(--primary); }
        .kpi-label { font-size: 11px; text-transform: uppercase; color: #666; margin-top: 4px; }

        .chart-fake {
            height: 12px;
            background: #eee;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
        }
        .chart-segment { height: 100%; }

    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 class="app-title">Gantt'FIP</h1>
            <button class="btn-add" onclick="createTask()">+ Tâche</button>
        </div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchView('list')">Liste</button>
            <button class="tab-btn" onclick="switchView('gantt')">Gantt</button>
            <button class="tab-btn" onclick="switchView('dashboard')">Tableau de Bord</button>
        </div>
    </div>

    <div class="controls">
        <div class="control-item">
            <select id="filter-team" onchange="applyFilters()">
                <option value="all">Toutes les Admin.</option>
            </select>
        </div>
        <div class="control-item">
            <select id="filter-project" onchange="applyFilters()">
                <option value="all">Tous les Projets</option>
            </select>
        </div>
    </div>

    <div id="view-list" class="view-section active">
        <div id="list-container" class="task-list">Chargement...</div>
    </div>

    <div id="view-gantt" class="view-section">
        <div class="gantt-header" id="gantt-dates">
            <span>Début Période</span>
            <span>Fin Période</span>
        </div>
        <div id="gantt-container" class="gantt-container">
            </div>
        <div style="text-align:center; font-style:italic; color:#999; margin-top:8px;">
            Seules les tâches avec dates sont affichées.
        </div>
    </div>

    <div id="view-dashboard" class="view-section">
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-total">0</div>
                <div class="kpi-label">Tâches</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-progress">0%</div>
                <div class="kpi-label">Avancement Moyen</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-late" style="color:var(--danger)">0</div>
                <div class="kpi-label">En Retard</div>
            </div>
        </div>
        
        <h4 style="margin:0 0 10px 0">Répartition par Administration</h4>
        <div id="bar-chart" class="chart-fake" style="margin-bottom: 20px;"></div>
        <div id="legend-chart" style="display:flex; gap:10px; flex-wrap:wrap; font-size:11px;"></div>
    </div>

<script>
    // --- CONFIGURATION STRICTE ---
    const MAPPING = [
        { name: 'Title',     title: 'Titre' },
        { name: 'Assignee',  title: 'Responsable' },
        { name: 'Team',      title: 'Administration' }, // Filtre Admin
        { name: 'Project',   title: 'Projet' },         // Filtre Projet
        { name: 'StartDate', title: 'Début', type: 'Date' },
        { name: 'EndDate',   title: 'Fin',   type: 'Date' },
        { name: 'Progress',  title: 'Progression', type: 'Numeric' },
        { name: 'Priority',  title: 'Priorité' }
    ];

    let state = {
        records: [],
        filtered: [],
        filters: { team: 'all', project: 'all' },
        currentView: 'list'
    };

    // --- UTILITAIRES ---
    function cleanData(tableData) {
        if (!tableData) return [];
        if (Array.isArray(tableData)) return tableData;
        const keys = Object.keys(tableData);
        if (!keys.length) return [];
        const count = tableData[keys[0]].length;
        const res = [];
        for(let i=0; i<count; i++) {
            let obj = { id: tableData.id[i] };
            keys.forEach(k => { if(k !== 'id') obj[k] = tableData[k][i]; });
            res.push(obj);
        }
        return res;
    }

    function gristDate(val) {
        if (!val && val !== 0) return null;
        return val > 100000 ? new Date(val * 1000) : new Date(val * 24 * 60 * 60 * 1000);
    }
    
    function dateToGrist(d) {
        return Math.floor(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()) / 86400000);
    }

    function getColor(str) {
        if (!str) return '#ccc';
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        return `hsl(${Math.abs(hash) % 360}, 65%, 45%)`;
    }

    function formatDate(d) {
        return d ? d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) : '-';
    }

    // --- NAVIGATION ---
    function switchView(viewName) {
        state.currentView = viewName;
        // Update Tabs
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="switchView('${viewName}')"]`).classList.add('active');
        // Update Content
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
        
        // Re-render si nécessaire (notamment Gantt qui dépend de la largeur)
        render(); 
    }

    // --- LOGIQUE GRIST ---
    grist.ready({ columns: MAPPING, requiredAccess: 'full' });
    grist.onRecords(data => {
        state.records = cleanData(data);
        updateFiltersUI();
        applyFilters();
    });

    function updateFiltersUI() {
        // Remplir les Selects seulement si vides (pour ne pas reset sélection)
        const teamSel = document.getElementById('filter-team');
        const projSel = document.getElementById('filter-project');
        
        const teams = [...new Set(state.records.map(r => r.Team).filter(Boolean))].sort();
        const projs = [...new Set(state.records.map(r => r.Project).filter(Boolean))].sort();

        const saveT = teamSel.value;
        const saveP = projSel.value;

        teamSel.innerHTML = `<option value="all">Toutes les Admin.</option>` + 
            teams.map(t => `<option value="${t}">${t}</option>`).join('');
        
        projSel.innerHTML = `<option value="all">Tous les Projets</option>` + 
            projs.map(p => `<option value="${p}">${p}</option>`).join('');

        if(teams.includes(saveT)) teamSel.value = saveT;
        if(projs.includes(saveP)) projSel.value = saveP;
    }

    function applyFilters() {
        state.filters.team = document.getElementById('filter-team').value;
        state.filters.project = document.getElementById('filter-project').value;

        state.filtered = state.records.filter(r => {
            const okTeam = state.filters.team === 'all' || r.Team === state.filters.team;
            const okProj = state.filters.project === 'all' || r.Project === state.filters.project;
            return okTeam && okProj;
        });

        render();
    }

    async function createTask() {
        const fields = { 
            Title: 'Nouvelle Tâche', 
            StartDate: dateToGrist(new Date()),
            Progress: 0 
        };
        if(state.filters.team !== 'all') fields.Team = state.filters.team;
        if(state.filters.project !== 'all') fields.Project = state.filters.project;
        
        try { await grist.selectedTable.create({ fields }); }
        catch(e) { alert("Erreur Création. Vérifiez IDs colonnes (Team, Project, EndDate)"); }
    }

    // --- RENDU GLOBAL ---
    function render() {
        if(state.currentView === 'list') renderList();
        else if(state.currentView === 'gantt') renderGantt();
        else renderDashboard();
    }

    // 1. RENDER LISTE
    function renderList() {
        const div = document.getElementById('list-container');
        div.innerHTML = '';
        if(!state.filtered.length) { div.innerHTML = '<div style="text-align:center;color:#999">Aucune tâche.</div>'; return; }

        state.filtered.forEach(row => {
            const el = document.createElement('div');
            el.className = 'card';
            el.onclick = () => grist.setSelectedRows([row.id]);
            
            const badges = [];
            if(row.Team) badges.push({txt: row.Team, bg: getColor(row.Team)});
            if(row.Project) badges.push({txt: row.Project, bg: getColor(row.Project)});
            
            const progress = row.Progress || 0;
            const endDate = gristDate(row.EndDate);
            const isLate = endDate && endDate < new Date() && progress < 100;

            el.innerHTML = `
                <div style="display:flex; justify-content:space-between">
                    <span style="font-weight:700">${row.Title || 'Sans Titre'}</span>
                    ${isLate ? '<span style="color:red; font-weight:bold">!</span>' : ''}
                </div>
                <div class="badges-row">
                    ${badges.map(b => `<span class="badge" style="background:${b.bg}">${b.txt}</span>`).join('')}
                </div>
                <div style="font-size:11px; color:#666; display:flex; justify-content:space-between; margin-top:8px">
                    <span>${row.Assignee || 'Non assigné'}</span>
                    <span>${formatDate(endDate)}</span>
                </div>
                <div style="height:4px; background:#eee; border-radius:2px; margin-top:6px; overflow:hidden">
                    <div style="height:100%; width:${progress}%; background:${isLate ? 'red' : 'var(--primary)'}"></div>
                </div>
            `;
            div.appendChild(el);
        });
    }

    // 2. RENDER GANTT (ALGORITHME)
    function renderGantt() {
        const div = document.getElementById('gantt-container');
        div.innerHTML = '';
        
        // Filtrer tâches avec dates valides
        const tasks = state.filtered.filter(r => r.StartDate && r.EndDate).map(r => ({
            ...r,
            start: gristDate(r.StartDate),
            end: gristDate(r.EndDate)
        })).sort((a,b) => a.start - b.start);

        if(!tasks.length) { div.innerHTML = '<div style="padding:20px; text-align:center">Pas de dates définies pour le Gantt.</div>'; return; }

        // Trouver bornes temporelles globales
        let minT = new Date(Math.min(...tasks.map(t => t.start))).getTime();
        let maxT = new Date(Math.max(...tasks.map(t => t.end))).getTime();
        
        // Ajouter Marge (1 jour avant/après)
        const dayMs = 86400000;
        minT -= dayMs;
        maxT += dayMs;
        const totalDuration = maxT - minT;

        // Mise à jour header dates
        const header = document.getElementById('gantt-dates');
        header.innerHTML = `<span>${formatDate(new Date(minT))}</span><span>${formatDate(new Date(maxT))}</span>`;

        tasks.forEach(task => {
            const row = document.createElement('div');
            row.className = 'gantt-row';
            
            // Calcul positions %
            const startPct = ((task.start.getTime() - minT) / totalDuration) * 100;
            const widthPct = Math.max(((task.end.getTime() - task.start.getTime()) / totalDuration) * 100, 1); // Min 1% width
            
            const color = task.Project ? getColor(task.Project) : '#999';

            row.innerHTML = `
                <div class="gantt-label" title="${task.Title}">${task.Title}</div>
                <div class="gantt-track">
                    <div class="gantt-bar" style="left:${startPct}%; width:${widthPct}%; background:${color}">
                        <div class="gantt-tooltip">
                            ${formatDate(task.start)} au ${formatDate(task.end)} (${task.Progress || 0}%)
                        </div>
                    </div>
                </div>
            `;
            // Clic sur ligne = sélection Grist
            row.onclick = () => grist.setSelectedRows([task.id]);
            div.appendChild(row);
        });
    }

    // 3. RENDER DASHBOARD (KPIs)
    function renderDashboard() {
        const data = state.filtered;
        const total = data.length;
        
        // Calculs
        const avgProgress = total ? Math.round(data.reduce((acc, r) => acc + (r.Progress||0), 0) / total) : 0;
        const now = new Date();
        const lateCount = data.filter(r => {
            const end = gristDate(r.EndDate);
            return end && end < now && (r.Progress||0) < 100;
        }).length;

        // Injection DOM
        document.getElementById('kpi-total').innerText = total;
        document.getElementById('kpi-progress').innerText = avgProgress + '%';
        document.getElementById('kpi-late').innerText = lateCount;

        // Mini Chart par Team
        const teamCounts = {};
        data.forEach(r => { 
            const t = r.Team || 'Autre'; 
            teamCounts[t] = (teamCounts[t] || 0) + 1; 
        });
        
        const chartDiv = document.getElementById('bar-chart');
        const legendDiv = document.getElementById('legend-chart');
        chartDiv.innerHTML = ''; 
        legendDiv.innerHTML = '';

        Object.keys(teamCounts).forEach(team => {
            const count = teamCounts[team];
            const pct = (count / total) * 100;
            const color = getColor(team);
            
            // Segment barre
            const seg = document.createElement('div');
            seg.className = 'chart-segment';
            seg.style.width = pct + '%';
            seg.style.background = color;
            chartDiv.appendChild(seg);

            // Légende
            legendDiv.innerHTML += `
                <div style="display:flex; align-items:center; gap:4px;">
                    <span style="width:8px; height:8px; background:${color}; border-radius:50%"></span>
                    <span>${team} (${count})</span>
                </div>`;
        });
    }
</script>
</body>
</html>
