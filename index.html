<!DOCTYPE html>
<html lang="fr">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Gantt'FIP Ultimate</title>
Â  Â  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
Â  Â  <style>
Â  Â  Â  Â  /* --- 1. DESIGN SYSTEM (MODERNE & ARRONDI) --- */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --primary: var(--grist-theme-cursor, #2563eb);
Â  Â  Â  Â  Â  Â  --primary-light: #eff6ff;
Â  Â  Â  Â  Â  Â  --bg: var(--grist-theme-page-bg, #f8fafc);
Â  Â  Â  Â  Â  Â  --surface: #ffffff;
Â  Â  Â  Â  Â  Â  --text-main: #1e293b;
Â  Â  Â  Â  Â  Â  --text-sec: #64748b;
Â  Â  Â  Â  Â  Â  --border: #e2e8f0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Couleurs SÃ©mantiques */
Â  Â  Â  Â  Â  Â  --success: #10b981;
Â  Â  Â  Â  Â  Â  --warning: #f59e0b;
Â  Â  Â  Â  Â  Â  --danger: #ef4444;
Â  Â  Â  Â  Â  Â  --info: #3b82f6;

Â  Â  Â  Â  Â  Â  /* Formes */
Â  Â  Â  Â  Â  Â  --radius-sm: 8px;
Â  Â  Â  Â  Â  Â  --radius-md: 12px;
Â  Â  Â  Â  Â  Â  --radius-lg: 16px;
Â  Â  Â  Â  Â  Â  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
Â  Â  Â  Â  Â  Â  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  * { box-sizing: border-box; outline: none; }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
Â  Â  Â  Â  Â  Â  background-color: var(--bg);
Â  Â  Â  Â  Â  Â  color: var(--text-main);
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  line-height: 1.5;
Â  Â  Â  Â  Â  Â  padding-bottom: 80px; /* Espace pour le FAB mobile */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- 2. LAYOUT & NAVIGATION --- */
Â  Â  Â  Â  .app-header {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 16px;
Â  Â  Â  Â  Â  Â  margin-bottom: 24px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .header-top {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  h1.app-logo {
Â  Â  Â  Â  Â  Â  font-size: 22px;
Â  Â  Â  Â  Â  Â  font-weight: 800;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, var(--primary), #4f46e5);
Â  Â  Â  Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  Â  Â  Â  letter-spacing: -0.5px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Onglets (Pills Design) */
Â  Â  Â  Â  .nav-pills {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  background: #e2e8f0;
Â  Â  Â  Â  Â  Â  padding: 4px;
Â  Â  Â  Â  Â  Â  border-radius: var(--radius-lg);
Â  Â  Â  Â  Â  Â  width: fit-content;
Â  Â  Â  Â  Â  Â  gap: 4px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .nav-item {
Â  Â  Â  Â  Â  Â  padding: 8px 20px;
Â  Â  Â  Â  Â  Â  border-radius: var(--radius-md);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  color: var(--text-sec);
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  .nav-item.active {
Â  Â  Â  Â  Â  Â  background: var(--surface);
Â  Â  Â  Â  Â  Â  color: var(--text-main);
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-sm);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- 3. ACTIONS & FILTRES --- */
Â  Â  Â  Â  .toolbar {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr 1fr auto;
Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .select-modern {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 10px 14px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  Â  Â  Â  border-radius: var(--radius-md);
Â  Â  Â  Â  Â  Â  background: var(--surface);
Â  Â  Â  Â  Â  Â  color: var(--text-main);
Â  Â  Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  Â  Â  appearance: none;
Â  Â  Â  Â  Â  Â  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
Â  Â  Â  Â  Â  Â  background-repeat: no-repeat;
Â  Â  Â  Â  Â  Â  background-position: right 10px center;
Â  Â  Â  Â  Â  Â  background-size: 16px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-primary {
Â  Â  Â  Â  Â  Â  background: var(--primary);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  border-radius: var(--radius-md);
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-md);
Â  Â  Â  Â  Â  Â  transition: transform 0.1s;
Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-primary:active { transform: scale(0.98); }

Â  Â  Â  Â  /* --- 4. VUES (Transitions) --- */
Â  Â  Â  Â  .view-container { display: none; animation: fadeIn 0.4s ease; }
Â  Â  Â  Â  .view-container.active { display: block; }
Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

Â  Â  Â  Â  /* VUE 1: TABLEAU DE BORD (Grid) */
Â  Â  Â  Â  .dashboard-grid {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
Â  Â  Â  Â  Â  Â  gap: 16px;
Â  Â  Â  Â  Â  Â  margin-bottom: 24px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .stat-card {
Â  Â  Â  Â  Â  Â  background: var(--surface);
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  border-radius: var(--radius-lg);
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-sm);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  }

Â  Â  Â  Â  .stat-title { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-sec); letter-spacing: 0.5px; }
Â  Â  Â  Â  .stat-value { font-size: 32px; font-weight: 800; margin: 8px 0; color: var(--text-main); }
Â  Â  Â  Â  .stat-footer { font-size: 12px; color: var(--text-sec); display: flex; align-items: center; gap: 4px; }

Â  Â  Â  Â  .section-title { font-size: 16px; font-weight: 700; margin: 30px 0 16px 0; color: var(--text-main); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
Â  Â  Â  Â  .chart-box { background: var(--surface); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Barres de progression custom */
Â  Â  Â  Â  .bar-group { margin-bottom: 12px; }
Â  Â  Â  Â  .bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; font-weight: 500; }
Â  Â  Â  Â  .bar-bg { height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
Â  Â  Â  Â  .bar-fill { height: 100%; border-radius: 4px; }

Â  Â  Â  Â  /* Table minimaliste "Ã€ venir" */
Â  Â  Â  Â  .mini-table { width: 100%; border-collapse: collapse; }
Â  Â  Â  Â  .mini-table td { padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
Â  Â  Â  Â  .mini-table tr:last-child td { border-bottom: none; }

Â  Â  Â  Â  /* VUE 2: GANTT */
Â  Â  Â  Â  .gantt-wrapper {
Â  Â  Â  Â  Â  Â  background: var(--surface);
Â  Â  Â  Â  Â  Â  border-radius: var(--radius-lg);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .gantt-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; color: var(--text-sec); font-size: 12px; }
Â  Â  Â  Â  .gantt-line { display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid #f1f5f9; }
Â  Â  Â  Â  .gantt-text { width: 150px; flex-shrink: 0; font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
Â  Â  Â  Â  .gantt-timeline { flex-grow: 1; position: relative; height: 24px; background: #f8fafc; border-radius: 4px; }
Â  Â  Â  Â  .gantt-block { position: absolute; height: 16px; top: 4px; border-radius: 4px; min-width: 8px; cursor: pointer; transition: opacity 0.2s; }
Â  Â  Â  Â  .gantt-block:hover { opacity: 0.8; }

Â  Â  Â  Â  /* VUE 3: LISTE */
Â  Â  Â  Â  .task-list { display: flex; flex-direction: column; gap: 12px; }
Â  Â  Â  Â  .task-card {
Â  Â  Â  Â  Â  Â  background: var(--surface);
Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  Â  Â  border-radius: var(--radius-md);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border);
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-sm);
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .task-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
Â  Â  Â  Â  .task-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #cbd5e1; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .priority-high::before { background: var(--danger); }
Â  Â  Â  Â  .priority-medium::before { background: var(--warning); }
Â  Â  Â  Â  .priority-low::before { background: var(--success); }

Â  Â  Â  Â  .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
Â  Â  Â  Â  .card-h3 { font-size: 15px; font-weight: 700; margin: 0; }
Â  Â  Â  Â  .card-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
Â  Â  Â  Â  .tag { font-size: 11px; padding: 2px 8px; border-radius: 12px; font-weight: 600; color: #fff; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .card-btm { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-sec); }
Â  Â  Â  Â  .avatar-row { display: flex; align-items: center; gap: 6px; }

Â  Â  Â  Â  /* --- 5. MODALE (EDITION/CREATION) --- */
Â  Â  Â  Â  .modal-overlay {
Â  Â  Â  Â  Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.3);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(4px);
Â  Â  Â  Â  Â  Â  z-index: 999;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }

Â  Â  Â  Â  .modal-box {
Â  Â  Â  Â  Â  Â  background: var(--surface);
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  Â  Â  border-radius: var(--radius-lg);
Â  Â  Â  Â  Â  Â  box-shadow: var(--shadow-lg);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  max-height: 90vh;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
Â  Â  Â  Â  .modal-title { font-size: 18px; font-weight: 700; margin: 0; }
Â  Â  Â  Â  .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-sec); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .modal-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .form-group { display: flex; flex-direction: column; gap: 6px; }
Â  Â  Â  Â  .form-label { font-size: 12px; font-weight: 600; color: var(--text-sec); }
Â  Â  Â  Â  .form-input { padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 14px; width: 100%; }
Â  Â  Â  Â  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

Â  Â  Â  Â  .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
Â  Â  Â  Â  .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 10px 20px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Helper colors */
Â  Â  Â  Â  .text-success { color: var(--success); }
Â  Â  Â  Â  .text-danger { color: var(--danger); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Loading */
Â  Â  Â  Â  .loading { text-align: center; color: var(--text-sec); margin-top: 50px; }
Â  Â  </style>
</head>
<body>

Â  Â  <div class="app-header">
Â  Â  Â  Â  <div class="header-top">
Â  Â  Â  Â  Â  Â  <h1 class="app-logo">Gantt'FIP</h1>
Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="openModal()">
Â  Â  Â  Â  Â  Â  Â  Â  <span>+ Nouvelle TÃ¢che</span>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <nav class="nav-pills">
Â  Â  Â  Â  Â  Â  <button class="nav-item active" onclick="switchView('dashboard')">Tableau de Bord</button>
Â  Â  Â  Â  Â  Â  <button class="nav-item" onclick="switchView('gantt')">Gantt</button>
Â  Â  Â  Â  Â  Â  <button class="nav-item" onclick="switchView('list')">Liste</button>
Â  Â  Â  Â  </nav>
Â  Â  </div>

Â  Â  <div class="toolbar">
Â  Â  Â  Â  <select id="filter-team" class="select-modern" onchange="handleFilters()">
Â  Â  Â  Â  Â  Â  <option value="all">Toutes les administrations</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <select id="filter-project" class="select-modern" onchange="handleFilters()">
Â  Â  Â  Â  Â  Â  <option value="all">Tous les projets</option>
Â  Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div id="app-content">
Â  Â  Â  Â  <div class="loading">Chargement des donnÃ©es...</div>
Â  Â  </div>

Â  Â  <div id="modal" class="modal-overlay">
Â  Â  Â  Â  <div class="modal-box">
Â  Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="modal-title" class="modal-title">Nouvelle TÃ¢che</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="close-btn" onclick="closeModal()">&times;</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="input-id">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Titre de la tÃ¢che</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="input-title" class="form-input" placeholder="Ex: RÃ©diger le rapport...">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Administration (Team)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input list="list-teams" id="input-team" class="form-input" placeholder="Choisir ou crÃ©er...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <datalist id="list-teams"></datalist>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Projet</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input list="list-projects" id="input-project" class="form-input" placeholder="Choisir ou crÃ©er...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <datalist id="list-projects"></datalist>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Responsable</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input list="list-assignees" id="input-assignee" class="form-input" placeholder="Qui est en charge ?">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <datalist id="list-assignees"></datalist>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">PrioritÃ©</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="input-priority" class="form-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Low">Low (Basse)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Medium" selected>Medium (Moyenne)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="High">High (Haute)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Date de DÃ©but</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="input-start" class="form-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Date de Fin</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="input-end" class="form-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Progression (%)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="input-progress" class="form-input" min="0" max="100" value="0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="range" id="range-progress" min="0" max="100" value="0" style="margin-top:8px" oninput="document.getElementById('input-progress').value = this.value">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-footer">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-sec" onclick="closeModal()">Annuler</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn-primary" onclick="saveTask()">Enregistrer</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

<script>
Â  Â  /**
Â  Â  Â * ===========================================
Â  Â  Â * GANTT'FIP ULTIMATE - V6 ENGINE
Â  Â  Â * ===========================================
Â  Â  Â */

Â  Â  // --- 1. CONFIGURATION STRICTE ---
Â  Â  const MAPPING = [
Â  Â  Â  Â  { name: 'Title',Â  Â  Â title: 'Titre' },
Â  Â  Â  Â  { name: 'Assignee',Â  title: 'Responsable' },
Â  Â  Â  Â  { name: 'Team',Â  Â  Â  title: 'Administration' },
Â  Â  Â  Â  { name: 'Project',Â  Â title: 'Projet' },
Â  Â  Â  Â  { name: 'StartDate', title: 'DÃ©but', type: 'Date' },
Â  Â  Â  Â  { name: 'EndDate',Â  Â title: 'Fin',Â  Â type: 'Date' },
Â  Â  Â  Â  { name: 'Progress',Â  title: 'Progression', type: 'Numeric' },
Â  Â  Â  Â  { name: 'Priority',Â  title: 'PrioritÃ©', type: 'Choice' }
Â  Â  ];

Â  Â  // STATE MANAGEMENT
Â  Â  let state = {
Â  Â  Â  Â  allRecords: [],
Â  Â  Â  Â  filteredRecords: [],
Â  Â  Â  Â  filters: { team: 'all', project: 'all' },
Â  Â  Â  Â  currentView: 'dashboard',
Â  Â  Â  Â  uniqueTeams: [],
Â  Â  Â  Â  uniqueProjects: [],
Â  Â  Â  Â  uniqueAssignees: []
Â  Â  };

Â  Â  // --- 2. UTILITAIRES ---
Â  Â  const Utils = {
Â  Â  Â  Â  // Date Grist (Sec vs Days)
Â  Â  Â  Â  fromGristDate: (val) => {
Â  Â  Â  Â  Â  Â  if (!val && val !== 0) return null;
Â  Â  Â  Â  Â  Â  return val > 100000 ? new Date(val * 1000) : new Date(val * 24 * 60 * 60 * 1000);
Â  Â  Â  Â  },
Â  Â  Â  Â  toGristDate: (dateObj) => {
Â  Â  Â  Â  Â  Â  if (!dateObj) return null;
Â  Â  Â  Â  Â  Â  const utc = Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
Â  Â  Â  Â  Â  Â  return Math.floor(utc / 86400000);
Â  Â  Â  Â  },
Â  Â  Â  Â  formatDate: (d) => d ? d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) : '-',
Â  Â  Â  Â  inputDate: (d) => d ? d.toISOString().split('T')[0] : '', // Pour input type="date"
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Couleur HASH consistante
Â  Â  Â  Â  stringToColor: (str) => {
Â  Â  Â  Â  Â  Â  if (!str) return '#94a3b8';
Â  Â  Â  Â  Â  Â  let hash = 0;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
Â  Â  Â  Â  Â  Â  const h = Math.abs(hash) % 360;
Â  Â  Â  Â  Â  Â  return `hsl(${h}, 70%, 45%)`;
Â  Â  Â  Â  },

Â  Â  Â  Â  // Nettoyage donnÃ©es Table -> Liste d'objets
Â  Â  Â  Â  cleanData: (data) => {
Â  Â  Â  Â  Â  Â  if (Array.isArray(data)) return data;
Â  Â  Â  Â  Â  Â  if (!data) return [];
Â  Â  Â  Â  Â  Â  const cols = Object.keys(data);
Â  Â  Â  Â  Â  Â  if (!cols.length) return [];
Â  Â  Â  Â  Â  Â  const rows = [];
Â  Â  Â  Â  Â  Â  for(let i=0; i<data[cols[0]].length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  let rec = { id: data.id[i] };
Â  Â  Â  Â  Â  Â  Â  Â  cols.forEach(c => { if(c!=='id') rec[c] = data[c][i]; });
Â  Â  Â  Â  Â  Â  Â  Â  rows.push(rec);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return rows;
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // --- 3. INIT & EVENTS GRIST ---
Â  Â  grist.ready({ columns: MAPPING, requiredAccess: 'full' });

Â  Â  grist.onRecords(data => {
Â  Â  Â  Â  state.allRecords = Utils.cleanData(data);
Â  Â  Â  Â  extractUniqueValues();
Â  Â  Â  Â  updateFilterSelects();
Â  Â  Â  Â  handleFilters(); // DÃ©clenche le render
Â  Â  });

Â  Â  function extractUniqueValues() {
Â  Â  Â  Â  state.uniqueTeams = [...new Set(state.allRecords.map(r => r.Team).filter(Boolean))].sort();
Â  Â  Â  Â  state.uniqueProjects = [...new Set(state.allRecords.map(r => r.Project).filter(Boolean))].sort();
Â  Â  Â  Â  state.uniqueAssignees = [...new Set(state.allRecords.map(r => r.Assignee).filter(Boolean))].sort();
Â  Â  }

Â  Â  // --- 4. LOGIQUE FILTRES ---
Â  Â  function updateFilterSelects() {
Â  Â  Â  Â  // Conserve sÃ©lection user
Â  Â  Â  Â  const tVal = document.getElementById('filter-team').value;
Â  Â  Â  Â  const pVal = document.getElementById('filter-project').value;

Â  Â  Â  Â  const tSelect = document.getElementById('filter-team');
Â  Â  Â  Â  const pSelect = document.getElementById('filter-project');

Â  Â  Â  Â  tSelect.innerHTML = `<option value="all">Toutes les administrations</option>` +Â 
Â  Â  Â  Â  Â  Â  state.uniqueTeams.map(t => `<option value="${t}">${t}</option>`).join('');
Â  Â  Â  Â Â 
Â  Â  Â  Â  pSelect.innerHTML = `<option value="all">Tous les projets</option>` +Â 
Â  Â  Â  Â  Â  Â  state.uniqueProjects.map(p => `<option value="${p}">${p}</option>`).join('');

Â  Â  Â  Â  if(state.uniqueTeams.includes(tVal)) tSelect.value = tVal;
Â  Â  Â  Â  if(state.uniqueProjects.includes(pVal)) pSelect.value = pVal;
Â  Â  }

Â  Â  function handleFilters() {
Â  Â  Â  Â  state.filters.team = document.getElementById('filter-team').value;
Â  Â  Â  Â  state.filters.project = document.getElementById('filter-project').value;

Â  Â  Â  Â  state.filteredRecords = state.allRecords.filter(r => {
Â  Â  Â  Â  Â  Â  const teamOk = state.filters.team === 'all' || r.Team === state.filters.team;
Â  Â  Â  Â  Â  Â  const projOk = state.filters.project === 'all' || r.Project === state.filters.project;
Â  Â  Â  Â  Â  Â  return teamOk && projOk;
Â  Â  Â  Â  });

Â  Â  Â  Â  renderCurrentView();
Â  Â  }

Â  Â  function switchView(view) {
Â  Â  Â  Â  state.currentView = view;
Â  Â  Â  Â  // Update tabs UI
Â  Â  Â  Â  document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  document.querySelector(`.nav-item[onclick="switchView('${view}')"]`).classList.add('active');
Â  Â  Â  Â  renderCurrentView();
Â  Â  }

Â  Â  function renderCurrentView() {
Â  Â  Â  Â  const container = document.getElementById('app-content');
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  wrapper.className = 'view-container active';

Â  Â  Â  Â  if(state.currentView === 'dashboard') renderDashboard(wrapper);
Â  Â  Â  Â  else if(state.currentView === 'gantt') renderGantt(wrapper);
Â  Â  Â  Â  else renderList(wrapper);

Â  Â  Â  Â  container.appendChild(wrapper);
Â  Â  }

Â  Â  // --- 5. MOTEURS DE RENDU ---

Â  Â  /** VUE 1 : DASHBOARD **/
Â  Â  function renderDashboard(container) {
Â  Â  Â  Â  const data = state.filteredRecords;
Â  Â  Â  Â  const total = data.length;
Â  Â  Â  Â  const now = new Date();

Â  Â  Â  Â  // Stats
Â  Â  Â  Â  const done = data.filter(r => (r.Progress||0) == 100).length;
Â  Â  Â  Â  const late = data.filter(r => {
Â  Â  Â  Â  Â  Â  const end = Utils.fromGristDate(r.EndDate);
Â  Â  Â  Â  Â  Â  return end && end < now && (r.Progress||0) < 100;
Â  Â  Â  Â  }).length;
Â  Â  Â  Â  const inProgress = data.filter(r => (r.Progress||0) > 0 && (r.Progress||0) < 100).length;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const donePct = total ? Math.round((done/total)*100) : 0;

Â  Â  Â  Â  // HTML
Â  Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="dashboard-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-title">Total TÃ¢ches</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" style="color:var(--primary)">${total}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-footer">Toutes tÃ¢ches confondues</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-title">TerminÃ©es</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value text-success">${done}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-footer">${donePct}% du total</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-title">En Retard</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value text-danger">${late}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-footer">Ã€ traiter en urgence</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-title">En Cours</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-value" style="color:var(--warning)">${inProgress}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="stat-footer">Actives</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="charts-row">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin-top:0">Par PrioritÃ©</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${renderBarChart(data, 'Priority', {High: 'var(--danger)', Medium: 'var(--warning)', Low: 'var(--success)'})}
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin-top:0">Par Administration</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${renderBarChart(data, 'Team', null)}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin-top:0">Prochaines Ã‰chÃ©ances</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="mini-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${data.filter(r => r.EndDate && (r.Progress||0) < 100)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .sort((a,b) => Utils.fromGristDate(a.EndDate) - Utils.fromGristDate(b.EndDate))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .slice(0,5)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(r => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><strong>${r.Title}</strong></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:right">${Utils.formatDate(Utils.fromGristDate(r.EndDate))}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('') || '<tr><td>Aucune tÃ¢che Ã  venir</td></tr>'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  }

Â  Â  function renderBarChart(data, key, colorMap) {
Â  Â  Â  Â  const counts = {};
Â  Â  Â  Â  data.forEach(r => {Â 
Â  Â  Â  Â  Â  Â  const k = r[key] || 'Non dÃ©fini';Â 
Â  Â  Â  Â  Â  Â  counts[k] = (counts[k] || 0) + 1;Â 
Â  Â  Â  Â  });
Â  Â  Â  Â  const max = Math.max(...Object.values(counts), 1);
Â  Â  Â  Â Â 
Â  Â  Â  Â  return Object.keys(counts).map(k => {
Â  Â  Â  Â  Â  Â  const count = counts[k];
Â  Â  Â  Â  Â  Â  const pct = (count / max) * 100;
Â  Â  Â  Â  Â  Â  const color = colorMap ? (colorMap[k] || '#ccc') : Utils.stringToColor(k);
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bar-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bar-label"><span>${k}</span> <span>${count}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bar-bg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bar-fill" style="width:${pct}%; background:${color}"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }).join('');
Â  Â  }

Â  Â  /** VUE 2 : GANTT **/
Â  Â  function renderGantt(container) {
Â  Â  Â  Â  const tasks = state.filteredRecords
Â  Â  Â  Â  Â  Â  .filter(r => r.StartDate && r.EndDate)
Â  Â  Â  Â  Â  Â  .map(r => ({...r, start: Utils.fromGristDate(r.StartDate), end: Utils.fromGristDate(r.EndDate)}))
Â  Â  Â  Â  Â  Â  .sort((a,b) => a.start - b.start);

Â  Â  Â  Â  if (!tasks.length) { container.innerHTML = '<div style="text-align:center; padding:40px; color:#999">Aucune tÃ¢che avec dates.</div>'; return; }

Â  Â  Â  Â  let min = new Date(Math.min(...tasks.map(t => t.start))).getTime();
Â  Â  Â  Â  let max = new Date(Math.max(...tasks.map(t => t.end))).getTime();
Â  Â  Â  Â  const padding = 86400000 * 2; // +2 jours marge
Â  Â  Â  Â  min -= padding; max += padding;
Â  Â  Â  Â  const span = max - min;

Â  Â  Â  Â  let html = `
Â  Â  Â  Â  Â  Â  <div class="gantt-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="gantt-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>TÃ¢che</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="text-align:right">PÃ©riode: ${Utils.formatDate(new Date(min))} - ${Utils.formatDate(new Date(max))}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  tasks.forEach(t => {
Â  Â  Â  Â  Â  Â  const left = ((t.start.getTime() - min) / span) * 100;
Â  Â  Â  Â  Â  Â  const width = Math.max(((t.end.getTime() - t.start.getTime()) / span) * 100, 1);
Â  Â  Â  Â  Â  Â  const color = t.Project ? Utils.stringToColor(t.Project) : '#cbd5e1';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="gantt-line" onclick="openModal(${t.id})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gantt-text" title="${t.Title}">${t.Title}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gantt-timeline">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="gantt-block" style="left:${left}%; width:${width}%; background:${color}" title="${t.Title} (${t.Progress}%)"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  container.innerHTML = html;
Â  Â  }

Â  Â  /** VUE 3 : LISTE **/
Â  Â  function renderList(container) {
Â  Â  Â  Â  const listDiv = document.createElement('div');
Â  Â  Â  Â  listDiv.className = 'task-list';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!state.filteredRecords.length) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<div style="text-align:center; padding:40px; color:#999">Aucune tÃ¢che trouvÃ©e.</div>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  state.filteredRecords.forEach(r => {
Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  // Classe de prioritÃ© pour la couleur bordure gauche
Â  Â  Â  Â  Â  Â  const prioClass = r.Priority ? `priority-${r.Priority.toLowerCase()}` : '';
Â  Â  Â  Â  Â  Â  card.className = `task-card ${prioClass}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Clic carte -> Edit Modal
Â  Â  Â  Â  Â  Â  card.onclick = () => openModal(r.id);

Â  Â  Â  Â  Â  Â  const badges = [];
Â  Â  Â  Â  Â  Â  if(r.Team) badges.push({t: r.Team, c: Utils.stringToColor(r.Team)});
Â  Â  Â  Â  Â  Â  if(r.Project) badges.push({t: r.Project, c: Utils.stringToColor(r.Project)});

Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-top">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="card-h3">${r.Title || 'Sans Titre'}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${r.Priority ? `<span style="font-size:10px; font-weight:700; color:#666">${r.Priority}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-tags">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${badges.map(b => `<span class="tag" style="background:${b.c}">${b.t}</span>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-btm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="avatar-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ðŸ‘¤ ${r.Assignee || 'Non assignÃ©'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; align-items:center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ðŸ“… ${Utils.formatDate(Utils.fromGristDate(r.EndDate))}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${r.Progress !== undefined ? `<strong>${r.Progress}%</strong>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  listDiv.appendChild(card);
Â  Â  Â  Â  });
Â  Â  Â  Â  container.appendChild(listDiv);
Â  Â  }

Â  Â  // --- 6. GESTION MODALE (CRUD COMPLET) ---
Â  Â Â 
Â  Â  // Remplit les datalists (AutocomplÃ©tion crÃ©ative)
Â  Â  function populateDatalists() {
Â  Â  Â  Â  const fill = (id, list) => {
Â  Â  Â  Â  Â  Â  document.getElementById(id).innerHTML = list.map(v => `<option value="${v}">`).join('');
Â  Â  Â  Â  };
Â  Â  Â  Â  fill('list-teams', state.uniqueTeams);
Â  Â  Â  Â  fill('list-projects', state.uniqueProjects);
Â  Â  Â  Â  fill('list-assignees', state.uniqueAssignees);
Â  Â  }

Â  Â  function openModal(recordId = null) {
Â  Â  Â  Â  populateDatalists(); // RafraÃ®chir les listes
Â  Â  Â  Â Â 
Â  Â  Â  Â  const modal = document.getElementById('modal');
Â  Â  Â  Â  const title = document.getElementById('modal-title');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Reset Form
Â  Â  Â  Â  document.getElementById('input-id').value = '';
Â  Â  Â  Â  document.getElementById('input-title').value = '';
Â  Â  Â  Â  document.getElementById('input-team').value = '';
Â  Â  Â  Â  document.getElementById('input-project').value = '';
Â  Â  Â  Â  document.getElementById('input-assignee').value = '';
Â  Â  Â  Â  document.getElementById('input-priority').value = 'Medium';
Â  Â  Â  Â  document.getElementById('input-start').value = '';
Â  Â  Â  Â  document.getElementById('input-end').value = '';
Â  Â  Â  Â  document.getElementById('input-progress').value = 0;
Â  Â  Â  Â  document.getElementById('range-progress').value = 0;

Â  Â  Â  Â  if (recordId) {
Â  Â  Â  Â  Â  Â  // MODE EDITION
Â  Â  Â  Â  Â  Â  const r = state.allRecords.find(x => x.id === recordId);
Â  Â  Â  Â  Â  Â  if (r) {
Â  Â  Â  Â  Â  Â  Â  Â  title.innerText = "Modifier la TÃ¢che";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('input-id').value = r.id;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('input-title').value = r.Title || '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('input-team').value = r.Team || '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('input-project').value = r.Project || '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('input-assignee').value = r.Assignee || '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('input-priority').value = r.Priority || 'Medium';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('input-start').value = Utils.inputDate(Utils.fromGristDate(r.StartDate));
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('input-end').value = Utils.inputDate(Utils.fromGristDate(r.EndDate));
Â  Â  Â  Â  Â  Â  Â  Â  const prog = r.Progress || 0;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('input-progress').value = prog;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('range-progress').value = prog;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // SÃ©lectionner aussi dans Grist pour le focus
Â  Â  Â  Â  Â  Â  Â  Â  grist.setSelectedRows([r.id]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // MODE CREATION
Â  Â  Â  Â  Â  Â  title.innerText = "Nouvelle TÃ¢che";
Â  Â  Â  Â  Â  Â  // PrÃ©-remplir avec les filtres actuels s'ils sont actifs
Â  Â  Â  Â  Â  Â  if (state.filters.team !== 'all') document.getElementById('input-team').value = state.filters.team;
Â  Â  Â  Â  Â  Â  if (state.filters.project !== 'all') document.getElementById('input-project').value = state.filters.project;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Dates par dÃ©faut (Aujourd'hui)
Â  Â  Â  Â  Â  Â  const today = Utils.inputDate(new Date());
Â  Â  Â  Â  Â  Â  document.getElementById('input-start').value = today;
Â  Â  Â  Â  Â  Â  document.getElementById('input-end').value = today;
Â  Â  Â  Â  }

Â  Â  Â  Â  modal.classList.add('open');
Â  Â  }

Â  Â  function closeModal() {
Â  Â  Â  Â  document.getElementById('modal').classList.remove('open');
Â  Â  }

Â  Â  async function saveTask() {
Â  Â  Â  Â  const id = document.getElementById('input-id').value; // String, vide si crÃ©ation
Â  Â  Â  Â Â 
Â  Â  Â  Â  // RÃ©cupÃ©ration des valeurs
Â  Â  Â  Â  // Note: Pour les champs Choice (Team, Project), Grist acceptera la nouvelle valeur texte
Â  Â  Â  Â  // si la colonne est configurÃ©e pour, ou si c'est une colonne Texte simple.
Â  Â  Â  Â  const fields = {
Â  Â  Â  Â  Â  Â  Title: document.getElementById('input-title').value || 'Nouvelle TÃ¢che',
Â  Â  Â  Â  Â  Â  Team: document.getElementById('input-team').value,
Â  Â  Â  Â  Â  Â  Project: document.getElementById('input-project').value,
Â  Â  Â  Â  Â  Â  Assignee: document.getElementById('input-assignee').value,
Â  Â  Â  Â  Â  Â  Priority: document.getElementById('input-priority').value,
Â  Â  Â  Â  Â  Â  StartDate: Utils.toGristDate(new Date(document.getElementById('input-start').value)),
Â  Â  Â  Â  Â  Â  EndDate: Utils.toGristDate(new Date(document.getElementById('input-end').value)),
Â  Â  Â  Â  Â  Â  Progress: parseInt(document.getElementById('input-progress').value) || 0
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (id) {
Â  Â  Â  Â  Â  Â  Â  Â  // UPDATE
Â  Â  Â  Â  Â  Â  Â  Â  await grist.selectedTable.update({ id: parseInt(id), fields });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // CREATE
Â  Â  Â  Â  Â  Â  Â  Â  await grist.selectedTable.create({ fields });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  alert("Erreur lors de la sauvegarde. VÃ©rifiez les droits d'accÃ¨s ou les noms de colonnes.");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Synchro Range/Number pour le slider de progression
Â  Â  document.getElementById('input-progress').addEventListener('input', function() {
Â  Â  Â  Â  document.getElementById('range-progress').value = this.value;
Â  Â  });
</script>
</body>
</html>
