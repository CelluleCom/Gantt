<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cockpit Projets - État</title>
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
   
    <style>
        /* --- 1. DESIGN SYSTEM DE L'ÉTAT (Inspiration DSFR) --- */
        :root {
            --blue-france: #000091;
            --red-marianne: #E1000F;
            --green-emeraude: #008941;
            --grey-100: #f5f5fe;
            --grey-200: #e3e3fd;
            --text-default: #161616;
            --text-mention: #666666;
            --background: #f6f6f6;
            --surface: #ffffff;
            --border: #dddddd;
           
            /* Gantt Colors */
            --gantt-blue: #000091;
            --gantt-red: #E1000F;
            --gantt-orange: #f97316;
            --gantt-green: #008941;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text-default);
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* --- HEADER --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            padding: 16px 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border-bottom: 2px solid var(--blue-france); /* Marqueur État */
            margin-bottom: 24px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            font-weight: 900;
            font-size: 1.2rem;
            line-height: 1.1;
            color: var(--text-default);
        }

        .brand-logo span { color: var(--blue-france); }

        .app-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-default);
            padding-left: 12px;
            border-left: 1px solid var(--border);
        }

        .sync-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: var(--grey-100);
            color: var(--blue-france);
            font-weight: 600;
            border-radius: 4px;
        }

        /* --- FILTERS & NAV --- */
        .toolbar-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-group {
            display: flex;
            background: var(--surface);
            border: 1px solid var(--border);
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-mention);
            border-right: 1px solid var(--border);
            transition: 0.2s;
        }
        .nav-btn:last-child { border-right: none; }
        .nav-btn:hover { background: var(--grey-100); color: var(--blue-france); }
        .nav-btn.active {
            background: var(--blue-france);
            color: white;
        }

        .filters-group {
            display: flex;
            gap: 10px;
            flex: 1;
        }
       
        select {
            padding: 10px;
            border: 1px solid var(--text-default); /* Bordure contrastée */
            background: var(--surface);
            min-width: 150px;
            cursor: pointer;
        }

        .btn-action {
            background: var(--blue-france);
            color: white;
            padding: 10px 24px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 0 0 #000060; /* Effet bouton État */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-action:active { transform: translateY(2px); box-shadow: 0 2px 0 0 #000060; }

        /* --- MAIN CONTENT --- */
        .content-area {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .view-section {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        .view-section.active { display: block; }

        /* --- KPI --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        .kpi-card {
            padding: 24px;
            background: var(--background);
            border-left: 4px solid var(--blue-france);
        }
        .kpi-card.alert { border-color: var(--red-marianne); }
       
        .kpi-val { font-size: 2rem; font-weight: 700; line-height: 1; margin-bottom: 8px; }
        .kpi-lbl { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; color: var(--text-mention); }

        /* --- TABLE --- */
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th {
            padding: 12px 16px;
            background: var(--background);
            color: var(--text-default);
            font-weight: 700;
            border-bottom: 2px solid var(--text-default);
            font-size: 0.9rem;
        }
        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
        }
        tr:hover td { background: var(--grey-100); cursor: pointer; }

        .badge-team {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-mention);
            background: var(--border);
            padding: 2px 6px;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-project {
            background: var(--grey-200);
            color: var(--blue-france);
            padding: 4px 8px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* --- GANTT OVERRIDES --- */
        .gantt-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .bar-critique .bar { fill: var(--gantt-red) !important; }
        .bar-haute .bar { fill: var(--gantt-orange) !important; }
        .bar-moyenne .bar { fill: var(--gantt-blue) !important; }
        .bar-termine .bar { fill: var(--gantt-green) !important; }
       
        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            display: none; justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-box {
            background: var(--surface);
            width: 500px; max-width: 95%;
            padding: 32px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border-top: 4px solid var(--blue-france);
        }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%; padding: 12px;
            border: 1px solid var(--text-mention);
            background: var(--surface);
            box-sizing: border-box;
            font-size: 1rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--blue-france);
            border-color: transparent;
        }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .app-title { border-left: none; padding-left: 0; }
            .toolbar-container { flex-direction: column; align-items: stretch; }
            .filters-group { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
            .nav-group { width: 100%; }
            .nav-btn { flex: 1; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="brand">
            <div class="brand-logo">RÉPUBLIQUE<br><span>FRANÇAISE</span></div>
            <div class="app-title">Cockpit Projets <span id="syncStatus" class="sync-badge">Chargement...</span></div>
        </div>
        <button class="btn-action" onclick="openModal()">+ Nouvelle Tâche</button>
    </header>

    <div class="toolbar-container">
        <div class="nav-group">
            <button class="nav-btn active" onclick="switchView('dashboard', this)">Tableau de Bord</button>
            <button class="nav-btn" onclick="switchView('gantt', this)">Planning Gantt</button>
        </div>
       
        <div class="filters-group">
            <select id="filterProject" onchange="applyFilters()">
                <option value="">Tous les Projets</option>
            </select>
            <select id="filterAgent" onchange="applyFilters()">
                <option value="">Tous les Agents</option>
            </select>
        </div>
    </div>

    <div class="content-area">
       
        <div id="view-dashboard" class="view-section active">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-val" id="kpi-total">0</div>
                    <div class="kpi-lbl">Total Tâches</div>
                </div>
                <div class="kpi-card alert">
                    <div class="kpi-val" style="color: var(--red-marianne);" id="kpi-retard">0</div>
                    <div class="kpi-lbl">En Retard</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-val" style="color: var(--green-emeraude);" id="kpi-progress">0%</div>
                    <div class="kpi-lbl">Avancement Global</div>
                </div>
            </div>

            <h3 style="margin-bottom: 20px;">Tâches en cours</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Projet</th>
                            <th>Responsable</th>
                            <th>Échéance</th>
                            <th>Avancement</th>
                        </tr>
                    </thead>
                    <tbody id="taskListBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="view-gantt" class="view-section">
            <div style="margin-bottom: 20px; display:flex; gap:10px;">
                <span style="font-weight:700; align-self:center;">Zoom :</span>
                <button class="nav-btn" style="border:1px solid #ddd" onclick="ganttChart.change_view_mode('Day')">Jour</button>
                <button class="nav-btn" style="border:1px solid #ddd" onclick="ganttChart.change_view_mode('Week')">Semaine</button>
                <button class="nav-btn" style="border:1px solid #ddd" onclick="ganttChart.change_view_mode('Month')">Mois</button>
            </div>
            <div id="gantt-chart" class="gantt-container"></div>
        </div>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:24px;">
                <h2 style="margin:0; color:var(--blue-france);" id="modalTitle">Nouvelle Tâche</h2>
                <button style="background:none; border:none; font-size:1.5rem; cursor:pointer;" onclick="closeModal()">✕</button>
            </div>
           
            <form id="taskForm">
                <input type="hidden" id="inpId">
               
                <div style="margin-bottom:20px;">
                    <label>Titre de la tâche</label>
                    <input type="text" id="inpTitle" required placeholder="Ex: Rédaction du cahier des charges...">
                </div>

                <div class="form-grid">
                    <div>
                        <label>Projet</label>
                        <select id="inpProject" required><option value="">Chargement...</option></select>
                    </div>
                    <div>
                        <label>Responsable</label>
                        <select id="inpAgent"><option value="">Chargement...</option></select>
                    </div>
                </div>

                <div class="form-grid">
                    <div><label>Date de début</label><input type="date" id="inpStart" required></div>
                    <div><label>Date de fin</label><input type="date" id="inpEnd" required></div>
                </div>

                <div class="form-grid">
                    <div><label>Avancement (%)</label><input type="number" id="inpProgress" min="0" max="100" value="0"></div>
                    <div>
                        <label>Priorité</label>
                        <select id="inpPriority">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                </div>

                <div style="text-align:right; margin-top:30px;">
                    <button type="button" class="nav-btn" style="margin-right:10px;" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn-action">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <script>
        // --- A. CONFIGURATION (Identifiants des Tables Grist) ---
        const DB = {
            TASKS: 'TACHES_MASTER',
            AGENTS: 'AGENTS',
            PROJECTS: 'PROJETS',
            TEAMS: 'EQUIPES'
        };

        // État de l'application
        let appData = { tasks: [], agents: [], projects: [], teams: [] };
        let ganttChart = null;

        // --- B. INITIALISATION ---
        grist.ready({ requiredAccess: 'full' });

        // Écouteur principal : Se déclenche quand Grist change
        grist.onRecords(async function() {
            updateSyncStatus("Synchronisation...", true);
            await loadAllData();
            updateSyncStatus("Données à jour", false);
        });

        // --- C. CHARGEMENT & JOINTURES (BACKEND LOGIC) ---
        async function loadAllData() {
            try {
                // Chargement parallèle pour la performance
                const [rawTasks, rawAgents, rawProjects, rawTeams] = await Promise.all([
                    grist.docApi.fetchTable(DB.TASKS),
                    grist.docApi.fetchTable(DB.AGENTS),
                    grist.docApi.fetchTable(DB.PROJECTS),
                    grist.docApi.fetchTable(DB.TEAMS)
                ]);

                // 1. Traitement Équipes
                appData.teams = convertTable(rawTeams).map(r => ({
                    id: r.id,
                    name: r.Nom || r.Nom_Equipe || "Équipe"
                }));

                // 2. Traitement Agents (Jointure avec Équipe)
                appData.agents = convertTable(rawAgents).map(r => {
                    const team = appData.teams.find(t => t.id === r.Equipe) || { name: '' };
                    return {
                        id: r.id,
                        name: r.Nom_Complet || r.Nom,
                        teamName: team.name
                    };
                });

                // 3. Traitement Projets
                appData.projects = convertTable(rawProjects).map(r => ({
                    id: r.id,
                    name: r.Nom_Projet || r.Nom
                }));
               
                // 4. Traitement Tâches (Jointure avec Agent & Projet)
                const tasksObj = convertTable(rawTasks);
                appData.tasks = tasksObj.map(t => {
                    const agent = appData.agents.find(a => a.id === t.Responsable) || { name: 'Non assigné', teamName: '' };
                    const project = appData.projects.find(p => p.id === t.Projet) || { name: 'Aucun' };
                   
                    // Logique métier : Retard & Couleurs
                    const isLate = new Date(t.Date_Fin) < new Date() && t.Avancement < 100;
                    let color = 'bar-moyenne';
                    if(t.Avancement === 100) color = 'bar-termine';
                    else if(t.Priorite === 'Critique' || isLate) color = 'bar-critique';
                    else if(t.Priorite === 'Haute') color = 'bar-haute';

                    return {
                        ...t, // Garde les champs bruts
                        id: t.id.toString(),
                        displayAgent: agent.name,
                        displayTeam: agent.teamName,
                        displayProject: project.name,
                        // Format Gantt obligatoire
                        name: t.Titre,
                        start: formatDateIso(t.Date_Debut),
                        end: formatDateIso(t.Date_Fin),
                        progress: t.Avancement || 0,
                        dependencies: t.Dependances || "",
                        custom_class: color
                    };
                });

                refreshUI();

            } catch (e) {
                console.error(e);
                updateSyncStatus("Erreur ID Tables", true);
            }
        }

        // --- D. GESTION DE L'INTERFACE (FRONTEND) ---
        function refreshUI() {
            populateSelects(); // Met à jour les menus déroulants
            applyFilters();    // Lance le rendu (Dashboard + Gantt)
        }

        function applyFilters() {
            const fProj = document.getElementById('filterProject').value;
            const fAgent = document.getElementById('filterAgent').value;

            // Filtrage côté client
            const filtered = appData.tasks.filter(t => {
                const matchP = fProj === "" || t.Projet == fProj;
                const matchA = fAgent === "" || t.Responsable == fAgent;
                return matchP && matchA;
            });

            renderDashboard(filtered);
            renderGantt(filtered);
        }

        function renderDashboard(tasks) {
            // 1. Calcul des KPIs
            const total = tasks.length;
            const retard = tasks.filter(t => new Date(t.end) < new Date() && t.progress < 100).length;
            const avg = total ? Math.round(tasks.reduce((a,b)=>a+b.progress,0)/total) : 0;
           
            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-retard').innerText = retard;
            document.getElementById('kpi-progress').innerText = avg + "%";

            // 2. Génération du Tableau HTML
            const tbody = document.getElementById('taskListBody');
            tbody.innerHTML = "";
           
            if(tasks.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px'>Aucune tâche trouvée</td></tr>";
                return;
            }

            tasks.forEach(t => {
                const teamBadge = t.displayTeam ? `<span class="badge-team">${t.displayTeam}</span>` : '';
                const tr = document.createElement('tr');
                tr.onclick = () => openModal(t);
               
                tr.innerHTML = `
                    <td style="font-weight:600">${t.Titre}</td>
                    <td><span class="badge-project">${t.displayProject}</span></td>
                    <td>${t.displayAgent} ${teamBadge}</td>
                    <td>${t.end}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="flex:1; background:#eee; height:8px; border-radius:4px;">
                                <div style="width:${t.progress}%; background:${t.progress===100?'var(--green-emeraude)':'var(--blue-france)'}; height:100%; border-radius:4px;"></div>
                            </div>
                            <span style="font-size:0.8rem; font-weight:600">${t.progress}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderGantt(tasks) {
            const container = document.getElementById("gantt-chart");
            container.innerHTML = "";
           
            if(tasks.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; padding:40px'>Aucune tâche à afficher dans le planning.</p>";
                return;
            }

            ganttChart = new Gantt("#gantt-chart", tasks, {
                header_height: 50,
                column_width: 30,
                step: 24,
                view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                bar_height: 25,
                bar_corner_radius: 3,
                arrow_curve: 5,
                padding: 18,
                view_mode: 'Week',
                date_format: 'YYYY-MM-DD',
                language: 'fr',
                on_click: task => openModal(task),
                on_date_change: (task, start, end) => {
                    saveAction('UpdateRecord', task.id, { Date_Debut: formatDateIso(start), Date_Fin: formatDateIso(end) });
                },
                on_progress_change: (task, progress) => {
                    saveAction('UpdateRecord', task.id, { Avancement: progress });
                }
            });
        }

        // --- E. ACTIONS UTILISATEUR (SAVE) ---
        async function saveAction(action, rowId, fields) {
            updateSyncStatus("Sauvegarde...", true);
            const args = action === 'AddRecord' ? [null, fields] : [parseInt(rowId), fields];
           
            try {
                await grist.docApi.applyUserActions([[action, DB.TASKS, ...args]]);
                // La mise à jour UI se fera via le listener onRecords
            } catch (e) {
                alert("Erreur lors de la sauvegarde : " + e.message);
                updateSyncStatus("Erreur Sauvegarde", true);
            }
        }

        // Gestion du Formulaire Modal
        const modal = document.getElementById('taskModal');

        function openModal(task = null) {
            const form = document.getElementById('taskForm');
            if(task) {
                // Mode Édition
                document.getElementById('modalTitle').innerText = "Modifier la tâche";
                document.getElementById('inpId').value = task.id;
                document.getElementById('inpTitle').value = task.Titre;
                document.getElementById('inpProject').value = task.Projet;
                document.getElementById('inpAgent').value = task.Responsable;
                document.getElementById('inpStart').value = task.start;
                document.getElementById('inpEnd').value = task.end;
                document.getElementById('inpProgress').value = task.progress;
                document.getElementById('inpPriority').value = task.Priorite;
            } else {
                // Mode Création
                form.reset();
                document.getElementById('modalTitle').innerText = "Nouvelle Tâche";
                document.getElementById('inpId').value = "";
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('inpStart').value = today;
                document.getElementById('inpEnd').value = today;
            }
            modal.style.display = 'flex';
        }

        function closeModal() { modal.style.display = 'none'; }

        document.getElementById('taskForm').onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('inpId').value;
           
            const data = {
                Titre: document.getElementById('inpTitle').value,
                Projet: parseInt(document.getElementById('inpProject').value),
                Responsable: parseInt(document.getElementById('inpAgent').value),
                Date_Debut: document.getElementById('inpStart').value,
                Date_Fin: document.getElementById('inpEnd').value,
                Avancement: parseInt(document.getElementById('inpProgress').value),
                Priorite: document.getElementById('inpPriority').value
            };
           
            saveAction(id ? 'UpdateRecord' : 'AddRecord', id, data);
            closeModal();
        };

        // --- F. UTILITAIRES ---
        function populateSelects() {
            // Remplit les selects de filtres ET du formulaire en même temps
            const fill = (selector, list) => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    const currentVal = el.value;
                    // Garde la première option (ex: "Tous les...")
                    const firstOption = el.options[0];
                    el.innerHTML = "";
                    el.appendChild(firstOption);
                   
                    list.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.id;
                        opt.innerText = item.name;
                        el.appendChild(opt);
                    });
                    el.value = currentVal;
                });
            };
            fill('#filterProject, #inpProject', appData.projects);
            fill('#filterAgent, #inpAgent', appData.agents);
        }

        function convertTable(tableData) {
            const keys = Object.keys(tableData);
            if(keys.length === 0) return [];
            const len = tableData.id.length;
            const res = [];
            for(let i=0; i<len; i++) {
                let obj = {};
                keys.forEach(k => obj[k] = tableData[k][i]);
                res.push(obj);
            }
            return res;
        }

        function formatDateIso(val) {
            if(!val) return new Date().toISOString().split('T')[0];
            const d = typeof val === 'number' ? new Date(val * 1000) : new Date(val);
            return d.toISOString().split('T')[0];
        }

        function switchView(viewId, btn) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
           
            document.getElementById('view-' + viewId).classList.add('active');
            btn.classList.add('active');
           
            // Hack pour forcer le redessin correct du SVG Gantt quand il devient visible
            if(viewId === 'gantt' && ganttChart) {
                setTimeout(() => ganttChart.refresh(appData.tasks), 50);
            }
        }
       
        function updateSyncStatus(msg, isLoading) {
            const badge = document.getElementById('syncStatus');
            badge.innerText = msg;
            badge.style.opacity = isLoading ? 0.6 : 1;
        }

        // Fermeture modal au clic extérieur
        window.onclick = function(e) { if(e.target == modal) closeModal(); }
    </script>
</body>
</html>
