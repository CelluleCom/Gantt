<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt'FIP Ultimate v11 (Fix Save & Dropdowns)</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        /* --- 1. DESIGN SYSTEM (STRICTEMENT IDENTIQUE) --- */
        :root {
            --primary: var(--grist-theme-cursor, #2563eb);
            --bg: var(--grist-theme-page-bg, #f8fafc);
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sec: #64748b;
            --border: #e2e8f0;
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --black: #000000;

            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; padding-bottom: 80px; user-select: none; font-size: 14px; }

        /* HEADER & NAV */
        .app-header { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1.app-logo { font-size: 22px; font-weight: 800; margin: 0; background: linear-gradient(135deg, var(--primary), #4f46e5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .nav-pills { display: flex; background: #e2e8f0; padding: 4px; border-radius: var(--radius-lg); width: fit-content; gap: 4px; }
        .nav-item { padding: 8px 20px; border-radius: var(--radius-md); border: none; background: transparent; color: var(--text-sec); font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .nav-item.active { background: var(--surface); color: var(--text-main); box-shadow: var(--shadow-sm); }

        /* TOOLBAR & BUTTONS */
        .toolbar { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 20px; align-items: center; position: relative; z-index: 50; }
        .select-modern { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--surface); }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary:active { transform: scale(0.98); }
        
        .fab-print { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--text-main); color: white; border-radius: 50%; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 999; }

        /* VUES */
        .view-container { display: none; }
        .view-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); }
        .stat-title { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-sec); }
        .stat-value { font-size: 32px; font-weight: 800; margin: 8px 0; }
        .stat-footer { font-size: 12px; color: var(--text-sec); }
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: var(--surface); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); }
        .bar-group { margin-bottom: 10px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
        .bar-bg { height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 4px; }

        /* GANTT */
        .gantt-wrapper { background: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border); overflow-x: auto; position: relative; min-height: 400px; }
        .gantt-header-row { display: flex; border-bottom: 1px solid var(--border); height: 45px; position: sticky; top: 0; background: var(--surface); z-index: 20; }
        .gantt-sidebar-title { width: 200px; flex-shrink: 0; padding: 10px; font-weight: bold; border-right: 1px solid var(--border); background: #f8fafc; font-size: 12px; display: flex; align-items: center; }
        .gantt-timeline-header { flex-grow: 1; position: relative; }
        .gantt-body { position: relative; }
        
        .gantt-group-header { background: #f1f5f9; padding: 8px 12px; font-weight: 700; font-size: 12px; border-bottom: 1px solid var(--border); border-top: 1px solid var(--border); color: var(--text-main); position: sticky; left: 0; width: 100%; z-index: 15; }
        .gantt-row { display: flex; height: 36px; border-bottom: 1px solid #f1f5f9; align-items: center; position: relative; }
        .gantt-row-label { width: 200px; flex-shrink: 0; padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; border-right: 1px solid var(--border); background: var(--surface); position: sticky; left: 0; z-index: 10; height: 100%; display: flex; align-items: center; cursor: pointer; }
        .gantt-row-track { flex-grow: 1; position: relative; height: 100%; }
        
        .gantt-block { position: absolute; top: 8px; height: 20px; border-radius: 4px; min-width: 8px; cursor: grab; z-index: 5; font-size: 10px; color: white; display: flex; align-items: center; padding-left: 5px; white-space: nowrap; overflow: hidden; }
        .gantt-block:active { cursor: grabbing; z-index: 20; }

        /* CORRECTIF : TRAIT ROUGE Z-INDEX */
        .today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: red; z-index: 40; pointer-events: none; }
        .today-label { position: absolute; top: -20px; left: -20px; background: red; color: white; padding: 2px 4px; font-size: 10px; border-radius: 3px; white-space: nowrap; }

        /* LISTE */
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-card { background: var(--surface); padding: 16px; border-radius: var(--radius-md); border: 1px solid var(--border); border-left-width: 4px; cursor: pointer; transition: transform 0.1s; }
        .task-card:hover { transform: translateY(-2px); border-color: var(--primary); }
        .priority-high { border-left-color: var(--danger); }
        .priority-normal { border-left-color: var(--warning); }
        .priority-low { border-left-color: var(--success); }
        .card-top { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-btm { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sec); }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 12px; color: white; font-weight: 600; margin-right: 5px; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 999; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: var(--surface); width: 100%; max-width: 500px; border-radius: var(--radius-lg); box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: var(--text-sec); }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-md); }
        
        .input-row-plus { display: flex; gap: 8px; }
        .btn-plus { width: 38px; border: 1px solid var(--border); background: #f1f5f9; border-radius: var(--radius-md); cursor: pointer; color: var(--primary); font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .btn-sec { background: white; border: 1px solid var(--border); padding: 10px 20px; border-radius: var(--radius-md); cursor: pointer; }

        @media print {
            .app-header, .toolbar, .fab-print, .modal-overlay { display: none !important; }
            .view-container { display: block !important; }
            .gantt-wrapper { overflow: visible; border: none; }
            @page { size: landscape; margin: 1cm; }
        }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="header-top">
            <h1 class="app-logo">Gantt'FIP</h1>
            <button type="button" class="btn-primary" onclick="window.openModal()">+ Nouvelle T√¢che</button>
        </div>
        <nav class="nav-pills">
            <button type="button" class="nav-item active" onclick="window.switchView('dashboard')">Tableau de Bord</button>
            <button type="button" class="nav-item" onclick="window.switchView('gantt')">Gantt</button>
            <button type="button" class="nav-item" onclick="window.switchView('list')">Liste</button>
        </nav>
    </div>

    <div id="main-toolbar" class="toolbar" style="display:none">
        <select id="filter-project" class="select-modern" onchange="window.handleFilters()"><option value="all">Tous les projets</option></select>
        <select id="filter-team" class="select-modern" onchange="window.handleFilters()"><option value="all">Toutes les administrations</option></select>
        <select id="filter-assignee" class="select-modern" onchange="window.handleFilters()"><option value="all">Tous les responsables</option></select>
        <select id="gantt-scale" class="select-modern" style="display:none" onchange="window.changeGanttScale(this.value)">
            <option value="day">Vue: Jour</option>
            <option value="week">Vue: Semaine</option>
            <option value="month">Vue: Mois</option>
        </select>
    </div>

    <button type="button" class="fab-print" onclick="window.print()">üñ®Ô∏è</button>

    <div id="app-content">
        <div style="text-align:center; margin-top:50px; color:#999">Chargement des donn√©es...</div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 style="margin:0">Nouvelle T√¢che</h3>
                <button type="button" class="close-btn" style="border:none;background:none;font-size:20px;cursor:pointer" onclick="window.closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="input-id">
                
                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" id="input-title" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">Projet</label>
                    <div class="input-row-plus">
                        <input list="list-projects" id="input-project" class="form-input" placeholder="S√©lectionner ou √©crire...">
                        <button type="button" class="btn-plus" onclick="window.addItem('input-project')">+</button>
                    </div>
                    <datalist id="list-projects"></datalist>
                </div>

                <div class="form-group">
                    <label class="form-label">Administration</label>
                    <div class="input-row-plus">
                        <input list="list-teams" id="input-team" class="form-input" placeholder="S√©lectionner ou √©crire...">
                        <button type="button" class="btn-plus" onclick="window.addItem('input-team')">+</button>
                    </div>
                    <datalist id="list-teams"></datalist>
                </div>

                <div class="form-group">
                    <label class="form-label">Responsable</label>
                    <div class="input-row-plus">
                        <input list="list-assignees" id="input-assignee" class="form-input" placeholder="Qui est en charge ?">
                        <button type="button" class="btn-plus" onclick="window.addItem('input-assignee')">+</button>
                    </div>
                    <datalist id="list-assignees"></datalist>
                </div>

                <div class="form-group">
                    <label class="form-label">Priorit√©</label>
                    <select id="input-priority" class="form-input">
                        <option value="Normal">Normale</option>
                        <option value="High">Haute</option>
                        <option value="Low">Basse</option>
                    </select>
                </div>

                <div style="display:flex; gap:10px">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">D√©but</label>
                        <input type="date" id="input-start" class="form-input">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Fin</label>
                        <input type="date" id="input-end" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Progression (%)</label>
                    <input type="range" id="input-progress" min="0" max="100" value="0" style="width:100%">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-sec" onclick="window.closeModal()">Annuler</button>
                <button type="button" class="btn-primary" onclick="window.saveTask()">Enregistrer</button>
            </div>
        </div>
    </div>

<script>
    /** GANTT'FIP ULTIMATE V11 **/

    const MAPPING = [
        { name: 'Title',     title: 'Titre' },
        { name: 'Assignee',  title: 'Responsable' },
        { name: 'Team',      title: 'Administration' },
        { name: 'Project',   title: 'Projet' },
        { name: 'StartDate', title: 'D√©but', type: 'Date' },
        { name: 'EndDate',   title: 'Fin',   type: 'Date' },
        { name: 'Progress',  title: 'Progression', type: 'Numeric' },
        { name: 'Priority',  title: 'Priorit√©', type: 'Choice' }
    ];

    let state = {
        allRecords: [], filteredRecords: [],
        filters: { team: 'all', project: 'all', assignee: 'all' },
        currentView: 'dashboard', ganttScale: 'day',
        uniqueTeams: [], uniqueProjects: [], uniqueAssignees: []
    };

    let dragState = { isDragging: false, element: null, recordId: null, startX: 0, initialLeft: 0, pxPerDay: 0, minTime: 0, hasMoved: false };

    // --- UTILS ---
    const Utils = {
        fromGristDate: (val) => (!val && val !== 0) ? null : (val > 100000 ? new Date(val * 1000) : new Date(val * 24 * 60 * 60 * 1000)),
        toGristDate: (d) => d ? Math.floor(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()) / 86400000) : null,
        formatDate: (d) => d ? d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) : '-',
        inputDate: (d) => d ? d.toISOString().split('T')[0] : '', 
        stringToColor: (str) => {
            if (!str) return '#ccc';
            let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 65%, 45%)`;
        },
        cleanData: (data) => {
            if (!data) return [];
            const cols = Object.keys(data);
            if (!cols.length) return [];
            const rows = [];
            for(let i=0; i<data[cols[0]].length; i++) {
                let rec = { id: data.id[i] };
                cols.forEach(c => { if(c!=='id') rec[c] = data[c][i]; });
                rows.push(rec);
            }
            return rows;
        }
    };

    // --- INIT ---
    grist.ready({ columns: MAPPING, requiredAccess: 'full' });
    grist.onRecords(data => {
        state.allRecords = Utils.cleanData(data);
        extractUniqueValues();
        updateFilterSelects();
        handleFilters(); 
    });

    function extractUniqueValues() {
        state.uniqueTeams = [...new Set(state.allRecords.map(r => r.Team).filter(Boolean))].sort();
        state.uniqueProjects = [...new Set(state.allRecords.map(r => r.Project).filter(Boolean))].sort();
        state.uniqueAssignees = [...new Set(state.allRecords.map(r => r.Assignee).filter(Boolean))].sort();
        // Populate Datalists immediately for dropdowns to work
        populateDatalists();
    }

    function updateFilterSelects() {
        const fill = (id, list, def) => {
            const el = document.getElementById(id);
            const val = el.value;
            el.innerHTML = `<option value="all">${def}</option>` + list.map(v => `<option value="${v}">${v}</option>`).join('');
            if(list.includes(val)) el.value = val;
        };
        fill('filter-team', state.uniqueTeams, 'Toutes les administrations');
        fill('filter-project', state.uniqueProjects, 'Tous les projets');
        fill('filter-assignee', state.uniqueAssignees, 'Tous les responsables');
    }

    function handleFilters() {
        state.filters.team = document.getElementById('filter-team').value;
        state.filters.project = document.getElementById('filter-project').value;
        state.filters.assignee = document.getElementById('filter-assignee').value;
        state.filteredRecords = state.allRecords.filter(r => {
            return (state.filters.team === 'all' || r.Team === state.filters.team) &&
                   (state.filters.project === 'all' || r.Project === state.filters.project) &&
                   (state.filters.assignee === 'all' || r.Assignee === state.filters.assignee);
        });
        renderCurrentView();
    }

    function switchView(view) {
        state.currentView = view;
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.querySelector(`.nav-item[onclick="window.switchView('${view}')"]`).classList.add('active');
        
        const tb = document.getElementById('main-toolbar');
        const gs = document.getElementById('gantt-scale');
        
        if (view === 'dashboard') tb.style.display = 'none';
        else {
            tb.style.display = 'grid';
            gs.style.display = (view === 'gantt') ? 'block' : 'none';
        }
        renderCurrentView();
    }
    
    function changeGanttScale(val) { state.ganttScale = val; renderCurrentView(); }

    function renderCurrentView() {
        const container = document.getElementById('app-content');
        container.innerHTML = '';
        const wrapper = document.createElement('div');
        wrapper.className = 'view-container active';

        if(state.currentView === 'dashboard') renderDashboard(wrapper);
        else if(state.currentView === 'gantt') renderGantt(wrapper);
        else renderList(wrapper);
        container.appendChild(wrapper);
    }

    // --- DASHBOARD ---
    function renderDashboard(container) {
        const data = state.allRecords; 
        const total = data.length;
        const now = new Date();
        const done = data.filter(r => (r.Progress||0) == 100).length;
        const late = data.filter(r => {
            const end = Utils.fromGristDate(r.EndDate);
            return end && end < now && (r.Progress||0) < 100;
        }).length;
        const inProgress = data.filter(r => (r.Progress||0) > 0 && (r.Progress||0) < 100).length;
        const donePct = total ? Math.round((done/total)*100) : 0;

        container.innerHTML = `
            <div class="dashboard-grid">
                <div class="stat-card"><div><div class="stat-title">Total T√¢ches</div><div class="stat-value" style="color:var(--black)">${total}</div></div><div class="stat-footer">Global</div></div>
                <div class="stat-card"><div><div class="stat-title">En Cours</div><div class="stat-value" style="color:var(--info)">${inProgress}</div></div><div class="stat-footer">Actives</div></div>
                <div class="stat-card"><div><div class="stat-title">Termin√©es</div><div class="stat-value text-success">${done}</div></div><div class="stat-footer">${donePct}% du total</div></div>
                <div class="stat-card"><div><div class="stat-title">En Retard</div><div class="stat-value text-danger">${late}</div></div><div class="stat-footer">Attention</div></div>
            </div>
            <div class="charts-row">
                <div class="chart-box"><h4 style="margin-top:0">Par Priorit√©</h4>${renderBarChart(data, 'Priority', {High: 'var(--danger)', Normal: 'var(--warning)', Low: 'var(--success)'})}</div>
                <div class="chart-box"><h4 style="margin-top:0">Par Administration</h4>${renderBarChart(data, 'Team', null)}</div>
            </div>`;
    }

    function renderBarChart(data, key, colorMap) {
        const counts = {};
        data.forEach(r => { const k = r[key] || 'Non d√©fini'; counts[k] = (counts[k] || 0) + 1; });
        const max = Math.max(...Object.values(counts), 1);
        return Object.keys(counts).map(k => {
            const pct = (counts[k] / max) * 100;
            const color = colorMap ? (colorMap[k] || '#ccc') : Utils.stringToColor(k);
            return `<div class="bar-group"><div class="bar-label"><span>${k}</span> <span>${counts[k]}</span></div><div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${color}"></div></div></div>`;
        }).join('');
    }

    // --- GANTT ---
    function renderGantt(container) {
        const tasks = state.filteredRecords.filter(r => r.StartDate && r.EndDate)
            .map(r => ({...r, start: Utils.fromGristDate(r.StartDate), end: Utils.fromGristDate(r.EndDate)}))
            .filter(r => r.start && r.end).sort((a,b) => a.start - b.start);

        if (!tasks.length) { container.innerHTML = '<div style="text-align:center; padding:40px; color:#999">Aucune t√¢che avec dates.</div>'; return; }

        let minTime = Math.min(...tasks.map(t => t.start.getTime()));
        let maxTime = Math.max(...tasks.map(t => t.end.getTime()));
        
        // Safety: Limit range if bad dates (e.g. 1970)
        const nowMs = new Date().getTime();
        if (minTime < nowMs - (5*365*24*3600*1000)) minTime = nowMs - (30*24*3600*1000); 

        const padding = 86400000 * 2; minTime -= padding; maxTime += padding;
        const totalDays = Math.ceil((maxTime - minTime) / 86400000);
        if (totalDays > 2000) { container.innerHTML = '<div style="text-align:center;color:red">Plage de dates trop large.</div>'; return; }

        let pxPerDay = 40;
        if (state.ganttScale === 'week') pxPerDay = 15;
        if (state.ganttScale === 'month') pxPerDay = 5;
        const totalWidth = totalDays * pxPerDay;

        // Header
        let headerHtml = '';
        let loopDate = new Date(minTime);
        for(let i=0; i < totalDays; i++) {
            const d = loopDate.getDate();
            const w = loopDate.getDay();
            const m = loopDate.toLocaleDateString('fr-FR', {month:'short'});
            let style = `position:absolute; left:${i*pxPerDay}px; width:${pxPerDay}px; height:100%; border-right:1px solid #f1f5f9; text-align:center; font-size:10px; padding-top:4px;`;
            let txt = '';
            if (state.ganttScale === 'day') {
                txt = `<b>${d}</b><br><span style="color:#aaa">${['D','L','M','M','J','V','S'][w]}</span>`;
                if(w===0 || w===6) style += 'background:#fafafa';
            } else if (state.ganttScale === 'week') {
                if(w === 1) { style += 'border-left:1px solid #ccc;'; txt = `S${getWeekNum(loopDate)}<br>${m}`; }
            } else if (state.ganttScale === 'month') {
                if(d === 1) { style += 'border-left:1px solid #ccc; font-weight:bold;'; txt = m; }
            }
            if(txt) headerHtml += `<div style="${style}">${txt}</div>`;
            loopDate.setDate(loopDate.getDate() + 1);
        }

        // CORRECTIF TRAIT ROUGE
        const diffNow = (nowMs - minTime) / 86400000;
        let redLine = '';
        if(diffNow >= 0 && diffNow <= totalDays) {
            redLine = `<div class="today-line" style="left:${diffNow*pxPerDay}px"><div class="today-label">Auj.</div></div>`;
        }

        // Body Grouped
        const projects = [...new Set(tasks.map(t => t.Project || 'Sans Projet'))].sort();
        let bodyHtml = redLine;

        projects.forEach(proj => {
            bodyHtml += `<div class="gantt-group-header">${proj}</div>`;
            const groupTasks = tasks.filter(t => (t.Project || 'Sans Projet') === proj);
            groupTasks.forEach(t => {
                let diffStart = (t.start.getTime() - minTime) / 86400000;
                let dur = (t.end.getTime() - t.start.getTime()) / 86400000 + 1;
                if(diffStart < 0) { dur += diffStart; diffStart = 0; }
                const col = Utils.stringToColor(t.Project);
                if (dur > 0) {
                    bodyHtml += `
                    <div class="gantt-row">
                        <div class="gantt-row-label" onclick="window.openModal(${t.id})" title="${t.Title}">${t.Title}</div>
                        <div class="gantt-row-track" id="track-${t.id}">
                            <div class="gantt-block" id="block-${t.id}"
                                 style="left:${diffStart*pxPerDay}px; width:${Math.max(dur*pxPerDay, 5)}px; background:${col}" 
                                 title="${t.Title}"
                                 onmousedown="window.handleDragStart(event, ${t.id}, ${minTime}, ${pxPerDay})">
                                 ${t.Title}
                            </div>
                        </div>
                    </div>`;
                }
            });
        });

        container.innerHTML = `
            <div class="gantt-wrapper">
                <div class="gantt-header-row">
                    <div class="gantt-sidebar-title">Projet / T√¢che</div>
                    <div class="gantt-timeline-header" style="width:${totalWidth}px">${headerHtml}</div>
                </div>
                <div class="gantt-body" style="width:${totalWidth+200}px">${bodyHtml}</div>
            </div>`;
        
        if(!window.dragActive) {
            window.addEventListener('mousemove', handleDragMove);
            window.addEventListener('mouseup', handleDragEnd);
            window.dragActive = true;
        }
    }

    function getWeekNum(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    // --- DRAG LOGIC ---
    function handleDragStart(e, id, minTime, pxPerDay) {
        e.preventDefault(); e.stopPropagation();
        const block = document.getElementById(`block-${id}`);
        dragState = { isDragging: true, element: block, recordId: id, startX: e.clientX, initialLeft: parseFloat(block.style.left), pxPerDay, minTime, hasMoved: false };
    }
    function handleDragMove(e) {
        if (!dragState.isDragging) return;
        dragState.hasMoved = true;
        const delta = e.clientX - dragState.startX;
        dragState.element.style.left = (dragState.initialLeft + delta) + 'px';
    }
    async function handleDragEnd(e) {
        if (!dragState.isDragging) return;
        if (dragState.hasMoved) {
            const days = Math.round((e.clientX - dragState.startX) / dragState.pxPerDay);
            if (days !== 0) {
                const r = state.allRecords.find(x => x.id === dragState.recordId);
                const s = Utils.fromGristDate(r.StartDate); s.setDate(s.getDate() + days);
                const end = Utils.fromGristDate(r.EndDate); end.setDate(end.getDate() + days);
                try {
                    // CORRECTIF SAVE : Array needed
                    await grist.selectedTable.update([{ id: dragState.recordId, fields: { StartDate: Utils.toGristDate(s), EndDate: Utils.toGristDate(end) } }]);
                } catch(err) { console.error(err); renderCurrentView(); }
            } else renderCurrentView();
        } else { window.openModal(dragState.recordId); }
        dragState.isDragging = false;
        dragState.element = null;
    }

    // --- LISTE ---
    function renderList(container) {
        const listDiv = document.createElement('div');
        listDiv.className = 'task-list';
        if(!state.filteredRecords.length) { container.innerHTML = '<div style="text-align:center; padding:40px; color:#999">Aucune t√¢che.</div>'; return; }

        state.filteredRecords.forEach(r => {
            const card = document.createElement('div');
            let prioClass = r.Priority === 'High' ? 'priority-high' : (r.Priority === 'Low' ? 'priority-low' : 'priority-normal');
            card.className = `task-card ${prioClass}`;
            card.onclick = () => window.openModal(r.id);

            const badges = [];
            if(r.Team) badges.push({t: r.Team, c: Utils.stringToColor(r.Team)});
            if(r.Project) badges.push({t: r.Project, c: Utils.stringToColor(r.Project)});

            card.innerHTML = `
                <div class="card-top">
                    <h3 class="card-h3">${r.Title || 'Sans Titre'}</h3>
                    <span style="font-size:10px; font-weight:700; color:#666">${r.Priority || 'Normal'}</span>
                </div>
                <div class="card-tags">${badges.map(b => `<span class="tag" style="background:${b.c}">${b.t}</span>`).join('')}</div>
                <div class="card-btm">
                    <div class="avatar-row"><span>üë§ ${r.Assignee || 'Non assign√©'}</span></div>
                    <div>üìÖ ${Utils.formatDate(Utils.fromGristDate(r.EndDate))} &bull; <strong>${r.Progress||0}%</strong></div>
                </div>`;
            listDiv.appendChild(card);
        });
        container.appendChild(listDiv);
    }

    // --- MODAL & SAVING (CORRECTIFS CRITIQUES) ---
    function populateDatalists() {
        const fill = (id, list) => { document.getElementById(id).innerHTML = list.map(v => `<option value="${v}">`).join(''); };
        fill('list-teams', state.uniqueTeams);
        fill('list-projects', state.uniqueProjects);
        fill('list-assignees', state.uniqueAssignees);
    }
    
    function addItem(id) {
        const val = prompt("Ajouter :");
        if(val) document.getElementById(id).value = val;
    }

    function openModal(recordId = null) {
        // CORRECTIF: Populate √† chaque ouverture
        populateDatalists();
        const modal = document.getElementById('modal');
        document.getElementById('input-id').value = '';
        document.getElementById('input-title').value = '';
        document.getElementById('input-project').value = '';
        document.getElementById('input-team').value = '';
        document.getElementById('input-assignee').value = '';
        document.getElementById('input-priority').value = 'Normal';
        document.getElementById('input-start').value = Utils.inputDate(new Date());
        document.getElementById('input-end').value = Utils.inputDate(new Date());
        document.getElementById('input-progress').value = 0;

        if (recordId) {
            const r = state.allRecords.find(x => x.id === recordId);
            if (r) {
                document.getElementById('input-id').value = r.id;
                document.getElementById('input-title').value = r.Title || '';
                document.getElementById('input-project').value = r.Project || '';
                document.getElementById('input-team').value = r.Team || '';
                document.getElementById('input-assignee').value = r.Assignee || '';
                document.getElementById('input-priority').value = r.Priority || 'Normal';
                document.getElementById('input-start').value = Utils.inputDate(Utils.fromGristDate(r.StartDate));
                document.getElementById('input-end').value = Utils.inputDate(Utils.fromGristDate(r.EndDate));
                document.getElementById('input-progress').value = r.Progress || 0;
            }
        }
        modal.classList.add('open');
    }

    function closeModal() { document.getElementById('modal').classList.remove('open'); }

    // CORRECTIF SAVE : API ARRAY STRUCTURE
    async function saveTask() {
        const id = document.getElementById('input-id').value;
        const fields = {
            Title: document.getElementById('input-title').value || 'Nouvelle T√¢che',
            Project: document.getElementById('input-project').value,
            Team: document.getElementById('input-team').value,
            Assignee: document.getElementById('input-assignee').value,
            Priority: document.getElementById('input-priority').value,
            StartDate: Utils.toGristDate(new Date(document.getElementById('input-start').value)),
            EndDate: Utils.toGristDate(new Date(document.getElementById('input-end').value)),
            Progress: parseInt(document.getElementById('input-progress').value) || 0
        };

        try {
            if (id) {
                // UPDATE requires array of objects with id
                await grist.selectedTable.update([{ id: parseInt(id), fields: fields }]);
            } else {
                // CREATE requires array of objects
                await grist.selectedTable.create([{ fields: fields }]);
            }
            closeModal();
        } catch (e) {
            console.error("Save Error:", e);
            alert("Erreur: V√©rifiez que les colonnes Grist existent (Title, Project, etc).");
        }
    }

    // EXPORTS
    window.handleFilters = handleFilters;
    window.switchView = switchView;
    window.changeGanttScale = changeGanttScale;
    window.handleDragStart = handleDragStart;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.saveTask = saveTask;
    window.addItem = addItem;

</script>
</body>
</html>
