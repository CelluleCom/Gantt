<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilotage Projets - État</title>
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   
    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --primary: #4F46E5;    /* Indigo Moderne */
            --secondary: #0F172A;  /* Slate Dark */
            --bg-app: #F1F5F9;
            --bg-surface: #FFFFFF;
            --text-main: #334155;
            --text-light: #64748B;
            --border: #E2E8F0;
           
            /* Status Colors */
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --blue: #3B82F6;

            /* Badges Teams Colors */
            --badge-bg: #E0E7FF;
            --badge-text: #3730A3;

            /* Shadows & Radius */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); margin: 0; padding: 24px; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .app-logo { font-size: 1.5rem; font-weight: 800; color: var(--secondary); display: flex; align-items: center; gap: 10px; }
        .app-logo span { color: var(--primary); }
        .sync-pill { background: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: var(--text-light); box-shadow: var(--shadow); display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .dot.ok { background: var(--success); }

        .btn-add { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; box-shadow: var(--shadow); display: flex; gap: 8px; align-items: center; }
        .btn-add:hover { background: #4338ca; transform: translateY(-1px); }

        /* NAVIGATION TABS */
        .nav-container { display: flex; gap: 16px; margin-bottom: 24px; }
        .nav-btn { background: transparent; border: none; font-size: 1rem; font-weight: 600; color: var(--text-light); padding: 8px 16px; cursor: pointer; border-bottom: 3px solid transparent; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .nav-btn:hover { color: var(--secondary); }
       
        /* FILTERS */
        .filters { display: flex; gap: 12px; margin-left: auto; }
        select { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: white; color: var(--text-main); cursor: pointer; }

        /* MAIN CONTENT CARD */
        .main-card { background: var(--bg-surface); border-radius: var(--radius); box-shadow: var(--shadow); flex: 1; overflow: hidden; display: flex; flex-direction: column; }
        .view-section { display: none; padding: 24px; overflow-y: auto; height: 100%; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* KPI GRID */
        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-box { padding: 20px; border-radius: 12px; background: #F8FAFC; border: 1px solid var(--border); }
        .kpi-title { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: var(--text-light); margin-bottom: 8px; }
        .kpi-value { font-size: 2rem; font-weight: 800; color: var(--secondary); }

        /* TABLEAU TÂCHES */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 16px; color: var(--text-light); font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid var(--bg-app); }
        td { padding: 16px; border-bottom: 1px solid var(--bg-app); vertical-align: middle; }
        tr:hover td { background: #F8FAFC; cursor: pointer; }
       
        .task-title { font-weight: 600; font-size: 0.95rem; color: var(--secondary); }
        .project-tag { display: inline-block; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: #F1F5F9; color: var(--text-light); margin-top: 4px; }
       
        /* BADGES */
        .badge-team {
            display: inline-flex;
            align-items: center;
            background: var(--secondary); /* Fond sombre pour contraste */
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 6px;
            margin-left: 8px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .progress-track { width: 100px; height: 6px; background: #E2E8F0; border-radius: 3px; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }

        /* GANTT OPTIMISÉ */
        .gantt-wrapper { overflow-x: auto; padding: 10px; }
        .gantt .bar-label { fill: #333 !important; font-weight: 600; font-size: 12px; }
        .gantt .bar-wrapper:hover .bar { opacity: 0.8; }
       
        /* Couleurs des barres Gantt */
        .bar-critique .bar { fill: var(--danger) !important; }
        .bar-haute .bar { fill: var(--warning) !important; }
        .bar-moyenne .bar { fill: var(--blue) !important; }
        .bar-termine .bar { fill: var(--success) !important; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal { background: white; width: 500px; padding: 32px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 24px; }
        .modal h2 { margin: 0; font-size: 1.25rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
       
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-family: inherit; }
       
        /* Quick Create Btn */
        .btn-qc { width: 30px; border: 1px solid var(--border); background: #f8fafc; border-radius: 6px; cursor: pointer; color: var(--primary); font-size: 1.2rem; margin-left: 5px; }

        /* Mobile */
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; gap: 16px; }
            .nav-container { overflow-x: auto; width: 100%; }
            .filters { width: 100%; flex-wrap: wrap; }
            select { flex: 1; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="app-logo"><span>⚡</span> PROJET MASTER</div>
        <div style="display:flex; gap:12px; align-items:center;">
            <div class="sync-pill"><div class="dot" id="syncDot"></div> <span id="syncText">Connexion...</span></div>
            <button class="btn-add" onclick="openModal()">+ Tâche</button>
        </div>
    </header>

    <div style="display:flex; flex-wrap:wrap; align-items:center;">
        <div class="nav-container">
            <button class="nav-btn active" onclick="switchView('dashboard', this)">Tableau de Bord</button>
            <button class="nav-btn" onclick="switchView('gantt', this)">Planning Gantt</button>
        </div>
        <div class="filters">
            <select id="filterProject" onchange="refreshView()"><option value="">Tous les Projets</option></select>
            <select id="filterAgent" onchange="refreshView()"><option value="">Tous les Agents</option></select>
        </div>
    </div>

    <div class="main-card">
       
        <div id="view-dashboard" class="view-section active">
            <div class="kpi-row">
                <div class="kpi-box">
                    <div class="kpi-title">Tâches en Cours</div>
                    <div class="kpi-value" style="color:var(--blue)" id="kpi-cours">0</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-title">En Retard</div>
                    <div class="kpi-value" style="color:var(--danger)" id="kpi-retard">0</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-title">Total Tâches</div>
                    <div class="kpi-value" id="kpi-total">0</div>
                </div>
            </div>

            <h3 style="margin-bottom:20px;">Tâches Actives & En cours</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 35%">Tâche & Projet</th>
                            <th style="width: 25%">Responsable</th>
                            <th style="width: 15%">Fin</th>
                            <th style="width: 25%">Progression</th>
                        </tr>
                    </thead>
                    <tbody id="taskListBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="view-gantt" class="view-section">
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:20px;">
                <button class="btn-add" style="background:white; color:var(--text-main); border:1px solid var(--border); padding:6px 12px; font-size:0.8rem;" onclick="changeGanttMode('Day')">Jour</button>
                <button class="btn-add" style="background:white; color:var(--text-main); border:1px solid var(--border); padding:6px 12px; font-size:0.8rem;" onclick="changeGanttMode('Week')">Semaine</button>
                <button class="btn-add" style="background:white; color:var(--text-main); border:1px solid var(--border); padding:6px 12px; font-size:0.8rem;" onclick="changeGanttMode('Month')">Mois</button>
            </div>
            <div id="gantt-chart" class="gantt-wrapper"></div>
        </div>
    </div>

    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Nouvelle Tâche</h2>
                <button class="close-btn" onclick="closeModal()">✕</button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="inpId">
               
                <div style="margin-bottom:16px;">
                    <label>Titre</label>
                    <input type="text" id="inpTitle" required>
                </div>

                <div class="form-grid">
                    <div>
                        <label>Projet</label>
                        <div style="display:flex;">
                            <select id="inpProject" required><option>Chargement...</option></select>
                            <button type="button" class="btn-qc" onclick="alert('Fonctionnalité Quick Create active dans la version précédente.')">+</button>
                        </div>
                    </div>
                    <div>
                        <label>Responsable</label>
                        <div style="display:flex;">
                            <select id="inpAgent"><option>Chargement...</option></select>
                            <button type="button" class="btn-qc" onclick="alert('Fonctionnalité Quick Create active dans la version précédente.')">+</button>
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div><label>Début</label><input type="date" id="inpStart" required></div>
                    <div><label>Fin</label><input type="date" id="inpEnd" required></div>
                </div>

                <div class="form-grid">
                    <div><label>Avancement (%)</label><input type="number" id="inpProgress" min="0" max="100"></div>
                    <div><label>Priorité</label>
                        <select id="inpPriority">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:24px;">
                    <button type="button" class="btn-add" style="background:white; color:var(--text-main); border:1px solid var(--border);" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn-add">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <script>
        // CONFIGURATION
        const DB = { TASKS: 'TACHES_MASTER', AGENTS: 'AGENTS', PROJECTS: 'PROJETS', TEAMS: 'EQUIPES' };
        let appData = { tasks: [], agents: [], projects: [], teams: [] };
        let ganttChart = null;
        let currentGanttMode = 'Week';

        // START
        grist.ready({ requiredAccess: 'full' });
        grist.onRecords(async () => await loadData());

        // LOAD DATA
        async function loadData() {
            updateStatus(false, "Chargement...");
            try {
                const [rTasks, rAgents, rProjects, rTeams] = await Promise.all([
                    grist.docApi.fetchTable(DB.TASKS),
                    grist.docApi.fetchTable(DB.AGENTS),
                    grist.docApi.fetchTable(DB.PROJECTS),
                    grist.docApi.fetchTable(DB.TEAMS)
                ]);

                // 1. Process Teams
                appData.teams = convert(rTeams).map(t => ({ id: t.id, name: t.Nom || t.Nom_Equipe || "N/A" }));

                // 2. Process Agents
                appData.agents = convert(rAgents).map(a => {
                    const team = appData.teams.find(t => t.id === a.Equipe);
                    return {
                        id: a.id,
                        name: a.Nom_Complet || a.Nom,
                        teamName: team ? team.name : null
                    };
                });

                // 3. Process Projects
                appData.projects = convert(rProjects).map(p => ({ id: p.id, name: p.Nom_Projet || p.Nom }));

                // 4. Process Tasks (LOGIQUE DE GROUPE POUR GANTT)
                const rawTasks = convert(rTasks);
               
                appData.tasks = rawTasks.map(t => {
                    const agent = appData.agents.find(a => a.id === t.Responsable) || {name: 'Non assigné', teamName: null};
                    const project = appData.projects.find(p => p.id === t.Projet) || {name: 'Sans Projet'};
                    const isLate = new Date(t.Date_Fin) < new Date() && t.Avancement < 100;

                    let color = 'bar-moyenne';
                    if(t.Avancement === 100) color = 'bar-termine';
                    else if(t.Priorite === 'Critique' || isLate) color = 'bar-critique';
                    else if(t.Priorite === 'Haute') color = 'bar-haute';

                    return {
                        ...t, id: t.id.toString(),
                        displayAgent: agent.name,
                        displayTeam: agent.teamName, // <-- Badge Data
                        displayProject: project.name,
                        // Gantt fields
                        name: t.Titre,
                        start: formatDate(t.Date_Debut),
                        end: formatDate(t.Date_Fin),
                        progress: t.Avancement || 0,
                        dependencies: t.Dependances || "",
                        custom_class: color
                    };
                });

                // TRI POUR LE GANTT : Grouper par Projet, puis par Date
                appData.tasks.sort((a, b) => {
                    if (a.displayProject < b.displayProject) return -1;
                    if (a.displayProject > b.displayProject) return 1;
                    return new Date(a.start) - new Date(b.start); // Waterfall
                });

                refreshView();
                updateStatus(true, "Synchronisé");
            } catch (e) {
                console.error(e);
                updateStatus(false, "Erreur Sync");
            }
        }

        // REFRESH
        function refreshView() {
            populateSelects();
            const fProj = document.getElementById('filterProject').value;
            const fAgent = document.getElementById('filterAgent').value;
           
            const filtered = appData.tasks.filter(t =>
                (fProj === "" || t.Projet == fProj) && (fAgent === "" || t.Responsable == fAgent)
            );

            renderDashboard(filtered);
            renderGantt(filtered);
        }

        // DASHBOARD RENDER
        function renderDashboard(tasks) {
            // Stats
            document.getElementById('kpi-total').innerText = tasks.length;
            document.getElementById('kpi-retard').innerText = tasks.filter(t => new Date(t.end) < new Date() && t.progress < 100).length;
            document.getElementById('kpi-cours').innerText = tasks.filter(t => t.progress > 0 && t.progress < 100).length;

            // Liste (Triée par avancement : En cours d'abord)
            const sortedTasks = [...tasks].sort((a, b) => {
                // Prioriser ceux qui sont entre 1 et 99%
                const aActive = a.progress > 0 && a.progress < 100 ? 1 : 0;
                const bActive = b.progress > 0 && b.progress < 100 ? 1 : 0;
                return bActive - aActive;
            });

            const tbody = document.getElementById('taskListBody');
            tbody.innerHTML = "";
           
            if(sortedTasks.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding:20px; color:#999'>Aucune tâche</td></tr>";
                return;
            }

            sortedTasks.forEach(t => {
                // BADGE EQUIPE FORCE
                const teamBadge = t.displayTeam
                    ? `<span class="badge-team">${t.displayTeam}</span>`
                    : '';
               
                // COULEUR BARRE
                let barColor = 'var(--blue)';
                if(t.progress === 100) barColor = 'var(--success)';
                else if(new Date(t.end) < new Date()) barColor = 'var(--danger)';

                const tr = document.createElement('tr');
                tr.onclick = () => openModal(t);
                tr.innerHTML = `
                    <td>
                        <div class="task-title">${t.Titre}</div>
                        <div class="project-tag">${t.displayProject}</div>
                    </td>
                    <td>
                        ${t.displayAgent}
                        ${teamBadge}
                    </td>
                    <td style="font-size:0.85rem">${t.end}</td>
                    <td>
                        <div style="display:flex; justify-content:space-between; font-size:0.75rem; margin-bottom:2px;">
                            <span>${t.progress}%</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" style="width:${t.progress}%; background:${barColor}"></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // GANTT RENDER
        function renderGantt(tasks) {
            const container = document.getElementById("gantt-chart");
            container.innerHTML = "";
            if(tasks.length === 0) {
                container.innerHTML = "<p style='text-align:center; padding:20px'>Rien à afficher</p>";
                return;
            }

            // Frappe Gantt a besoin de "custom_class" pour les couleurs
            // On a déjà trié 'tasks' par Projet dans loadData
            ganttChart = new Gantt("#gantt-chart", tasks, {
                header_height: 50,
                column_width: 30,
                step: 24,
                view_modes: ['Day', 'Week', 'Month'],
                bar_height: 25,
                bar_corner_radius: 4,
                arrow_curve: 5,
                padding: 18,
                view_mode: currentGanttMode,
                date_format: 'YYYY-MM-DD',
                language: 'fr',
                on_click: task => openModal(task),
                on_date_change: (task, start, end) => save('UpdateRecord', task.id, { Date_Debut: formatDate(start), Date_Fin: formatDate(end) }),
                on_progress_change: (task, progress) => save('UpdateRecord', task.id, { Avancement: progress })
            });
        }

        function changeGanttMode(mode) {
            currentGanttMode = mode;
            if(ganttChart) ganttChart.change_view_mode(mode);
        }

        // ACTIONS
        async function save(action, rowId, fields) {
            updateStatus(false, "Sauvegarde...");
            const args = action === 'AddRecord' ? [null, fields] : [parseInt(rowId), fields];
            try {
                await grist.docApi.applyUserActions([[action, DB.TASKS, ...args]]);
            } catch (e) {
                alert("Erreur: " + e.message);
                updateStatus(false, "Erreur");
            }
        }

        // UTILS
        function updateStatus(ok, msg) {
            document.getElementById('syncDot').className = ok ? 'dot ok' : 'dot';
            document.getElementById('syncText').innerText = msg;
        }

        function convert(table) {
            const keys = Object.keys(table);
            if(keys.length === 0) return [];
            const res = [];
            for(let i=0; i<table.id.length; i++) {
                let obj = {}; keys.forEach(k => obj[k] = table[k][i]); res.push(obj);
            }
            return res;
        }
       
        function populateSelects() {
            const fill = (sel, list) => {
                const el = document.querySelector(sel);
                const val = el.value;
                el.innerHTML = el.options[0].outerHTML;
                list.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = i.id; opt.innerText = i.name; el.appendChild(opt);
                });
                if(list.some(i=>i.id==val)) el.value = val;
            };
            fill('#filterProject', appData.projects); fill('#inpProject', appData.projects);
            fill('#filterAgent', appData.agents); fill('#inpAgent', appData.agents);
        }

        function formatDate(v) {
            if(!v) return new Date().toISOString().split('T')[0];
            const d = typeof v === 'number' ? new Date(v*1000) : new Date(v);
            return d.toISOString().split('T')[0];
        }

        // MODAL LOGIC
        const modal = document.getElementById('taskModal');
        function openModal(t=null) {
            const f = document.getElementById('taskForm');
            if(t) {
                document.getElementById('modalTitle').innerText = "Modifier Tâche";
                document.getElementById('inpId').value = t.id;
                document.getElementById('inpTitle').value = t.Titre;
                document.getElementById('inpProject').value = t.Projet;
                document.getElementById('inpAgent').value = t.Responsable;
                document.getElementById('inpStart').value = t.start;
                document.getElementById('inpEnd').value = t.end;
                document.getElementById('inpProgress').value = t.progress;
                document.getElementById('inpPriority').value = t.Priorite;
            } else {
                f.reset();
                document.getElementById('modalTitle').innerText = "Nouvelle Tâche";
                document.getElementById('inpId').value = "";
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('inpStart').value = today;
                document.getElementById('inpEnd').value = today;
            }
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
       
        document.getElementById('taskForm').onsubmit = e => {
            e.preventDefault();
            const id = document.getElementById('inpId').value;
            const data = {
                Titre: document.getElementById('inpTitle').value,
                Projet: parseInt(document.getElementById('inpProject').value),
                Responsable: parseInt(document.getElementById('inpAgent').value),
                Date_Debut: document.getElementById('inpStart').value,
                Date_Fin: document.getElementById('inpEnd').value,
                Avancement: parseInt(document.getElementById('inpProgress').value),
                Priorite: document.getElementById('inpPriority').value
            };
            save(id?'UpdateRecord':'AddRecord', id, data);
            closeModal();
        };

        function switchView(v, btn) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            btn.classList.add('active');
            if(v==='gantt' && ganttChart) setTimeout(()=>ganttChart.refresh(appData.tasks), 50);
        }

        window.onclick = e => { if(e.target==modal) closeModal(); }
    </script>
</body>
</html>
