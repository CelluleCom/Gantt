<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grist Task & Gantt Manager Pro v4</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    /* --- THEME VARS --- */
    :root {
      --color-primary: var(--grist-theme-cursor, #16b378);
      --color-bg: var(--grist-theme-page-bg, white);
      --color-text: var(--grist-theme-text, black);
      --color-border: var(--grist-theme-border, #ccc);
      --color-hover: var(--grist-theme-hover, #f0f0f0);
      --color-normal: #5bc0de;
      --color-high: #d9534f;
      --color-low: #777;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--color-bg);
      color: var(--color-text);
      font-size: 13px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      user-select: none; /* Important pour le Drag & Drop */
    }

    /* --- TOP BAR --- */
    #top-bar {
      padding: 10px 15px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      background: var(--color-bg);
      z-index: 20;
    }

    .stats-container {
      display: flex;
      gap: 20px;
      font-weight: 600;
      font-size: 14px;
    }

    .stat-total { color: black; }
    .stat-progress { color: #0056b3; }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    select, button {
      padding: 6px 12px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      background: var(--color-bg);
      color: var(--color-text);
      cursor: pointer;
    }

    button.primary {
      background-color: var(--color-primary);
      color: white;
      border: none;
    }
    
    button.secondary {
      background-color: #6c757d;
      color: white;
      border: none;
    }

    /* --- LAYOUT --- */
    #main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* --- LISTE DES T√ÇCHES --- */
    #task-list {
      width: 350px;
      border-right: 1px solid var(--color-border);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      background: var(--color-bg);
    }

    .task-item {
      padding: 10px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    .task-item:hover { background-color: var(--color-hover); }

    .task-checkbox { width: 18px; height: 18px; cursor: pointer; }
    .task-content { flex: 1; }
    .task-title { font-weight: 600; display: block; margin-bottom: 4px; }
    .task-meta { font-size: 11px; color: #666; display: flex; gap: 8px; }

    .badge { padding: 2px 6px; border-radius: 10px; color: white; font-size: 10px; text-transform: uppercase; }
    .badge.high { background-color: var(--color-high); }
    .badge.normal { background-color: var(--color-normal); }
    .badge.low { background-color: var(--color-low); }

    /* --- GANTT --- */
    #gantt-container {
      flex: 1;
      overflow: auto; /* Scroll interne */
      position: relative;
      background: var(--color-bg);
      cursor: grab;
    }
    
    #gantt-container.dragging {
      cursor: grabbing;
      user-select: none;
    }

    #gantt-header {
      position: sticky;
      top: 0;
      background: var(--color-bg);
      border-bottom: 1px solid var(--color-border);
      height: 45px;
      white-space: nowrap;
      z-index: 10;
      display: flex;
    }

    .gantt-time-col {
      border-right: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 11px;
      flex-shrink: 0;
      box-sizing: border-box;
      background: var(--color-bg);
    }
    .week-number { font-size: 9px; color: #888; margin-top: 2px; }

    #gantt-body {
      position: relative;
      min-height: 100%;
    }

    .gantt-row {
      height: 51px;
      border-bottom: 1px solid var(--color-border);
      position: relative;
      box-sizing: border-box;
    }

    .gantt-bar {
      position: absolute;
      top: 12px;
      height: 26px;
      background-color: var(--color-primary);
      border-radius: 4px;
      opacity: 0.9;
      font-size: 11px;
      color: white;
      display: flex;
      align-items: center;
      padding-left: 8px;
      white-space: nowrap;
      overflow: hidden;
      cursor: grab; /* Curseur main */
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: box-shadow 0.1s;
      z-index: 5;
    }

    .gantt-bar:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 6; /* Passer au dessus */
    }

    .gantt-bar.dragging-active {
      cursor: grabbing;
      opacity: 0.7;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      z-index: 100;
    }
    
    .gantt-bar.done { background-color: #888; text-decoration: line-through; }

    /* Ligne Rouge Date du Jour */
    #current-day-line {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: red;
      z-index: 4;
      pointer-events: none;
      display: none; /* Cach√© par d√©faut, activ√© par JS */
    }
    #current-day-label {
        position: absolute;
        top: -22px;
        left: -20px;
        background: red;
        color: white;
        padding: 2px 4px;
        font-size: 10px;
        border-radius: 3px;
        white-space: nowrap;
    }

    /* --- MODAL --- */
    #modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 200;
    }
    .modal {
      background: var(--color-bg);
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .modal h3 { margin-top: 0; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
    .form-group input, .form-group select { width: 100%; box-sizing: border-box; padding: 8px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }

    /* --- PRINT / PDF EXPORT --- */
    @media print {
      body { height: auto; overflow: visible; background: white; }
      #top-bar, #task-list, #modal-overlay { display: none !important; }
      
      #main-container { display: block; overflow: visible; }
      #gantt-container { 
        overflow: visible; 
        width: 100%; 
        border: none;
      }
      #gantt-header {
        position: static; /* Pas de sticky en print */
        border-bottom: 2px solid #000;
      }
      .gantt-row {
        page-break-inside: avoid;
        border-bottom: 1px solid #ccc;
      }
      /* Force landscape suggestion (Chrome) */
      @page { size: landscape; margin: 1cm; }
    }
  </style>
</head>
<body>

  <script>
    // --- UTILS (NON-REGRESSION) ---
    function gristDateToJS(value) {
      if (!value && value !== 0) return null;
      return value > 100000 ? new Date(value * 1000) : new Date(value * 24 * 60 * 60 * 1000);
    }

    function jsDateToGrist(date) {
      if (!date) return null;
      const utcDate = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
      return Math.floor(utcDate / (24 * 60 * 60 * 1000));
    }

    function convertGristTableToRecords(tableData) {
      if (!tableData || Array.isArray(tableData)) return tableData || [];
      const columns = Object.keys(tableData);
      if (!columns.length) return [];
      const rowCount = tableData[columns[0]]?.length || 0;
      const records = [];
      for (let i = 0; i < rowCount; i++) {
        const record = { id: tableData.id[i] };
        columns.forEach(col => record[col] = tableData[col][i]);
        records.push(record);
      }
      return records;
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
    }

    // --- STATE ---
    let allRecords = [];
    let displayedRecords = [];
    let currentView = 'day'; 
    let scale = 40; 
    let uniqueTags = []; 
    let uniqueAgents = [];
    
    // Drag & Drop State
    let isDragging = false;
    let dragStartX = 0;
    let dragOriginalLeft = 0;
    let draggedElement = null;
    let draggedRecordId = null;
    let draggedRecordStart = null;
    let draggedRecordEnd = null;
    
    const COL_MAP = {
      title: 'TaskName',   
      start: 'StartDate',  
      due: 'DueDate',      
      status: 'Status',    
      priority: 'Priority',
      owner: 'Responsable', 
      tags: 'Occurence'     
    };
  </script>

  <div id="top-bar">
    <div class="stats-container">
      <span class="stat-total">Total: <span id="count-total">0</span></span>
      <span class="stat-progress">En cours: <span id="count-progress">0</span></span>
    </div>
    <div class="controls">
      <select id="agent-filter" onchange="applyFilters()">
        <option value="all">Tous les agents</option>
      </select>
      <select id="view-selector" onchange="changeView(this.value)">
        <option value="day">Jour</option>
        <option value="week">Semaine</option>
        <option value="month">Mois</option>
      </select>
      <button class="secondary" onclick="exportPDF()">üñ®Ô∏è PDF / Print</button>
      <button class="primary" onclick="openModal()">+ Nouvelle T√¢che</button>
    </div>
  </div>

  <div id="main-container">
    <div id="task-list"></div>
    <div id="gantt-container">
      <div id="gantt-header"></div>
      <div id="gantt-body">
         <div id="current-day-line"><div id="current-day-label">Aujourd'hui</div></div>
      </div>
    </div>
  </div>

  <div id="modal-overlay">
    <div class="modal">
      <h3>Nouvelle T√¢che</h3>
      <form id="new-task-form" onsubmit="submitTask(event)">
        <div class="form-group">
          <label>Titre</label>
          <input type="text" id="input-title" required>
        </div>
        <div class="form-group" style="display:flex; gap:10px;">
          <div style="flex:1"><label>D√©but</label><input type="date" id="input-start" required></div>
          <div style="flex:1"><label>√âch√©ance</label><input type="date" id="input-due" required></div>
        </div>
        <div class="form-group">
          <label>Responsable</label>
          <input type="text" id="input-owner">
        </div>
        <div class="form-group">
          <label>Occurrence</label>
          <select id="input-tags"><option value="">-- S√©lectionner --</option></select>
        </div>
        <div class="form-group">
          <label>Priorit√©</label>
          <select id="input-priority">
            <option value="Normal">Normal</option>
            <option value="High">Haute</option>
            <option value="Low">Basse</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" onclick="closeModal()">Annuler</button>
          <button type="submit" class="primary">Cr√©er</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    grist.ready({
      requiredAccess: 'full',
      columns: [
        { name: COL_MAP.title, type: 'Text', title: 'Titre' },
        { name: COL_MAP.start, type: 'Date', title: 'D√©but' },
        { name: COL_MAP.due, type: 'Date', title: 'Fin' },
        { name: COL_MAP.status, type: 'Choice', title: 'Statut' },
        { name: COL_MAP.priority, type: 'Choice', title: 'Priorit√©' },
        { name: COL_MAP.owner, type: 'Text', title: 'Responsable' },
        { name: COL_MAP.tags, type: 'Text', title: 'Occurrence' }
      ]
    });

    grist.onRecords(function(data) {
      allRecords = convertGristTableToRecords(data);
      extractUniqueValues();
      applyFilters();
    });

    function extractUniqueValues() {
      const tagSet = new Set();
      const agentSet = new Set();
      allRecords.forEach(r => {
        if(r[COL_MAP.tags]) tagSet.add(r[COL_MAP.tags]);
        if(r[COL_MAP.owner]) agentSet.add(r[COL_MAP.owner]);
      });
      uniqueTags = Array.from(tagSet).sort();
      uniqueAgents = Array.from(agentSet).sort();

      const filterSelect = document.getElementById('agent-filter');
      const currentVal = filterSelect.value;
      filterSelect.innerHTML = '<option value="all">Tous les agents</option>';
      uniqueAgents.forEach(agent => {
        const opt = document.createElement('option');
        opt.value = agent;
        opt.textContent = agent;
        filterSelect.appendChild(opt);
      });
      filterSelect.value = currentVal;
    }

    function applyFilters() {
      const agentFilter = document.getElementById('agent-filter').value;
      displayedRecords = allRecords.filter(r => {
        if (agentFilter !== 'all' && r[COL_MAP.owner] !== agentFilter) return false;
        return true;
      });
      
      document.getElementById('count-total').textContent = displayedRecords.length;
      document.getElementById('count-progress').textContent = displayedRecords.filter(r => r[COL_MAP.status] === 'In Progress').length;
      
      render();
    }

    async function toggleStatus(id, currentStatus) {
      const newStatus = currentStatus === 'Done' ? 'In Progress' : 'Done';
      await grist.selectedTable.update([{ id: id, [COL_MAP.status]: newStatus }]);
    }

    // --- EXPORT PDF ---
    function exportPDF() {
      window.print();
    }

    // --- RENDER ---
    function render() {
      renderList();
      renderGantt();
    }

    function renderList() {
      const container = document.getElementById('task-list');
      container.innerHTML = '';
      displayedRecords.forEach(r => {
        const div = document.createElement('div');
        div.className = 'task-item';
        const isDone = r[COL_MAP.status] === 'Done';
        const priority = r[COL_MAP.priority] || 'Normal';
        let priorityClass = 'normal'; 
        if(priority === 'High') priorityClass = 'high';
        if(priority === 'Low') priorityClass = 'low';

        div.innerHTML = `
          <input type="checkbox" class="task-checkbox" ${isDone ? 'checked' : ''} onclick="toggleStatus(${r.id}, '${r[COL_MAP.status]}'); event.stopPropagation();">
          <div class="task-content" style="${isDone ? 'opacity:0.5' : ''}">
            <span class="task-title">${r[COL_MAP.title] || 'Sans titre'}</span>
            <div class="task-meta">
              <span class="badge ${priorityClass}">${priority}</span>
              <span>${r[COL_MAP.owner] || '-'}</span>
              <span>${r[COL_MAP.tags] || ''}</span>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function changeView(view) {
      currentView = view;
      if (view === 'day') scale = 50; 
      if (view === 'week') scale = 20;
      if (view === 'month') scale = 10;
      renderGantt();
    }

    function renderGantt() {
      const containerHeader = document.getElementById('gantt-header');
      const containerBody = document.getElementById('gantt-body');
      const redLine = document.getElementById('current-day-line');
      
      containerHeader.innerHTML = '';
      // Reset Body content but keep red line
      while(containerBody.firstChild && containerBody.firstChild !== redLine) {
        containerBody.removeChild(containerBody.firstChild);
      }
      // Re-append if lost or ensure logic preserves it
      if(!containerBody.contains(redLine)) containerBody.appendChild(redLine);

      if(displayedRecords.length === 0) return;

      // Calcul Date Range
      let minDate = new Date();
      let maxDate = new Date();
      const dates = displayedRecords.flatMap(r => [gristDateToJS(r[COL_MAP.start]), gristDateToJS(r[COL_MAP.due])]).filter(d => d);
      if(dates.length) {
        minDate = new Date(Math.min(...dates));
        maxDate = new Date(Math.max(...dates));
      }
      minDate.setDate(minDate.getDate() - 5);
      maxDate.setDate(maxDate.getDate() + 15);

      const totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24);
      const totalWidth = totalDays * scale;

      // Header
      const loopDate = new Date(minDate);
      let dayCount = 0;
      while (loopDate <= maxDate) {
        const col = document.createElement('div');
        col.className = 'gantt-time-col';
        col.style.width = `${scale}px`;
        col.style.height = '100%';
        const d = loopDate.getDate();
        const m = loopDate.getMonth() + 1;
        const w = loopDate.getDay(); 

        if(currentView === 'day') {
             col.innerHTML = `<strong>${d}</strong>/${m}<br><span style="color:#aaa">${['D','L','M','M','J','V','S'][w]}</span>`;
             if(w === 0 || w === 6) col.style.backgroundColor = '#fafafa';
        } else if (currentView === 'week') {
             if(w === 1 || dayCount === 0) {
                 col.style.borderLeft = '2px solid #ccc';
                 col.innerHTML = `<strong>${d}</strong><div class="week-number">S${getWeekNumber(loopDate)}</div>`;
             } else { col.innerHTML = `${d}`; }
        } else if (currentView === 'month') {
             if(d === 1 || dayCount === 0) {
                 col.style.borderLeft = '2px solid #ccc';
                 col.innerHTML = `<strong>${loopDate.toLocaleString('default', { month: 'short' })}</strong>`;
             }
        }
        containerHeader.appendChild(col);
        loopDate.setDate(loopDate.getDate() + 1);
        dayCount++;
      }
      containerBody.style.width = `${totalWidth}px`;
      containerHeader.style.width = `${totalWidth}px`;

      // Bars
      displayedRecords.forEach(r => {
        const row = document.createElement('div');
        row.className = 'gantt-row';
        row.style.width = `${totalWidth}px`;
        
        const start = gristDateToJS(r[COL_MAP.start]);
        const end = gristDateToJS(r[COL_MAP.due]);

        if (start && end) {
          const diffStart = (start - minDate) / (1000 * 60 * 60 * 24);
          const duration = (end - start) / (1000 * 60 * 60 * 24) + 1;

          const bar = document.createElement('div');
          bar.className = 'gantt-bar';
          if(r[COL_MAP.status] === 'Done') bar.classList.add('done');
          
          bar.style.left = `${diffStart * scale}px`;
          bar.style.width = `${Math.max(duration * scale, 5)}px`;
          bar.textContent = r[COL_MAP.title];
          bar.title = "Glissez pour d√©placer";

          // INIT DRAG AND DROP
          bar.addEventListener('mousedown', (e) => handleDragStart(e, bar, r.id, start, end));
          
          row.appendChild(bar);
        }
        containerBody.appendChild(row);
      });

      // Red Line
      const today = new Date();
      today.setHours(0,0,0,0);
      minDate.setHours(0,0,0,0);
      const diffToday = (today - minDate) / (1000 * 60 * 60 * 24);
      if(diffToday >= 0 && diffToday <= totalDays) {
          redLine.style.display = 'block';
          redLine.style.left = `${diffToday * scale}px`;
          // Replace to front
          containerBody.appendChild(redLine);
      } else {
          redLine.style.display = 'none';
      }
    }

    // --- DRAG & DROP LOGIC ---
    function handleDragStart(e, bar, id, start, end) {
      if(e.button !== 0) return; // Only left click
      e.preventDefault();
      
      isDragging = true;
      dragStartX = e.clientX;
      dragOriginalLeft = parseFloat(bar.style.left);
      draggedElement = bar;
      draggedRecordId = id;
      draggedRecordStart = start;
      draggedRecordEnd = end;

      draggedElement.classList.add('dragging-active');
      document.getElementById('gantt-container').classList.add('dragging');

      document.addEventListener('mousemove', handleDragMove);
      document.addEventListener('mouseup', handleDragEnd);
    }

    function handleDragMove(e) {
      if (!isDragging) return;
      const deltaX = e.clientX - dragStartX;
      draggedElement.style.left = `${dragOriginalLeft + deltaX}px`;
    }

    async function handleDragEnd(e) {
      if (!isDragging) return;
      
      // Cleanup events
      document.removeEventListener('mousemove', handleDragMove);
      document.removeEventListener('mouseup', handleDragEnd);
      
      const deltaX = e.clientX - dragStartX;
      const deltaDays = Math.round(deltaX / scale); // Convert pixels to days
      
      // Visual reset
      draggedElement.classList.remove('dragging-active');
      document.getElementById('gantt-container').classList.remove('dragging');

      if (deltaDays !== 0) {
        // Calculate new dates
        const newStart = new Date(draggedRecordStart);
        newStart.setDate(newStart.getDate() + deltaDays);
        
        const newEnd = new Date(draggedRecordEnd);
        newEnd.setDate(newEnd.getDate() + deltaDays);

        // Optimistic UI update handled by render logic, but here we wait for Grist
        try {
          await grist.selectedTable.update([{
            id: draggedRecordId,
            [COL_MAP.start]: jsDateToGrist(newStart),
            [COL_MAP.due]: jsDateToGrist(newEnd)
          }]);
        } catch(err) {
          console.error("Error updating date", err);
          renderGantt(); // Revert on error
        }
      } else {
        // If moved less than a day snap back
        renderGantt(); 
      }

      // Reset state
      isDragging = false;
      draggedElement = null;
      draggedRecordId = null;
    }

    // --- MODAL & FORM ---
    function openModal() {
      const modal = document.getElementById('modal-overlay');
      const selectTags = document.getElementById('input-tags');
      selectTags.innerHTML = '<option value="">-- S√©lectionner --</option>';
      uniqueTags.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t; opt.textContent = t; selectTags.appendChild(opt);
      });
      const optNew = document.createElement('option');
      optNew.value = "_NEW_"; optNew.textContent = "+ Cr√©er nouveau..."; selectTags.appendChild(optNew);
      
      selectTags.onchange = function() {
          if(this.value === '_NEW_') {
              const newVal = prompt("Nom de la nouvelle occurrence:");
              if(newVal) {
                  const opt = document.createElement('option');
                  opt.value = newVal; opt.textContent = newVal; opt.selected = true;
                  this.appendChild(opt); this.value = newVal;
              } else { this.value = ""; }
          }
      }

      document.getElementById('new-task-form').reset();
      document.getElementById('input-start').valueAsDate = new Date();
      document.getElementById('input-due').valueAsDate = new Date();
      modal.style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    async function submitTask(e) {
      e.preventDefault();
      const record = {
        [COL_MAP.title]: document.getElementById('input-title').value,
        [COL_MAP.start]: jsDateToGrist(document.getElementById('input-start').valueAsDate),
        [COL_MAP.due]: jsDateToGrist(document.getElementById('input-due').valueAsDate),
        [COL_MAP.owner]: document.getElementById('input-owner').value,
        [COL_MAP.tags]: document.getElementById('input-tags').value,
        [COL_MAP.priority]: document.getElementById('input-priority').value,
        [COL_MAP.status]: 'Todo'
      };
      await grist.selectedTable.create([record]);
      closeModal();
    }
  </script>
</body>
</html>
