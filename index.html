<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Cockpit - V20 Logic</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- DESIGN SYSTEM (V19) --- */
        :root {
            --primary: #4F46E5; --bg-app: #F8FAFC; --bg-surface: #FFFFFF;
            --text-main: #1E293B; --text-muted: #64748B; --border: #E2E8F0;
            --c-blue: #3B82F6; --c-green: #10B981; --c-red: #EF4444; --info: #3B82F6;
            --g-critique: #EF4444; --g-haute: #F97316; --g-moyenne: #3B82F6; --g-basse: #94A3B8; --g-ok: #10B981;
            --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--bg-surface); padding: 15px 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); flex-shrink: 0; }
        .app-title { font-weight: 800; font-size: 1.4rem; color: var(--primary); }
        .sync-badge { font-size: 0.75rem; background: #fff; padding: 5px 12px; border-radius: 20px; border: 1px solid var(--border); display: flex; gap: 6px; align-items: center; font-weight: 600; color: var(--text-muted); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; gap: 6px; align-items: center; }

        /* TOOLBAR */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .nav-pills { display: flex; background: #E2E8F0; padding: 4px; border-radius: 8px; }
        .nav-btn { padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--text-muted); border-radius: 6px; transition: 0.2s; }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: var(--shadow); }
        .filters { display: flex; gap: 10px; margin-left: auto; }
        select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; min-width: 150px; background: white; cursor: pointer; }

        /* CONTENT */
        .content-card { flex: 1; background: var(--bg-surface); border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        .view-section { display: none; flex: 1; overflow-y: auto; padding: 25px; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .kpi-card { padding: 20px; background: white; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; }
        .kpi-lbl { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
        .kpi-val { font-size: 2rem; font-weight: 800; }
        .kpi-sub { font-size: 0.85rem; font-weight: 600; margin-top: 5px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: #FAFAFA; border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .stat-head { font-weight: 700; border-bottom: 1px solid #E2E8F0; padding-bottom: 10px; margin-bottom: 10px; }
        .bar-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
        .bar-lbl { width: 130px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-track { flex: 1; height: 8px; background: #E2E8F0; border-radius: 4px; margin: 0 10px; }
        .bar-fill { height: 100%; border-radius: 4px; }
        .bar-val { width: 30px; text-align: right; font-weight: 700; }

        .sect-head { font-size: 1.1rem; font-weight: 700; margin: 0 0 15px 0; border-left: 4px solid var(--primary); padding-left: 10px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { padding: 12px 15px; background: #F8FAFC; text-align: left; color: var(--text-muted); font-weight: 700; position: sticky; top: 0; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); vertical-align: top; }
        tr:hover td { background: #F8FAFC; cursor: pointer; }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; margin-top: 3px; }
        .badge-team { background: #1E293B; color: white; text-transform: uppercase; margin-top: 4px; }
        .agent-stack { display: flex; flex-direction: column; align-items: flex-start; }

        /* GANTT */
        .gantt-wrapper { overflow: auto; height: 100%; }
        .gantt .grid-header { background: #fff; height: 50px; }
        .gantt .grid-row { fill: #fff; } .gantt .grid-row:nth-child(even) { fill: #FCFCFC; }
        .gantt .row-line { stroke: #F1F5F9; } .gantt .bar { rx: 3px; ry: 3px; stroke: none; }
        .gantt .bar-label { fill: #333; font-weight: 600; font-size: 12px; }
        .bar-critique .bar { fill: var(--g-critique) !important; }
        .bar-haute .bar { fill: var(--g-haute) !important; }
        .bar-moyenne .bar { fill: var(--g-moyenne) !important; }
        .bar-basse .bar { fill: var(--g-basse) !important; }
        .bar-termine .bar { fill: var(--g-ok) !important; }
        .zoom-tools { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 10px; }
        .btn-zoom { background: white; border: 1px solid var(--border); padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
        .btn-zoom.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* MODALS */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; width: 500px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .modal.mini { width: 350px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .input-group { display: flex; gap: 5px; }
        .btn-plus { width: 35px; border: 1px solid var(--border); background: #F1F5F9; color: var(--primary); border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
        .m-foot { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-sec { background: transparent; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        
        @media (max-width: 768px) { .kpi-grid, .stats-grid, .form-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header class="header">
        <div class="app-title">Project Cockpit</div>
        <div style="display: flex; align-items: center; gap: 16px;">
            <div class="sync-badge"><div class="dot" id="syncDot"></div> <span id="syncText">Connexion...</span></div>
            <button class="btn-primary" onclick="openModal()"><span>+</span> T√¢che</button>
        </div>
    </header>

    <div class="toolbar">
        <div class="nav-pills">
            <button class="nav-btn active" onclick="switchView('dashboard', this)">Tableau de Bord</button>
            <button class="nav-btn" onclick="switchView('gantt', this)">Planning Gantt</button>
            <button class="nav-btn" onclick="switchView('list', this)">Liste</button>
        </div>
        <div class="filters">
            <select id="fProj" onchange="applyFilters()"><option value="">Tous les Projets</option></select>
            <select id="fTeam" onchange="applyFilters()"><option value="">Toutes les Admin.</option></select>
            <select id="fAgent" onchange="applyFilters()"><option value="">Tous les Agents</option></select>
        </div>
    </div>

    <div class="content-card">
        
        <div id="view-dashboard" class="view-section active">
            <div class="kpi-row">
                <div class="kpi-card"><div class="kpi-lbl">Total</div><div class="kpi-val" id="kpi-total">0</div></div>
                <div class="kpi-card"><div class="kpi-lbl">En Cours</div><div class="kpi-val" style="color:var(--c-blue)" id="kpi-cours">0</div></div>
                <div class="kpi-card"><div class="kpi-lbl">Termin√©es</div><div class="kpi-val" style="color:var(--c-green)" id="kpi-done">0</div><div class="kpi-sub" style="color:var(--c-green)" id="kpi-rate">0%</div></div>
                <div class="kpi-card"><div class="kpi-lbl">Retard</div><div class="kpi-val" style="color:var(--c-red)" id="kpi-retard">0</div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-head">R√©partition par Priorit√©</div><div id="stats-prio"></div></div>
                <div class="stat-box"><div class="stat-head">Charge par Administration</div><div id="stats-team"></div></div>
            </div>
            <div class="sect-head">üìÖ T√¢ches √† venir</div>
            <table><thead><tr><th>T√¢che & Projet</th><th>Responsable</th><th>√âch√©ance</th><th>Statut</th></tr></thead><tbody id="upcomingListBody"></tbody></table>
        </div>

        <div id="view-gantt" class="view-section">
            <div class="zoom-tools">
                <button class="btn-zoom" onclick="zoomGantt('Day')">Jour</button>
                <button class="btn-zoom active" onclick="zoomGantt('Week')">Semaine</button>
                <button class="btn-zoom" onclick="zoomGantt('Month')">Mois</button>
            </div>
            <div id="gantt-chart" class="gantt-wrapper"></div>
        </div>

        <div id="view-list" class="view-section">
            <div class="sect-head">üóÇÔ∏è Inventaire Complet</div>
            <table><thead><tr><th>T√¢che & Projet</th><th>Responsable</th><th>Fin</th><th>Priorit√©</th><th>Progression</th></tr></thead><tbody id="fullListBody"></tbody></table>
        </div>
    </div>

    <div class="overlay" id="taskModal">
        <div class="modal">
            <div style="display:flex;justify-content:space-between;margin-bottom:20px"><h2 style="margin:0" id="modalTitle">T√¢che</h2><button onclick="closeModal()" style="border:none;background:none;cursor:pointer;font-size:1.2rem">‚úï</button></div>
            <form id="taskForm">
                <input type="hidden" id="inpId">
                <div style="margin-bottom:15px"><label>Titre</label><input type="text" id="inpTitle" required></div>
                <div class="form-grid">
                    <div><label>Projet</label><div class="input-group"><select id="inpProject" required></select><button type="button" class="btn-plus" onclick="openQC('Project')">+</button></div></div>
                    <div><label>Responsable</label><div class="input-group"><select id="inpAgent"></select><button type="button" class="btn-plus" onclick="openQC('Agent')">+</button></div></div>
                </div>
                <div class="form-grid"><div><label>D√©but</label><input type="date" id="inpStart" required></div><div><label>Fin</label><input type="date" id="inpEnd" required></div></div>
                <div class="form-grid">
                    <div><label>Avancement (%)</label><input type="number" id="inpProgress" min="0" max="100"></div>
                    <div><label>Priorit√©</label><select id="inpPriority"><option value="Basse">Basse</option><option value="Moyenne" selected>Moyenne</option><option value="Haute">Haute</option><option value="Critique">Critique</option></select></div>
                </div>
                <div class="m-foot"><button type="button" class="btn-sec" onclick="closeModal()">Annuler</button><button type="submit" class="btn-primary">Enregistrer</button></div>
            </form>
        </div>
    </div>

    <div class="overlay" id="qcModal">
        <div class="modal mini">
            <div style="display:flex;justify-content:space-between;margin-bottom:20px"><h3 id="qcTitle" style="margin:0">Nouveau</h3><button onclick="closeQC()" style="border:none;background:none;cursor:pointer">‚úï</button></div>
            <input type="hidden" id="qcType">
            <div style="margin-bottom:15px"><label>Nom</label><input type="text" id="qcName"></div>
            <div id="qcExtra" style="display:none;margin-bottom:15px"><label>Administration</label><div class="input-group"><select id="qcTeamSel"></select><button type="button" class="btn-plus" onclick="openQC('Team')">+</button></div></div>
            <div class="m-foot"><button type="button" class="btn-sec" onclick="closeQC()">Fermer</button><button type="button" onclick="saveQC()" class="btn-primary">Cr√©er</button></div>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <script>
        // --- A. CONFIGURATION (ID TABLES GRIST) ---
        const TABLES = {
            TABLE_PRINCIPALE: 'TACHES_MASTER',
            TABLE_AGENTS: 'AGENTS',
            TABLE_PROJETS: 'PROJETS',
            TABLE_EQUIPES: 'EQUIPES'
        };

        // Stockage local
        let appData = { tasks: [], agents: [], projects: [], teams: [] };
        let ganttChart = null;

        // --- B. INITIALISATION ---
        grist.ready({ requiredAccess: 'full' });

        grist.onRecords(async function() {
            updateSyncStatus("Sync...", "orange");
            await loadAllTables();
            updateSyncStatus("Pr√™t", "var(--c-green)");
        });

        // --- C. CHARGEMENT DES DONN√âES (LOGIQUE DEMAND√âE) ---
        async function loadAllTables() {
            try {
                // 1. R√©cup√©ration Brute (via fetchGristTable)
                const rawTasks = await fetchGristTable(TABLES.TABLE_PRINCIPALE);
                const rawAgents = await fetchGristTable(TABLES.TABLE_AGENTS);
                const rawProjects = await fetchGristTable(TABLES.TABLE_PROJETS);
                const rawTeams = await fetchGristTable(TABLES.TABLE_EQUIPES);

                // 2. Mapping & Jointures (Logique V19)
                appData.teams = rawTeams.map(r => ({ id: r.id, name: r.Nom || r.Nom_Equipe || "√âquipe" }));
                appData.projects = rawProjects.map(r => ({ id: r.id, name: r.Nom_Projet || r.Nom }));
                
                appData.agents = rawAgents.map(r => {
                    const team = appData.teams.find(t => t.id === r.Equipe);
                    return { id: r.id, name: r.Nom_Complet || r.Nom, teamName: team ? team.name : null };
                });

                appData.tasks = rawTasks.map(t => {
                    const agent = appData.agents.find(a => a.id === t.Responsable) || { name: 'Non assign√©', teamName: null };
                    const project = appData.projects.find(p => p.id === t.Projet) || { name: 'Aucun' };
                    
                    let color = 'bar-basse';
                    const isLate = new Date(t.Date_Fin) < new Date() && t.Avancement < 100;
                    if(t.Avancement === 100) color = 'bar-termine';
                    else if (t.Priorite === 'Critique' || isLate) color = 'bar-critique';
                    else if (t.Priorite === 'Haute') color = 'bar-haute';
                    else if (t.Priorite === 'Moyenne') color = 'bar-moyenne';

                    // CREATION VARIABLES UI
                    return {
                        ...t, id: t.id.toString(),
                        displayAgent: agent.name, displayTeam: agent.teamName, displayProject: project.name,
                        name: t.Titre, start: formatDateIso(t.Date_Debut), end: formatDateIso(t.Date_Fin),
                        progress: t.Avancement || 0, dependencies: t.Dependances || "", custom_class: color
                    };
                });

                appData.tasks.sort((a,b) => new Date(a.start) - new Date(b.start));
                refreshUI();

            } catch (e) {
                console.error("Erreur de chargement Grist :", e);
                updateSyncStatus("Erreur", "red");
            }
        }

        // Fonction g√©n√©rique (VOTRE LOGIQUE)
        async function fetchGristTable(tableId) {
            const raw = await grist.docApi.fetchTable(tableId);
            return convertToRowFormat(raw);
        }

        // --- D. SAUVEGARDE (VOTRE LOGIQUE) ---
        async function saveToGrist(action, tableId, rowId, fields) {
            updateSyncStatus("Sauvegarde...", "orange");
            const args = action === 'AddRecord' ? [null, fields] : [parseInt(rowId), fields];
            try {
                await grist.docApi.applyUserActions([[action, tableId, ...args]]);
            } catch (e) {
                console.error("Erreur de sauvegarde :", e);
                alert("Erreur lors de la sauvegarde dans Grist.");
            }
        }

        // --- E. UTILITAIRE CONVERSION (VOTRE LOGIQUE) ---
        function convertToRowFormat(tableData) {
            const keys = Object.keys(tableData);
            if (keys.length === 0) return [];
            const len = tableData.id.length;
            const result = [];
            for (let i = 0; i < len; i++) {
                let obj = {};
                keys.forEach(key => { obj[key] = tableData[key][i]; });
                result.push(obj);
            }
            return result;
        }

        // --- F. RENDU UI (LOGIQUE V19) ---
        function refreshUI() { populateSelects(); applyFilters(); }

        function applyFilters() {
            const fP = document.getElementById('filterProject').value;
            const fT = document.getElementById('filterTeam').value;
            const fA = document.getElementById('filterAgent').value;

            const res = appData.tasks.filter(t => 
                (fP === "" || t.displayProject == fP) && 
                (fT === "" || (t.displayTeam && t.displayTeam == fT)) &&
                (fA === "" || t.Responsable == fA)
            );

            renderDashboard(res); renderList(res); renderGantt(res);
        }

        function renderDashboard(tasks) {
            const tot = tasks.length;
            const done = tasks.filter(t=>t.progress==100).length;
            const active = tasks.filter(t=>t.progress>0 && t.progress<100).length;
            const late = tasks.filter(t=>new Date(t.end)<new Date() && t.progress<100).length;
            
            document.getElementById('kpi-total').innerText = tot;
            document.getElementById('kpi-cours').innerText = active;
            document.getElementById('kpi-done').innerText = done;
            document.getElementById('kpi-rate').innerText = tot ? Math.round((done/tot)*100)+"%" : "0%";
            document.getElementById('kpi-retard').innerText = late;

            // Stats
            const pMap={'Critique':0,'Haute':0,'Moyenne':0,'Basse':0};
            const pCols={'Critique':'#ef4444','Haute':'#f97316','Moyenne':'#3b82f6','Basse':'#94a3b8'};
            tasks.forEach(t=>{if(pMap[t.Priorite]!==undefined) pMap[t.Priorite]++});
            let hP=""; for(const [k,v] of Object.entries(pMap)){ if(v>0){const pc=Math.round((v/tot)*100); hP+=`<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${pc}%;background:${pCols[k]}"></div></div><div class="bar-val">${v}</div></div>`;}}
            document.getElementById('stats-prio').innerHTML = hP || "<div style='color:#999'>Rien</div>";

            const tMap={}; tasks.forEach(t=>{const tm=t.displayTeam||"Sans Admin"; tMap[tm]=(tMap[tm]||0)+1});
            let hT=""; for(const [k,v] of Object.entries(tMap)){const pc=Math.round((v/tot)*100); hT+=`<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${pc}%;background:${strColor(k)}"></div></div><div class="bar-val">${v}</div></div>`;}
            document.getElementById('stats-team').innerHTML = hT || "<div style='color:#999'>Rien</div>";

            // Upcoming
            const upcoming = tasks.filter(t => t.progress<100 && new Date(t.end)>=new Date()).slice(0,5);
            const tb = document.getElementById('upcomingListBody');
            tb.innerHTML = "";
            upcoming.forEach(t => {
                const bdgT = t.displayTeam ? `<br><span class="badge badge-team" style="background:${strColor(t.displayTeam)}">${t.displayTeam}</span>` : '';
                tb.innerHTML += `<tr onclick="openModalById('${t.id}')"><td><div style="font-weight:600">${t.Titre}</div><span class="badge" style="background:${strColor(t.displayProject)}20;color:${strColor(t.displayProject)}">${t.displayProject}</span></td><td>${t.displayAgent}${bdgT}</td><td>${t.end}</td><td><span style="color:var(--info);font-weight:700">${t.progress}%</span></td></tr>`;
            });
            if(!upcoming.length) tb.innerHTML = "<tr><td colspan='4' style='text-align:center;padding:15px;color:#999'>Aucune t√¢che √† venir</td></tr>";
        }

        function renderList(tasks) {
            const tb = document.getElementById('fullListBody');
            tb.innerHTML = "";
            tasks.forEach(t => {
                const bdgT = t.displayTeam ? `<br><span class="badge badge-team" style="background:${strColor(t.displayTeam)}">${t.displayTeam}</span>` : '';
                tb.innerHTML += `<tr onclick="openModalById('${t.id}')"><td><div style="font-weight:600">${t.Titre}</div><span class="badge" style="background:${strColor(t.displayProject)}20;color:${strColor(t.displayProject)}">${t.displayProject}</span></td><td><div class="agent-stack"><span style="font-weight:600">${t.displayAgent}</span>${bdgT}</div></td><td>${t.end}</td><td>${t.Priorite}</td><td>${t.progress}%</td></tr>`;
            });
        }

        function renderGantt(tasks) {
            const el = document.getElementById('gantt-chart');
            el.innerHTML = "";
            if(!tasks.length) { el.innerHTML="<p style='text-align:center;padding:20px;color:#999'>Rien √† afficher</p>"; return; }
            const gData = [...tasks].sort((a,b) => (a.displayProject > b.displayProject) ? 1 : -1);
            ganttChart = new Gantt("#gantt-chart", gData, {
                header_height: 50, column_width: 30, step: 24, view_modes: ['Day', 'Week', 'Month'],
                bar_height: 25, bar_corner_radius: 3, arrow_curve: 5, padding: 18, view_mode: 'Week',
                date_format: 'YYYY-MM-DD', language: 'fr',
                on_click: t => openModalById(t.id),
                on_date_change: (t,s,e) => saveToGrist('UpdateRecord', TABLES.TABLE_PRINCIPALE, t.id, {Date_Debut:formatDateIso(s), Date_Fin:formatDateIso(e)}),
                on_progress_change: (t,p) => saveToGrist('UpdateRecord', TABLES.TABLE_PRINCIPALE, t.id, {Avancement:p})
            });
        }

        // --- ACTIONS ---
        function openQC(type) {
            document.getElementById('qcType').value = type;
            document.getElementById('qcName').value = '';
            document.getElementById('qcExtra').style.display = 'none';
            let t = "Nouveau";
            if(type=='Project') t="Nouveau Projet";
            if(type=='Team') t="Nouvelle Administration";
            if(type=='Agent') { t="Nouvel Agent"; document.getElementById('qcExtra').style.display = 'block'; populateSelectBox('#qcTeamSel', appData.teams); }
            document.getElementById('qcTitle').innerText = t;
            document.getElementById('qcModal').style.display='flex';
        }
        function closeQC() { document.getElementById('qcModal').style.display='none'; }

        async function saveQC() {
            const type = document.getElementById('qcType').value;
            const name = document.getElementById('qcName').value.trim();
            if(!name) return;
            let tab, fields;
            if (type === 'Project') { tab = TABLES.TABLE_PROJETS; fields = { Nom_Projet: name }; }
            else if (type === 'Team') { tab = TABLES.TABLE_EQUIPES; fields = { Nom: name }; }
            else if (type === 'Agent') { tab = TABLES.TABLE_AGENTS; fields = { Nom_Complet: name, Equipe: parseInt(document.getElementById('qcTeamSel').value)||null }; }
            
            await saveToGrist('AddRecord', tab, null, fields);
            // Recharger cibl√©
            if(type === 'Project') { const r = await fetchGristTable(TABLES.TABLE_PROJETS); appData.projects = r.map(d=>({id:d.id, name:d.Nom_Projet||d.Nom})); }
            if(type === 'Team') { const r = await fetchGristTable(TABLES.TABLE_EQUIPES); appData.teams = r.map(d=>({id:d.id, name:d.Nom||d.Nom_Equipe})); }
            if(type === 'Agent') { 
                const r = await fetchGristTable(TABLES.TABLE_AGENTS); 
                appData.agents = r.map(d=>({id:d.id, name:d.Nom_Complet||d.Nom, teamName:appData.teams.find(x=>x.id==d.Equipe)?.name})); 
            }
            populateSelects(); closeQC(); updateSyncStatus("Cr√©√© !", "var(--c-green)");
        }

        document.getElementById('taskForm').onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('inpId').value;
            const data = {
                Titre: document.getElementById('inpTitle').value,
                Projet: parseInt(document.getElementById('inpProject').value),
                Responsable: parseInt(document.getElementById('inpAgent').value),
                Date_Debut: document.getElementById('inpStart').value,
                Date_Fin: document.getElementById('inpEnd').value,
                Avancement: parseInt(document.getElementById('inpProgress').value),
                Priorite: document.getElementById('inpPriority').value
            };
            saveToGrist(id ? 'UpdateRecord' : 'AddRecord', TABLES.TABLE_PRINCIPALE, id, data);
            closeModal();
        };

        // --- UTILS UI ---
        function openModal(task = null) {
            const form = document.getElementById('taskForm');
            if(task) {
                document.getElementById('modalTitle').innerText = "Modifier";
                document.getElementById('inpId').value = task.id;
                document.getElementById('inpTitle').value = task.Titre;
                document.getElementById('inpProject').value = task.Projet;
                document.getElementById('inpAgent').value = task.Responsable;
                document.getElementById('inpStart').value = task.start;
                document.getElementById('inpEnd').value = task.end;
                document.getElementById('inpProgress').value = task.progress;
                document.getElementById('inpPriority').value = task.Priorite;
            } else {
                form.reset();
                document.getElementById('modalTitle').innerText = "Nouveau";
                document.getElementById('inpId').value = "";
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('inpStart').value = today;
                document.getElementById('inpEnd').value = today;
            }
            document.getElementById('taskModal').style.display = 'flex';
        }
        function openModalById(id) { openModal(appData.tasks.find(x=>x.id==id)); }
        function closeModal() { document.getElementById('taskModal').style.display='none'; }
        
        function populateSelects() {
            populateSelectBox('#filterProject, #inpProject', appData.projects);
            populateSelectBox('#filterTeam', appData.teams, true);
            populateSelectBox('#filterAgent, #inpAgent', appData.agents);
        }
        function populateSelectBox(selector, list, useName=false) {
            document.querySelectorAll(selector).forEach(el => {
                const v=el.value; const d=el.options[0]; el.innerHTML=""; el.appendChild(d);
                list.forEach(i => { const o = document.createElement('option'); o.value=useName?i.name:i.id; o.innerText=i.name; el.appendChild(o); });
                if(list.some(i=>(useName?i.name:i.id)==v)) el.value = v;
            });
        }
        function formatDateIso(v) { if(!v) return new Date().toISOString().split('T')[0]; const d = typeof v==='number'?new Date(v*1000):new Date(v); return d.toISOString().split('T')[0]; }
        function switchView(v, btn) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); btn.classList.add('active'); if(v=='gantt' && ganttChart) setTimeout(()=>ganttChart.refresh(appData.tasks), 50); }
        function zoomGantt(m) { ganttChart.change_view_mode(m); }
        function updateSyncStatus(msg, color) { const dot = document.getElementById('syncDot'); dot.style.background = color; document.getElementById('syncText').textContent = msg; }
        function strColor(s) { let h=0;for(let i=0;i<s.length;i++)h=s.charCodeAt(i)+((h<<5)-h);return `hsl(${h%360},70%,40%)`; }
        window.onclick = e => { if(e.target == document.getElementById('taskModal')) closeModal(); if(e.target.classList.contains('modal-overlay')) e.target.style.display = 'none'; }
    </script>
</body>
</html>
