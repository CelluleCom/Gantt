<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt'FIP Ultimate v14 (Stable & Fixed)</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        /* --- 1. DESIGN SYSTEM (ORIGINAL v6.5 - INTOUCH√â) --- */
        :root {
            --primary: var(--grist-theme-cursor, #2563eb);
            --bg: var(--grist-theme-page-bg, #f8fafc);
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sec: #64748b;
            --border: #e2e8f0;
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --black: #000000; /* Ajout demand√© */

            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 20px; padding-bottom: 80px; user-select: none; font-size: 14px; }

        /* HEADER & NAV */
        .app-header { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        h1.app-logo { font-size: 22px; font-weight: 800; margin: 0; background: linear-gradient(135deg, var(--primary), #4f46e5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .nav-pills { display: flex; background: #e2e8f0; padding: 4px; border-radius: var(--radius-lg); width: fit-content; gap: 4px; }
        .nav-item { padding: 8px 20px; border-radius: var(--radius-md); border: none; background: transparent; color: var(--text-sec); font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .nav-item.active { background: var(--surface); color: var(--text-main); box-shadow: var(--shadow-sm); }

        /* TOOLBAR (MODIFI√â: POSITION RELATIVE POUR Z-INDEX) */
        .toolbar { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 20px; align-items: center; position: relative; z-index: 50; }
        .select-modern { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--surface); cursor: pointer; }
        
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary:active { transform: scale(0.98); }

        /* NOUVEAU: FAB PRINT (DEMANDE: BAS DROITE) */
        .fab-print { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--text-main); color: white; border-radius: 50%; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; z-index: 999; }

        /* VUES */
        .view-container { display: none; }
        .view-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); }
        .stat-title { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-sec); }
        .stat-value { font-size: 32px; font-weight: 800; margin: 8px 0; }
        .stat-footer { font-size: 12px; color: var(--text-sec); }
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: var(--surface); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); }
        .bar-group { margin-bottom: 10px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
        .bar-bg { height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 4px; }

        /* GANTT (STRUCTURE MISE A JOUR POUR GROUPES) */
        .gantt-wrapper { background: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border); overflow-x: auto; position: relative; min-height: 400px; padding:0; }
        .gantt-header-row { display: flex; border-bottom: 1px solid var(--border); height: 45px; position: sticky; top: 0; background: var(--surface); z-index: 20; }
        
        /* Sidebar gauche */
        .gantt-sidebar-title { width: 200px; flex-shrink: 0; padding: 10px; font-weight: bold; border-right: 1px solid var(--border); background: #f8fafc; font-size: 12px; display: flex; align-items: center; }
        .gantt-timeline-header { flex-grow: 1; position: relative; }
        .gantt-body { position: relative; }
        
        /* Groupe Projet */
        .gantt-group-header { background: #f1f5f9; padding: 8px 12px; font-weight: 700; font-size: 12px; border-bottom: 1px solid var(--border); border-top: 1px solid var(--border); color: var(--text-main); position: sticky; left: 0; width: 100%; z-index: 15; }
        
        .gantt-row { display: flex; height: 36px; border-bottom: 1px solid #f1f5f9; align-items: center; position: relative; }
        .gantt-row-label { width: 200px; flex-shrink: 0; padding: 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; border-right: 1px solid var(--border); background: var(--surface); position: sticky; left: 0; z-index: 10; height: 100%; display: flex; align-items: center; cursor: pointer; }
        .gantt-row-track { flex-grow: 1; position: relative; height: 100%; }
        
        .gantt-block { position: absolute; top: 8px; height: 20px; border-radius: 4px; min-width: 8px; cursor: grab; z-index: 5; font-size: 10px; color: white; display: flex; align-items: center; padding-left: 5px; white-space: nowrap; overflow: hidden; transition: box-shadow 0.2s; }
        .gantt-block:active { cursor: grabbing; z-index: 20; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        /* LIGNE ROUGE */
        .today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: red; z-index: 40; pointer-events: none; }
        .today-label { position: absolute; top: -20px; left: -20px; background: red; color: white; padding: 2px 4px; font-size: 10px; border-radius: 3px; white-space: nowrap; }

        /* LISTE */
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-card { background: var(--surface); padding: 16px; border-radius: var(--radius-md); border: 1px solid var(--border); border-left-width: 4px; cursor: pointer; transition: transform 0.1s; }
        .task-card:hover { transform: translateY(-2px); border-color: var(--primary); }
        .priority-high { border-left-color: var(--danger); }
        .priority-normal { border-left-color: var(--warning); }
        .priority-low { border-left-color: var(--success); }
        .card-top { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-btm { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-sec); }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 12px; font-weight: 600; color: white; margin-right: 5px; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 999; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: var(--surface); width: 100%; max-width: 500px; border-radius: var(--radius-lg); box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: var(--text-sec); }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius-md); }
        
        /* NOUVEAU: Input avec bouton + */
        .input-row-plus { display: flex; gap: 8px; }
        .btn-plus { width: 38px; flex-shrink: 0; border: 1px solid var(--border); background: #f1f5f9; border-radius: var(--radius-md); cursor: pointer; color: var(--primary); font-size: 18px; display: flex; justify-content: center; align-items: center; }
        
        .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .btn-sec { background: white; border: 1px solid var(--border); padding: 10px 20px; border-radius: var(--radius-md); cursor: pointer; }

        @media print {
            .app-header, .toolbar, .fab-print, .modal-overlay { display: none !important; }
            .view-container { display: block !important; }
            .gantt-wrapper, .dashboard-grid, .task-list { border: none; box-shadow: none; overflow: visible; }
            .gantt-wrapper { overflow-x: hidden; }
            @page { size: landscape; margin: 1cm; }
        }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="header-top">
            <h1 class="app-logo">Gantt'FIP</h1>
            <button type="button" class="btn-primary" onclick="window.openModal()">+ Nouvelle T√¢che</button>
        </div>
        <nav class="nav-pills">
            <button type="button" class="nav-item active" onclick="window.switchView('dashboard')">Tableau de Bord</button>
            <button type="button" class="nav-item" onclick="window.switchView('gantt')">Gantt</button>
            <button type="button" class="nav-item" onclick="window.switchView('list')">Liste</button>
        </nav>
    </div>

    <div id="main-toolbar" class="toolbar" style="display:none">
        <select id="filter-project" class="select-modern" onchange="window.handleFilters()"><option value="all">Tous les projets</option></select>
        <select id="filter-team" class="select-modern" onchange="window.handleFilters()"><option value="all">Toutes les administrations</option></select>
        <select id="filter-assignee" class="select-modern" onchange="window.handleFilters()"><option value="all">Tous les responsables</option></select>
        <select id="gantt-scale" class="select-modern" style="display:none" onchange="window.changeGanttScale(this.value)">
            <option value="day">Vue: Jour</option>
            <option value="week">Vue: Semaine</option>
            <option value="month">Vue: Mois</option>
        </select>
    </div>

    <button type="button" class="fab-print" onclick="window.print()">üñ®Ô∏è</button>

    <div id="app-content">
        <div style="text-align:center; margin-top:50px; color:#999">Chargement des donn√©es...</div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 style="margin:0">Nouvelle T√¢che</h3>
                <button type="button" class="close-btn" style="border:none;background:none;font-size:20px;cursor:pointer" onclick="window.closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="input-id">
                
                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" id="input-title" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">Projet</label>
                    <div class="input-row-plus">
                        <input list="list-projects" id="input-project" class="form-input" placeholder="S√©lectionner ou √©crire...">
                        <button type="button" class="btn-plus" onclick="window.addItem('input-project')">+</button>
                    </div>
                    <datalist id="list-projects"></datalist>
                </div>

                <div class="form-group">
                    <label class="form-label">Administration</label>
                    <div class="input-row-plus">
                        <input list="list-teams" id="input-team" class="form-input" placeholder="S√©lectionner ou √©crire...">
                        <button type="button" class="btn-plus" onclick="window.addItem('input-team')">+</button>
                    </div>
                    <datalist id="list-teams"></datalist>
                </div>

                <div class="form-group">
                    <label class="form-label">Responsable</label>
                    <div class="input-row-plus">
                        <input list="list-assignees" id="input-assignee" class="form-input" placeholder="Qui est en charge ?">
                        <button type="button" class="btn-plus" onclick="window.addItem('input-assignee')">+</button>
                    </div>
                    <datalist id="list-assignees"></datalist>
                </div>

                <div class="form-group">
                    <label class="form-label">Priorit√©</label>
                    <select id="input-priority" class="form-input">
                        <option value="Normal">Normale</option>
                        <option value="High">Haute</option>
                        <option value="Low">Basse</option>
                    </select>
                </div>

                <div style="display:flex; gap:10px">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">D√©but</label>
                        <input type="date" id="input-start" class="form-input">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Fin</label>
                        <input type="date" id="input-end" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Progression (%)</label>
                    <input type="range" id="input-progress" min="0" max="100" value="0" style="width:100%">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-sec" onclick="window.closeModal()">Annuler</button>
                <button type="button" class="btn-primary" onclick="window.saveTask()">Enregistrer</button>
            </div>
        </div>
    </div>

<script>
    // --- 1. CONFIGURATION (RETOUR A LA VERSION ROBUSTE) ---
    const COL_MAP = {
        title: 'Title',
        start: 'StartDate',
        end: 'EndDate',
        project: 'Project',
        team: 'Team',
        assignee: 'Assignee',
        priority: 'Priority',
        progress: 'Progress'
    };

    let state = {
        records: [],
        filtered: [],
        view: 'dashboard',
        ganttScale: 'day',
        uniques: { projects: [], teams: [], assignees: [] },
        filters: { project: 'all', team: 'all', assignee: 'all' }
    };

    let dragState = { isDragging: false, element: null, recordId: null, startX: 0, initialLeft: 0, pxPerDay: 0, minTime: 0, hasMoved: false };

    // --- 2. UTILS ---
    const Utils = {
        fromGristDate: (val) => (!val && val !== 0) ? null : (val > 100000 ? new Date(val * 1000) : new Date(val * 24 * 60 * 60 * 1000)),
        toGristDate: (d) => d ? Math.floor(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()) / 86400000) : null,
        formatDate: (d) => d ? d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) : '-',
        inputDate: (d) => d ? d.toISOString().split('T')[0] : '',
        stringToColor: (str) => {
            if (!str) return '#ccc';
            let hash = 0; for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 65%, 45%)`;
        }
    };

    // --- 3. INIT GRIST (BLOC DATA) ---
    grist.ready({ requiredAccess: 'full', columns: Object.values(COL_MAP).map(n => ({name: n})) });

    grist.onRecords(data => {
        state.records = [];
        // Utilisation de la m√©thode de mappage explicite (Plus stable)
        if (data && data.id) {
            for (let i = 0; i < data.id.length; i++) {
                let rec = { id: data.id[i] };
                for (let k in COL_MAP) {
                    rec[k] = data[COL_MAP[k]][i];
                }
                state.records.push(rec);
            }
        }
        updateUniques();
        handleFilters();
    });

    function updateUniques() {
        const getU = (k) => [...new Set(state.records.map(r => r[k]).filter(Boolean))].sort();
        state.uniques.projects = getU('project');
        state.uniques.teams = getU('team');
        state.uniques.assignees = getU('assignee');
        
        // Mise √† jour imm√©diate des datalists (Correctif Menu D√©roulant)
        populateDatalists();
        
        const fill = (id, arr, def) => {
            const el = document.getElementById(id);
            const val = el.value;
            el.innerHTML = `<option value="all">${def}</option>` + arr.map(x => `<option value="${x}">${x}</option>`).join('');
            if(arr.includes(val)) el.value = val;
        };
        fill('filter-project', state.uniques.projects, 'Tous les projets');
        fill('filter-team', state.uniques.teams, 'Toutes les administrations');
        fill('filter-assignee', state.uniques.assignees, 'Tous les responsables');
    }

    function populateDatalists() {
        const fillDL = (id, arr) => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = arr.map(x => `<option value="${x}">`).join('');
        };
        fillDL('list-projects', state.uniques.projects);
        fillDL('list-teams', state.uniques.teams);
        fillDL('list-assignees', state.uniques.assignees);
    }

    // --- 4. LOGIQUE UI ---
    function handleFilters() {
        state.filters.project = document.getElementById('filter-project').value;
        state.filters.team = document.getElementById('filter-team').value;
        state.filters.assignee = document.getElementById('filter-assignee').value;

        state.filtered = state.records.filter(r => {
            return (state.filters.project === 'all' || r.project === state.filters.project) &&
                   (state.filters.team === 'all' || r.team === state.filters.team) &&
                   (state.filters.assignee === 'all' || r.assignee === state.filters.assignee);
        });
        renderCurrentView();
    }

    function switchView(v) {
        state.view = v;
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        document.querySelector(`.nav-item[onclick="window.switchView('${v}')"]`).classList.add('active');
        
        const tb = document.getElementById('main-toolbar');
        const gs = document.getElementById('gantt-scale');
        
        if (v === 'dashboard') tb.style.display = 'none';
        else {
            tb.style.display = 'grid';
            gs.style.display = (v === 'gantt') ? 'block' : 'none';
        }
        renderCurrentView();
    }

    function changeGanttScale(v) {
        state.ganttScale = v;
        renderCurrentView();
    }

    function renderCurrentView() {
        const content = document.getElementById('app-content');
        content.innerHTML = '';
        if (state.view === 'dashboard') renderDashboard(content);
        else if (state.view === 'gantt') renderGantt(content);
        else renderList(content);
    }

    // --- 5. DASHBOARD ---
    function renderDashboard(container) {
        const data = state.records; 
        const total = data.length;
        const inProgress = data.filter(r => (r.progress||0) > 0 && (r.progress||0) < 100).length;
        const done = data.filter(r => (r.progress||0) == 100).length;
        const late = data.filter(r => {
            const d = Utils.fromGristDate(r.end);
            return d && d < new Date() && (r.progress||0) < 100;
        }).length;

        container.innerHTML = `
            <div class="view-container active">
                <div class="dashboard-grid">
                    <div class="stat-card"><div><div class="stat-title">Total T√¢ches</div><div class="stat-value" style="color:var(--black)">${total}</div></div><div class="stat-footer">Global</div></div>
                    <div class="stat-card"><div><div class="stat-title">En Cours</div><div class="stat-value" style="color:var(--info)">${inProgress}</div></div><div class="stat-footer">Actives</div></div>
                    <div class="stat-card"><div><div class="stat-title">Termin√©es</div><div class="stat-value text-success">${done}</div></div><div class="stat-footer">${total?Math.round(done/total*100):0}% du total</div></div>
                    <div class="stat-card"><div><div class="stat-title">En Retard</div><div class="stat-value text-danger">${late}</div></div><div class="stat-footer">Attention</div></div>
                </div>
                <div class="charts-row">
                    <div class="chart-box"><h4 style="margin-top:0">Par Priorit√©</h4>${renderBars(data, 'priority', {High: 'var(--danger)', Normal: 'var(--warning)', Low: 'var(--success)'})}</div>
                    <div class="chart-box"><h4 style="margin-top:0">Par Administration</h4>${renderBars(data, 'team')}</div>
                </div>
            </div>`;
    }

    function renderBars(data, key, colors={}) {
        const counts = {};
        data.forEach(r => { let k=r[key]||'N/A'; counts[k]=(counts[k]||0)+1; });
        const max = Math.max(...Object.values(counts), 1);
        return Object.keys(counts).map(k => {
            const pct = (counts[k]/max)*100;
            const col = colors[k] || Utils.stringToColor(k);
            return `<div class="bar-group"><div class="bar-label"><span>${k}</span><span>${counts[k]}</span></div><div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${col}"></div></div></div>`;
        }).join('');
    }

    // --- 6. GANTT ---
    function renderGantt(container) {
        const tasks = state.filtered.filter(r => r.start && r.end)
            .map(r => ({...r, startObj: Utils.fromGristDate(r.start), endObj: Utils.fromGristDate(r.end)}))
            .filter(r => r.startObj && r.endObj).sort((a,b) => a.startObj - b.startObj);

        if(!tasks.length) { container.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Aucune t√¢che planifi√©e</div>'; return; }

        let minD = new Date(Math.min(...tasks.map(t=>t.startObj)));
        let maxD = new Date(Math.max(...tasks.map(t=>t.endObj)));
        
        const nowMs = new Date().getTime();
        if(minD.getTime() < nowMs - (5*365*24*3600*1000)) minD = new Date(nowMs - (30*24*3600*1000));

        minD.setDate(minD.getDate()-3); maxD.setDate(maxD.getDate()+10);
        const dayWidth = state.ganttScale === 'day' ? 40 : (state.ganttScale === 'week' ? 15 : 5);
        const totalDays = Math.ceil((maxD - minD) / 86400000);
        
        if (totalDays > 3000) { container.innerHTML = '<div style="text-align:center;padding:40px;color:red">Plage de dates trop large</div>'; return; }
        
        const totalW = totalDays * dayWidth;

        // Header
        let headerHTML = '';
        let curr = new Date(minD);
        for(let i=0; i<totalDays; i++) {
            const d = curr.getDate();
            const m = curr.toLocaleDateString('fr-FR', {month:'short'});
            const w = curr.getDay();
            let content = '';
            let style = `position:absolute; left:${i*dayWidth}px; width:${dayWidth}px; height:100%; border-right:1px solid #f1f5f9; font-size:10px; text-align:center; padding-top:5px;`;
            
            if(state.ganttScale === 'day') {
                content = `<b>${d}</b><br>${['D','L','M','M','J','V','S'][w]}`;
                if(w===0 || w===6) style += 'background:#fafafa;';
            } else if (state.ganttScale === 'week') {
                if(w===1) { style += 'border-left:1px solid #ccc;'; content = `S${getWeekNum(curr)}<br>${m}`; }
            } else if (state.ganttScale === 'month') {
                if(d===1) { style += 'border-left:1px solid #ccc;font-weight:bold;'; content = m; }
            }
            if(content) headerHTML += `<div style="${style}">${content}</div>`;
            curr.setDate(curr.getDate()+1);
        }

        // Ligne Rouge (Correctif)
        const now = new Date();
        const diffNow = (now.getTime() - minD.getTime()) / 86400000;
        let redLine = '';
        if(diffNow >= 0 && diffNow <= totalDays) {
            redLine = `<div class="today-line" style="left:${diffNow*dayWidth}px"><div class="today-label">Auj.</div></div>`;
        }

        // Body Grouped
        let bodyHTML = redLine;
        const grouped = {};
        tasks.forEach(t => { const p = t.project || 'Sans Projet'; if(!grouped[p]) grouped[p]=[]; grouped[p].push(t); });
        const projects = Object.keys(grouped).sort();

        projects.forEach(proj => {
            bodyHTML += `<div class="gantt-group-header">${proj}</div>`;
            grouped[proj].forEach(t => {
                let startOff = (t.startObj - minD) / 86400000;
                let dur = (t.endObj - t.startObj) / 86400000 + 1;
                if(startOff < 0) { dur += startOff; startOff = 0; }
                const col = Utils.stringToColor(t.project);
                
                if (dur > 0) {
                    bodyHTML += `
                    <div class="gantt-row">
                        <div class="gantt-row-label" onclick="window.openModal(${t.id})" title="${t.title}">${t.title}</div>
                        <div class="gantt-row-track" id="track-${t.id}">
                            <div class="gantt-block" id="block-${t.id}"
                                 style="left:${startOff*dayWidth}px; width:${Math.max(dur*dayWidth, 5)}px; background:${col}"
                                 onmousedown="window.dragStart(event, ${t.id}, ${minD.getTime()}, ${dayWidth})">
                                 ${t.title}
                            </div>
                        </div>
                    </div>`;
                }
            });
        });

        container.innerHTML = `
            <div class="view-container active">
                <div class="gantt-wrapper">
                    <div class="gantt-header-row">
                        <div class="gantt-sidebar-title">Projet / T√¢che</div>
                        <div class="gantt-timeline-header" style="width:${totalW}px">${headerHTML}</div>
                    </div>
                    <div class="gantt-body" style="width:${totalW+200}px">${bodyHTML}</div>
                </div>
            </div>`;
        
        if(!window.dragActive) {
            window.addEventListener('mousemove', dragMove);
            window.addEventListener('mouseup', dragEnd);
            window.dragActive = true;
        }
    }

    function getWeekNum(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    // --- 7. DRAG LOGIC ---
    function dragStart(e, id, minTime, pxPerDay) {
        e.preventDefault(); e.stopPropagation();
        const bar = document.getElementById(`block-${id}`);
        dragState = { isDragging: true, element: bar, recordId: id, startX: e.clientX, initialLeft: parseFloat(bar.style.left), pxPerDay, minTime, hasMoved: false };
    }
    function dragMove(e) {
        if(!dragState.isDragging) return;
        dragState.hasMoved = true;
        const delta = e.clientX - dragState.startX;
        dragState.element.style.left = (dragState.initialLeft + delta) + 'px';
    }
    async function dragEnd(e) {
        if(!dragState.isDragging) return;
        if(dragState.hasMoved) {
            const days = Math.round((e.clientX - dragState.startX) / dragState.pxPerDay);
            if(days !== 0) {
                const r = state.records.find(x => x.id === dragState.recordId);
                const s = Utils.fromGristDate(r.start); s.setDate(s.getDate()+days);
                const end = Utils.fromGristDate(r.end); end.setDate(end.getDate()+days);
                await grist.selectedTable.update([{ id: r.id, fields: { [COL_MAP.start]: Utils.toGristDate(s), [COL_MAP.end]: Utils.toGristDate(end) } }]);
            } else renderCurrentView();
        } else {
            window.openModal(dragState.recordId);
        }
        dragState.isDragging = false;
    }

    // --- 8. LISTE ---
    function renderList(container) {
        let html = '<div class="view-container active"><div class="task-list">';
        if(!state.filtered.length) html += '<div style="text-align:center;color:#999">Aucune t√¢che</div>';
        
        state.filtered.forEach(r => {
            let pClass = r.priority === 'High' ? 'priority-high' : (r.priority === 'Low' ? 'priority-low' : 'priority-normal');
            let dateStr = `${Utils.formatDate(Utils.fromGristDate(r.start))} ‚ûî ${Utils.formatDate(Utils.fromGristDate(r.end))}`;
            html += `
                <div class="task-card ${pClass}" onclick="window.openModal(${r.id})">
                    <div class="card-top"><strong>${r.title}</strong><span style="font-size:11px; font-weight:bold">${r.priority||'Normal'}</span></div>
                    <div style="font-size:11px; margin-bottom:8px">
                        ${r.project ? `<span class="tag" style="background:${Utils.stringToColor(r.project)}">${r.project}</span>` : ''}
                        ${r.team ? `<span class="tag" style="background:${Utils.stringToColor(r.team)}">${r.team}</span>` : ''}
                    </div>
                    <div class="card-btm"><span>üë§ ${r.assignee||'-'}</span><span>üìÖ ${dateStr} (${r.progress||0}%)</span></div>
                </div>`;
        });
        html += '</div></div>';
        container.innerHTML = html;
    }

    // --- 9. MODAL & SAVE ---
    function addItem(id) {
        const val = prompt("Nouvelle valeur :");
        if(val) document.getElementById(id).value = val;
    }

    function openModal(id=null) {
        populateDatalists(); // Rechargement des listes
        document.getElementById('input-id').value = id || '';
        document.getElementById('input-title').value = '';
        document.getElementById('input-project').value = '';
        document.getElementById('input-team').value = '';
        document.getElementById('input-assignee').value = '';
        document.getElementById('input-priority').value = 'Normal';
        document.getElementById('input-progress').value = 0;
        document.getElementById('input-start').value = Utils.inputDate(new Date());
        document.getElementById('input-end').value = Utils.inputDate(new Date());

        if(id) {
            const r = state.records.find(x => x.id === id);
            if(r) {
                document.getElementById('input-title').value = r.title||'';
                document.getElementById('input-project').value = r.project||'';
                document.getElementById('input-team').value = r.team||'';
                document.getElementById('input-assignee').value = r.assignee||'';
                document.getElementById('input-priority').value = r.priority||'Normal';
                document.getElementById('input-start').value = Utils.inputDate(Utils.fromGristDate(r.start));
                document.getElementById('input-end').value = Utils.inputDate(Utils.fromGristDate(r.end));
                document.getElementById('input-progress').value = r.progress||0;
            }
        }
        document.getElementById('modal').classList.add('open');
    }

    function closeModal() { document.getElementById('modal').classList.remove('open'); }

    // CORRECTIF CRITIQUE: Envoi de tableaux [{...}]
    async function saveTask() {
        const id = document.getElementById('input-id').value;
        const internalData = {
            title: document.getElementById('input-title').value || 'Nouvelle T√¢che',
            project: document.getElementById('input-project').value,
            team: document.getElementById('input-team').value,
            assignee: document.getElementById('input-assignee').value,
            priority: document.getElementById('input-priority').value,
            start: Utils.toGristDate(new Date(document.getElementById('input-start').value)),
            end: Utils.toGristDate(new Date(document.getElementById('input-end').value)),
            progress: parseInt(document.getElementById('input-progress').value)
        };

        const fields = {};
        for(let k in internalData) fields[COL_MAP[k]] = internalData[k];

        try {
            if(id) await grist.selectedTable.update([{ id: parseInt(id), fields: fields }]);
            else await grist.selectedTable.create([{ fields: fields }]);
            closeModal();
        } catch (e) {
            console.error(e);
            alert("Erreur de sauvegarde. V√©rifiez les colonnes dans Grist.");
        }
    }

    // EXPORTS GLOBAUX
    window.handleFilters = handleFilters;
    window.switchView = switchView;
    window.changeGanttScale = changeGanttScale;
    window.dragStart = dragStart;
    window.openModal = openModal;
    window.closeModal = closeModal;
    window.saveTask = saveTask;
    window.addItem = addItem;

</script>
</body>
</html>
