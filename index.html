<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt'FIP - Stable V12</title>
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   
    <style>
        /* --- DESIGN SYSTEM ROBUSTE --- */
        :root {
            --primary: #4F46E5;
            --bg-body: #F8FAFC;
            --bg-surface: #FFFFFF;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;

            /* Indicateurs */
            --c-blue: #3b82f6;
            --c-green: #10b981;
            --c-red: #ef4444;    
           
            /* Priorit√©s */
            --p-critique: #ef4444;
            --p-haute: #f97316;
            --p-moyenne: #3b82f6;
            --p-basse: #94a3b8;

            --radius: 10px;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; height: 100vh; display: flex; flex-direction: column; padding: 20px; overflow: hidden; }

        /* HEADER */
        .topbar { background: var(--bg-surface); height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; box-shadow: var(--shadow); flex-shrink: 0; }
        .logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); }
        .logo span { color: var(--text-main); }
        .status { font-size: 0.75rem; background: #eff6ff; padding: 4px 10px; border-radius: 20px; color: var(--primary); font-weight: 600; }
       
        .btn-new { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-new:hover { opacity: 0.9; }

        /* NAVIGATION */
        .toolbar { display: flex; justify-content: space-between; margin-bottom: 20px; flex-shrink: 0; }
        .tabs { background: #e2e8f0; padding: 4px; border-radius: 8px; display: flex; }
        .tab { padding: 6px 16px; border: none; background: transparent; font-weight: 600; color: var(--text-muted); cursor: pointer; border-radius: 6px; font-size: 0.85rem; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
       
        .filters { display: flex; gap: 10px; }
        select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; background: white; cursor: pointer; }

        /* CONTENU */
        .content { flex: 1; background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; position: relative; }
        .view { position: absolute; inset: 0; padding: 25px; overflow-y: auto; display: none; }
        .view.active { display: block; }

        /* DASHBOARD */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
        .card-lbl { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
        .card-val { font-size: 2rem; font-weight: 800; line-height: 1; }
        .card-sub { font-size: 0.85rem; font-weight: 600; margin-top: 5px; }
       
        .c-blue { color: var(--c-blue); } .c-green { color: var(--c-green); } .c-red { color: var(--c-red); }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: #fafafa; border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
        .stat-head { font-weight: 700; font-size: 0.95rem; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
       
        .bar-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
        .bar-lbl { width: 120px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-track { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; margin: 0 10px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 4px; }
        .bar-num { width: 30px; text-align: right; font-weight: 700; }

        .sect-head { font-size: 1.1rem; font-weight: 700; margin: 10px 0 15px 0; color: var(--text-main); border-left: 4px solid var(--primary); padding-left: 10px; }

        /* TABLEAUX */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 12px 15px; background: #f8fafc; color: var(--text-muted); font-weight: 700; border-bottom: 1px solid var(--border); position: sticky; top: 0; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover td { background: #f1f5f9; cursor: pointer; }

        .badge { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .b-team { background: #1e293b; color: white; margin-top: 4px; }
        .b-proj { background: #e0e7ff; color: var(--primary); margin-left: 8px; }

        /* GANTT */
        .gantt-wrapper { overflow: auto; height: 100%; }
        /* Style Image Clean */
        .gantt .grid-header { background: #fff; height: 50px; }
        .gantt .grid-row { fill: #fff; }
        .gantt .grid-row:nth-child(even) { fill: #fcfcfc; }
        .gantt .row-line { stroke: #f1f5f9; }
        .gantt .bar { rx: 3px; ry: 3px; }
        .gantt .bar-label { fill: #1e293b; font-weight: 600; font-size: 12px; }
       
        .bar-critique .bar { fill: var(--p-critique) !important; }
        .bar-haute .bar { fill: var(--p-haute) !important; }
        .bar-moyenne .bar { fill: var(--p-moyenne) !important; }
        .bar-basse .bar { fill: var(--p-basse) !important; }

        .zoom-ctrl { display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 10px; }
        .z-btn { background: white; border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .z-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal.mini { width: 350px; border-top: 4px solid var(--primary); }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
        .grp { display: flex; gap: 5px; }
        .btn-plus { width: 35px; background: #eff6ff; border: 1px solid #dbeafe; color: var(--primary); border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        .footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-sec { background: transparent; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

    <div class="topbar">
        <div class="logo">Gantt'<span>FIP</span></div>
        <div class="status" id="syncStatus">Pr√™t</div>
        <button class="btn-new" onclick="openModal()">+ Nouvelle T√¢che</button>
    </div>

    <div class="toolbar">
        <div class="tabs">
            <button class="tab active" onclick="nav('dashboard', this)">Tableau de Bord</button>
            <button class="tab" onclick="nav('gantt', this)">Planning Gantt</button>
            <button class="tab" onclick="nav('list', this)">Liste</button>
        </div>
        <div class="filters">
            <select id="fProj" onchange="render()"><option value="">Projets</option></select>
            <select id="fTeam" onchange="render()"><option value="">Administrations</option></select>
            <select id="fAgent" onchange="render()"><option value="">Agents</option></select>
        </div>
    </div>

    <div class="content">
        <div id="view-dashboard" class="view active">
            <div class="kpi-row">
                <div class="card"><div class="card-lbl">Total T√¢ches</div><div class="card-val" id="k-total">0</div></div>
                <div class="card"><div class="card-lbl">En Cours</div><div class="card-val c-blue" id="k-cours">0</div></div>
                <div class="card"><div class="card-lbl">Termin√©es</div><div class="card-val c-green" id="k-done">0</div><div class="card-sub c-green" id="k-rate">0%</div></div>
                <div class="card"><div class="card-lbl">Retard</div><div class="card-val c-red" id="k-late">0</div></div>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-head">R√©partition par Priorit√©</div>
                    <div id="stats-prio"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-head">Charge par Administration</div>
                    <div id="stats-team"></div>
                </div>
            </div>

            <div class="sect-head">üìÖ T√¢ches √† venir</div>
            <table>
                <thead><tr><th>T√¢che</th><th>Responsable</th><th>√âch√©ance</th><th>Statut</th></tr></thead>
                <tbody id="tb-dash"></tbody>
            </table>
        </div>

        <div id="view-gantt" class="view">
            <div class="zoom-ctrl">
                <button class="z-btn" onclick="zoom('Day', this)">Jour</button>
                <button class="z-btn active" onclick="zoom('Week', this)">Semaine</button>
                <button class="z-btn" onclick="zoom('Month', this)">Mois</button>
            </div>
            <div id="gantt-chart" class="gantt-wrapper"></div>
        </div>

        <div id="view-list" class="view">
            <div class="sect-head">üóÇÔ∏è Inventaire Complet</div>
            <table>
                <thead><tr><th>T√¢che</th><th>Responsable</th><th>Fin</th><th>Priorit√©</th><th>Avancement</th></tr></thead>
                <tbody id="tb-list"></tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="mod-task">
        <div class="modal">
            <h2 style="margin-top:0">T√¢che</h2>
            <form id="form-task">
                <input type="hidden" id="i-id">
                <div style="margin-bottom:15px"><label>Titre</label><input type="text" id="i-title" required></div>
                <div class="row">
                    <div><label>Projet</label><div class="grp"><select id="i-proj" required></select><button type="button" class="btn-plus" onclick="modQC('proj')">+</button></div></div>
                    <div><label>Responsable</label><div class="grp"><select id="i-agent"></select><button type="button" class="btn-plus" onclick="modQC('agent')">+</button></div></div>
                </div>
                <div class="row">
                    <div><label>D√©but</label><input type="date" id="i-start" required></div>
                    <div><label>Fin</label><input type="date" id="i-end" required></div>
                </div>
                <div class="row">
                    <div><label>Avancement %</label><input type="number" id="i-prog" min="0" max="100"></div>
                    <div><label>Priorit√©</label>
                        <select id="i-prio">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne" selected>Moyenne</option>
                            <option value="Haute">Haute</option>
                            <option value="Critique">Critique</option>
                        </select>
                    </div>
                </div>
                <div class="footer">
                    <button type="button" class="btn-sec" onclick="closeAll()">Annuler</button>
                    <button type="submit" class="btn-new">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="mod-qc">
        <div class="modal mini">
            <h3 id="qc-title">Nouveau</h3>
            <input type="hidden" id="qc-type">
            <div style="margin:15px 0">
                <label>Nom</label><input type="text" id="qc-name">
                <div id="qc-extra" style="margin-top:10px; display:none;">
                    <label>Administration</label>
                    <div class="grp"><select id="qc-team-sel"></select><button type="button" class="btn-plus" onclick="modQC('team')">+</button></div>
                </div>
            </div>
            <div class="footer">
                <button type="button" class="btn-sec" onclick="closeAll()">Fermer</button>
                <button type="button" class="btn-new" onclick="saveQC()">Cr√©er</button>
            </div>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <script>
        const DB = { T: 'TACHES_MASTER', A: 'AGENTS', P: 'PROJETS', E: 'EQUIPES' };
        let D = { t: [], a: [], p: [], e: [] };
        let gantt = null;

        grist.ready({ requiredAccess: 'full' });
        grist.onRecords(async () => await load());

        async function load() {
            try {
                const [rT, rA, rP, rE] = await Promise.all([
                    grist.docApi.fetchTable(DB.T), grist.docApi.fetchTable(DB.A),
                    grist.docApi.fetchTable(DB.P), grist.docApi.fetchTable(DB.E)
                ]);

                D.e = map(rE).map(x => ({ id: x.id, name: x.Nom || x.Nom_Equipe || "N/A" }));
                D.p = map(rP).map(x => ({ id: x.id, name: x.Nom_Projet || x.Nom }));
               
                D.a = map(rA).map(a => {
                    const tm = D.e.find(x => x.id === a.Equipe);
                    return { id: a.id, name: a.Nom_Complet || a.Nom, team: tm ? tm.name : null };
                });

                D.t = map(rT).map(t => {
                    const ag = D.a.find(x => x.id === t.Responsable) || { name: 'Non assign√©', team: null };
                    const pr = D.p.find(x => x.id === t.Projet) || { name: 'Aucun' };
                   
                    let cls = 'bar-basse';
                    if(t.Priorite == 'Critique') cls = 'bar-critique';
                    if(t.Priorite == 'Haute') cls = 'bar-haute';
                    if(t.Priorite == 'Moyenne') cls = 'bar-moyenne';

                    return {
                        ...t, id: t.id.toString(),
                        aname: ag.name, ateam: ag.team, pname: pr.name,
                        name: t.Titre, start: fmt(t.Date_Debut), end: fmt(t.Date_Fin),
                        progress: t.Avancement||0, dependencies: t.Dependances||"", custom_class: cls
                    };
                });

                D.t.sort((a,b) => new Date(a.start) - new Date(b.start));
                render();
            } catch(e) { console.error(e); }
        }

        function render() {
            fillSel();
            const fp = document.getElementById('fProj').value;
            const ft = document.getElementById('fTeam').value;
            const fa = document.getElementById('fAgent').value;

            const res = D.t.filter(t =>
                (fp === "" || t.Projet == fp) &&
                (ft === "" || (t.ateam && t.ateam == ft)) &&
                (fa === "" || t.Responsable == fa)
            );

            // Dashboard
            const tot = res.length;
            const done = res.filter(t=>t.progress==100).length;
            const active = res.filter(t=>t.progress>0 && t.progress<100).length;
            const late = res.filter(t=>new Date(t.end)<new Date() && t.progress<100).length;

            document.getElementById('k-total').innerText = tot;
            document.getElementById('k-cours').innerText = active;
            document.getElementById('k-done').innerText = done;
            document.getElementById('k-rate').innerText = tot ? Math.round((done/tot)*100)+"%" : "0%";
            document.getElementById('k-late').innerText = late;

            // Stats Prio
            const pCounts = { 'Critique':0, 'Haute':0, 'Moyenne':0, 'Basse':0 };
            const pCols = { 'Critique':'#ef4444', 'Haute':'#f97316', 'Moyenne':'#3b82f6', 'Basse':'#94a3b8' };
            res.forEach(t => { if(pCounts[t.Priorite]!==undefined) pCounts[t.Priorite]++; });
            let hP = "";
            for(const [k,v] of Object.entries(pCounts)) {
                if(v>0) {
                    const pc = Math.round((v/tot)*100);
                    hP += `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${pc}%;background:${pCols[k]}"></div></div><div class="bar-num">${v}</div></div>`;
                }
            }
            document.getElementById('stats-prio').innerHTML = hP || "<div style='color:#999'>Rien</div>";

            // Stats Team
            const tCounts = {};
            res.forEach(t => { const tm = t.ateam||"Sans Admin"; tCounts[tm]=(tCounts[tm]||0)+1; });
            let hT = "";
            for(const [k,v] of Object.entries(tCounts)) {
                const pc = Math.round((v/tot)*100);
                const col = strColor(k);
                hT += `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${pc}%;background:${col}"></div></div><div class="bar-num">${v}</div></div>`;
            }
            document.getElementById('stats-team').innerHTML = hT || "<div style='color:#999'>Rien</div>";

            // Listes
            const tbD = document.getElementById('tb-dash');
            const tbL = document.getElementById('tb-list');
            tbD.innerHTML = ""; tbL.innerHTML = "";

            // Upcoming dashboard
            const upcoming = res.filter(t => t.progress<100 && new Date(t.end)>=new Date()).slice(0,5);
           
            const rowBuilder = (t) => {
                const bdgT = t.ateam ? `<br><span class="badge b-team">${t.ateam}</span>` : '';
                return `<tr onclick="openModal('${t.id}')">
                    <td><div style="font-weight:600">${t.Titre}</div><span class="badge b-proj">${t.pname}</span></td>
                    <td>${t.aname}${bdgT}</td>
                    <td>${t.end}</td>
                    <td>${t.progress}%</td>
                </tr>`;
            };
           
            upcoming.forEach(t => tbD.innerHTML += rowBuilder(t));
            if(!upcoming.length) tbD.innerHTML = "<tr><td colspan='4' style='text-align:center;padding:15px;color:#999'>Aucune t√¢che</td></tr>";

            // Full list
            res.forEach(t => {
                const bdgT = t.ateam ? `<br><span class="badge b-team">${t.ateam}</span>` : '';
                tbL.innerHTML += `<tr onclick="openModal('${t.id}')">
                    <td><div style="font-weight:600">${t.Titre}</div><span class="badge b-proj">${t.pname}</span></td>
                    <td>${t.aname}${bdgT}</td>
                    <td>${t.end}</td>
                    <td>${t.Priorite}</td>
                    <td>${t.progress}%</td>
                </tr>`;
            });

            // Gantt
            document.getElementById('gantt-chart').innerHTML = "";
            if(res.length) {
                res.sort((a,b) => (a.pname > b.pname) ? 1 : -1); // Sort by project
                gantt = new Gantt("#gantt-chart", res, {
                    header_height: 50, column_width: 30, step: 24, view_modes: ['Day', 'Week', 'Month'],
                    bar_height: 25, bar_corner_radius: 3, arrow_curve: 5, padding: 18, view_mode: 'Week',
                    date_format: 'YYYY-MM-DD', language: 'fr',
                    on_click: t => openModal(t.id),
                    on_date_change: (t,s,e) => act('UpdateRecord', DB.T, t.id, {Date_Debut:fmt(s), Date_Fin:fmt(e)}),
                    on_progress_change: (t,p) => act('UpdateRecord', DB.T, t.id, {Avancement:p})
                });
            } else {
                document.getElementById('gantt-chart').innerHTML = "<p style='text-align:center;padding:20px;color:#999'>Rien √† afficher</p>";
            }
        }

        /* --- LOGIC MODALS --- */
        function openModal(id=null) {
            if(id && typeof id === 'string') {
                const t = D.t.find(x => x.id == id);
                document.getElementById('i-id').value = t.id;
                document.getElementById('i-title').value = t.Titre;
                document.getElementById('i-proj').value = t.Projet;
                document.getElementById('i-agent').value = t.Responsable;
                document.getElementById('i-start').value = t.start;
                document.getElementById('i-end').value = t.end;
                document.getElementById('i-prog').value = t.progress;
                document.getElementById('i-prio').value = t.Priorite;
            } else {
                document.getElementById('form-task').reset();
                document.getElementById('i-id').value = "";
                const now = new Date().toISOString().split('T')[0];
                document.getElementById('i-start').value = now;
                document.getElementById('i-end').value = now;
            }
            document.getElementById('mod-task').style.display='flex';
        }

        // QUICK CREATE LOGIC
        function modQC(type) {
            document.getElementById('qc-type').value = type;
            document.getElementById('qc-name').value = '';
            document.getElementById('qc-extra').style.display = 'none';
           
            let title = "Nouveau";
            if(type=='proj') title="Nouveau Projet";
            if(type=='team') title="Nouvelle Administration";
            if(type=='agent') {
                title="Nouvel Agent";
                document.getElementById('qc-extra').style.display = 'block';
                // Remplir le select team du mini modal
                fillBox('#qc-team-sel', D.e);
            }
           
            document.getElementById('qc-title').innerText = title;
            document.getElementById('mod-qc').style.display='flex';
        }

        async function saveQC() {
            const type = document.getElementById('qc-type').value;
            const name = document.getElementById('qc-name').value;
            if(!name) return;

            let tab = '', fields = {};
            if(type=='proj') { tab=DB.P; fields={Nom_Projet:name}; }
            else if(type=='team') {
                // CORRECTION: Juste le nom, pas de couleur
                tab=DB.E; fields={Nom:name};
            }
            else if(type=='agent') {
                tab=DB.A;
                const tId = document.getElementById('qc-team-sel').value;
                fields={Nom_Complet:name, Equipe: tId ? parseInt(tId) : null};
            }

            await act('AddRecord', tab, null, fields);
            await load(); // Reload all to link
            closeAll();
        }

        document.getElementById('form-task').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('i-id').value;
            const d = {
                Titre: document.getElementById('i-title').value,
                Projet: parseInt(document.getElementById('i-proj').value),
                Responsable: parseInt(document.getElementById('i-agent').value),
                Date_Debut: document.getElementById('i-start').value,
                Date_Fin: document.getElementById('i-end').value,
                Avancement: parseInt(document.getElementById('i-prog').value),
                Priorite: document.getElementById('i-prio').value
            };
            await act(id?'UpdateRecord':'AddRecord', DB.T, id, d);
            closeAll();
        };

        async function act(a, t, id, f) {
            const args = a === 'AddRecord' ? [null, f] : [parseInt(id), f];
            try { await grist.docApi.applyUserActions([[a, t, ...args]]); }
            catch(e) { alert("Erreur: "+e.message); }
        }

        function closeAll() { document.querySelectorAll('.modal-overlay').forEach(x=>x.style.display='none'); }

        // UTILS
        function fillSel() {
            fillBox('#fProj', D.p); fillBox('#i-proj', D.p);
            fillBox('#fTeam', D.e);
            fillBox('#fAgent', D.a); fillBox('#i-agent', D.a);
        }
        function fillBox(sel, list) {
            document.querySelectorAll(sel).forEach(el => {
                const v = el.value; const d = el.options[0]; el.innerHTML=""; el.appendChild(d);
                list.forEach(i=>{ const o=document.createElement('option'); o.value=i.id; o.innerText=i.name; el.appendChild(o); });
                if(list.some(i=>i.id==v)) el.value=v;
            });
        }
        function map(t) { const k=Object.keys(t); if(!k.length)return[]; const r=[]; for(let i=0;i<t.id.length;i++){ let o={}; k.forEach(key=>o[key]=t[key][i]); r.push(o); } return r; }
        function fmt(v) { if(!v) return new Date().toISOString().split('T')[0]; const d = typeof v==='number'?new Date(v*1000):new Date(v); return d.toISOString().split('T')[0]; }
        function nav(v, b) {
            document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active'); b.classList.add('active');
            if(v=='gantt' && gantt) setTimeout(()=>gantt.refresh(D.t), 50);
        }
        function zoom(m, b) {
            document.querySelectorAll('.z-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
            gantt.change_view_mode(m);
        }
        function strColor(s) {
            let h=0; for(let i=0;i<s.length;i++) h=s.charCodeAt(i)+((h<<5)-h);
            return '#'+(h&0x00FFFFFF).toString(16).toUpperCase().padStart(6,'0');
        }
    </script>
</body>
</html>
