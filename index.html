<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt'FIP - V15 FINAL</title>
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
   
    <style>
        /* --- DESIGN SYSTEM (Style V10 Valid√©) --- */
        :root {
            --primary: #4F46E5; --bg-app: #F8FAFC; --bg-surface: #FFFFFF;
            --text-main: #1E293B; --text-muted: #64748B; --border: #E2E8F0;
            --c-blue: #3B82F6; --c-green: #10B981; --c-red: #EF4444;
            --g-critique: #EF4444; --g-haute: #F97316; --g-moyenne: #3B82F6; --g-basse: #94A3B8;
            --radius: 10px; --shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .topbar { background: var(--bg-surface); height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; box-shadow: var(--shadow); flex-shrink: 0; }
        .logo { font-weight: 800; font-size: 1.3rem; color: var(--primary); } .logo span { color: var(--text-main); }
        .sync-badge { font-size: 0.75rem; background: #fff; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border); display: flex; gap: 6px; align-items: center; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .btn-new { background: var(--primary); color: white; padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; }

        /* TOOLBAR */
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .nav-pills { display: flex; background: #E2E8F0; padding: 4px; border-radius: 8px; }
        .nav-btn { padding: 6px 16px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--text-muted); border-radius: 6px; }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: var(--shadow); }
        .filters { display: flex; gap: 10px; }
        select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; min-width: 150px; background: white; cursor: pointer; }

        /* CONTENT */
        .workspace { flex: 1; background: var(--bg-surface); border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden; position: relative; }
        .view-pane { position: absolute; inset: 0; padding: 25px; overflow-y: auto; display: none; }
        .view-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DASHBOARD */
        .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { padding: 20px; background: white; border: 1px solid var(--border); border-radius: 12px; }
        .card-lbl { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
        .card-val { font-size: 2rem; font-weight: 800; }
        .card-sub { font-size: 0.8rem; font-weight: 600; margin-top: 5px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: #FAFAFA; border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .stat-head { font-weight: 700; border-bottom: 1px solid #E2E8F0; padding-bottom: 10px; margin-bottom: 10px; }
        .bar-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
        .bar-lbl { width: 130px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-track { flex: 1; height: 8px; background: #E2E8F0; border-radius: 4px; margin: 0 10px; }
        .bar-fill { height: 100%; border-radius: 4px; }
        .bar-val { width: 30px; text-align: right; font-weight: 700; }

        .sect-title { font-size: 1.1rem; font-weight: 700; margin: 0 0 15px 0; border-left: 4px solid var(--primary); padding-left: 10px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { padding: 12px 15px; background: #F8FAFC; text-align: left; color: var(--text-muted); font-weight: 700; position: sticky; top: 0; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); vertical-align: top; }
        tr:hover td { background: #F8FAFC; cursor: pointer; }

        .badge { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; margin-top: 3px; }
        .badge-team { background: #1E293B; color: white; text-transform: uppercase; margin-top: 4px; } /* Badge sous le nom */
        .agent-stack { display: flex; flex-direction: column; align-items: flex-start; }

        /* GANTT */
        .gantt-wrapper { overflow: auto; height: 100%; }
        .gantt .grid-header { background: #fff; height: 50px; }
        .gantt .grid-row { fill: #fff; } .gantt .grid-row:nth-child(even) { fill: #FCFCFC; }
        .gantt .bar { rx: 3px; ry: 3px; stroke: none; }
        .bar-critique .bar { fill: var(--g-critique) !important; }
        .bar-haute .bar { fill: var(--g-haute) !important; }
        .bar-moyenne .bar { fill: var(--g-moyenne) !important; }
        .bar-basse .bar { fill: var(--g-basse) !important; }
        .zoom-tools { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 10px; }
        .btn-zoom { background: white; border: 1px solid var(--border); padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
        .btn-zoom.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* MODALS */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; width: 500px; padding: 30px; border-radius: 12px; }
        .modal.mini { width: 350px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; }
        .grp { display: flex; gap: 5px; }
        .btn-plus { width: 35px; border: 1px solid var(--border); background: #F1F5F9; color: var(--primary); border-radius: 6px; cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; }
        .m-foot { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="topbar">
        <div class="logo">Gantt'<span>FIP</span></div>
        <div class="sync-badge"><div class="dot" id="syncDot"></div> <span id="syncText">Init...</span></div>
        <button class="btn-new" onclick="openModal()">+ T√¢che</button>
    </div>

    <div class="toolbar">
        <div class="nav-pills">
            <button class="nav-btn active" onclick="switchView('dashboard', this)">Tableau de Bord</button>
            <button class="nav-btn" onclick="switchView('gantt', this)">Planning Gantt</button>
            <button class="nav-btn" onclick="switchView('list', this)">Liste</button>
        </div>
        <div class="filters">
            <select id="fProj" onchange="applyFilters()"><option value="">Tous les Projets</option></select>
            <select id="fTeam" onchange="applyFilters()"><option value="">Toutes les Admin.</option></select>
            <select id="fAgent" onchange="applyFilters()"><option value="">Tous les Agents</option></select>
        </div>
    </div>

    <div class="workspace">
       
        <div id="view-dashboard" class="view-pane active">
            <div class="kpi-row">
                <div class="card"><div class="card-lbl">Total</div><div class="card-val" id="k-total">0</div></div>
                <div class="card"><div class="card-lbl">En Cours</div><div class="card-val" style="color:var(--c-blue)" id="k-cours">0</div></div>
                <div class="card"><div class="card-lbl">Termin√©es</div><div class="card-val" style="color:var(--c-green)" id="k-done">0</div><div class="card-sub" style="color:var(--c-green)" id="k-rate">0%</div></div>
                <div class="card"><div class="card-lbl">Retard</div><div class="card-val" style="color:var(--c-red)" id="k-late">0</div></div>
            </div>

            <div class="stats-grid">
                <div class="stat-box"><div class="stat-head">R√©partition par Priorit√©</div><div id="stats-prio"></div></div>
                <div class="stat-box"><div class="stat-head">Charge par Administration</div><div id="stats-team"></div></div>
            </div>

            <div class="sect-title">üìÖ T√¢ches √† venir</div>
            <table>
                <thead><tr><th>T√¢che & Projet</th><th>Responsable</th><th>√âch√©ance</th><th>Statut</th></tr></thead>
                <tbody id="upcomingListBody"></tbody>
            </table>
        </div>

        <div id="view-gantt" class="view-pane">
            <div class="zoom-tools">
                <button class="btn-zoom" onclick="zoomGantt('Day')">Jour</button>
                <button class="btn-zoom active" onclick="zoomGantt('Week')">Semaine</button>
                <button class="btn-zoom" onclick="zoomGantt('Month')">Mois</button>
            </div>
            <div id="gantt-chart" class="gantt-wrapper"></div>
        </div>

        <div id="view-list" class="view-pane">
            <div class="sect-title">üóÇÔ∏è Inventaire Complet</div>
            <table>
                <thead><tr><th>T√¢che & Projet</th><th>Responsable</th><th>Fin</th><th>Priorit√©</th><th>Progression</th></tr></thead>
                <tbody id="fullListBody"></tbody>
            </table>
        </div>
    </div>

    <div class="overlay" id="taskModal">
        <div class="modal">
            <div style="display:flex;justify-content:space-between;margin-bottom:20px"><h2 style="margin:0">T√¢che</h2><button onclick="closeModal()" style="border:none;background:none;cursor:pointer;font-size:1.2rem">‚úï</button></div>
            <form id="taskForm">
                <input type="hidden" id="inpId">
                <div style="margin-bottom:15px"><label>Titre</label><input type="text" id="inpTitle" required></div>
                <div class="form-grid">
                    <div><label>Projet</label><div class="grp"><select id="inpProject" required></select><button type="button" class="btn-plus" onclick="openQC('Project')">+</button></div></div>
                    <div><label>Responsable</label><div class="grp"><select id="inpAgent"></select><button type="button" class="btn-plus" onclick="openQC('Agent')">+</button></div></div>
                </div>
                <div class="form-grid"><div><label>D√©but</label><input type="date" id="inpStart" required></div><div><label>Fin</label><input type="date" id="inpEnd" required></div></div>
                <div class="form-grid">
                    <div><label>Avancement %</label><input type="number" id="inpProgress" min="0" max="100"></div>
                    <div><label>Priorit√©</label><select id="inpPriority"><option value="Basse">Basse</option><option value="Moyenne" selected>Moyenne</option><option value="Haute">Haute</option><option value="Critique">Critique</option></select></div>
                </div>
                <div class="m-foot"><button type="button" onclick="closeModal()" style="padding:8px 16px;border:1px solid #ddd;background:none;border-radius:6px;cursor:pointer">Annuler</button><button type="submit" style="padding:8px 16px;border:none;background:var(--primary);color:white;border-radius:6px;cursor:pointer">Enregistrer</button></div>
            </form>
        </div>
    </div>

    <div class="overlay" id="qcModal">
        <div class="modal mini">
            <h3 id="qcTitle">Nouveau</h3><input type="hidden" id="qcType">
            <div style="margin:15px 0"><label>Nom</label><input type="text" id="qcName"></div>
            <div id="qcExtra" style="display:none;margin-bottom:15px"><label>Administration</label><div class="grp"><select id="qcTeamSel"></select><button type="button" class="btn-plus" onclick="openQC('Team')">+</button></div></div>
            <div class="m-foot"><button type="button" onclick="closeQC()" style="padding:8px 16px;border:1px solid #ddd;background:none;border-radius:6px;cursor:pointer">Fermer</button><button type="button" onclick="saveQC()" style="padding:8px 16px;border:none;background:var(--primary);color:white;border-radius:6px;cursor:pointer">Cr√©er</button></div>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>

    <script>
        const DB = { TASKS: 'TACHES_MASTER', AGENTS: 'AGENTS', PROJECTS: 'PROJETS', TEAMS: 'EQUIPES' };
        let appData = { tasks: [], agents: [], projects: [], teams: [] };
        let ganttChart = null;

        grist.ready({ requiredAccess: 'full' });
        grist.onRecords(async function() {
            updateSyncStatus("Sync...", "orange");
            await loadAllData();
            updateSyncStatus("Connect√©", "var(--c-green)");
        });

        // --- CHARGEMENT DONN√âES (MOTEUR IDENTIQUE √Ä CELUI QUI MARCHE) ---
        async function loadAllData() {
            try {
                const [rTasks, rAgents, rProjects, rTeams] = await Promise.all([
                    grist.docApi.fetchTable(DB.TASKS), grist.docApi.fetchTable(DB.AGENTS),
                    grist.docApi.fetchTable(DB.PROJECTS), grist.docApi.fetchTable(DB.TEAMS)
                ]);

                // 1. Teams & Projets
                appData.teams = convertTable(rTeams).map(r => ({ id: r.id, name: r.Nom || r.Nom_Equipe || "√âquipe" }));
                appData.projects = convertTable(rProjects).map(r => ({ id: r.id, name: r.Nom_Projet || r.Nom }));
               
                // 2. Agents (Lien Equipe)
                appData.agents = convertTable(rAgents).map(r => {
                    const team = appData.teams.find(t => t.id === r.Equipe);
                    return { id: r.id, name: r.Nom_Complet || r.Nom, teamName: team ? team.name : null };
                });

                // 3. T√¢ches (Lien Agent + Projet)
                appData.tasks = convertTable(rTasks).map(t => {
                    const agent = appData.agents.find(a => a.id === t.Responsable) || { name: 'Non assign√©', teamName: null };
                    const project = appData.projects.find(p => p.id === t.Projet) || { name: 'Aucun' };
                   
                    let color = 'bar-basse';
                    if(t.Priorite === 'Critique') color = 'bar-critique';
                    else if(t.Priorite === 'Haute') color = 'bar-haute';
                    else if(t.Priorite === 'Moyenne') color = 'bar-moyenne';

                    // CREATION DES VARIABLES CL√âS (displayAgent, displayTeam...)
                    return {
                        ...t, id: t.id.toString(),
                        displayAgent: agent.name, displayTeam: agent.teamName, displayProject: project.name,
                        name: t.Titre, start: formatDateIso(t.Date_Debut), end: formatDateIso(t.Date_Fin),
                        progress: t.Avancement || 0, dependencies: t.Dependances || "", custom_class: color
                    };
                });
               
                appData.tasks.sort((a,b) => new Date(a.start) - new Date(b.start));
                refreshUI();
            } catch (e) { console.error(e); updateSyncStatus("Erreur", "red"); }
        }

        // --- AFFICHAGE (UI CORRIG√âE POUR UTILISER LES VARIABLES CI-DESSUS) ---
        function refreshUI() { populateSelects(); applyFilters(); }

        function applyFilters() {
            const fP = document.getElementById('filterProject').value;
            const fT = document.getElementById('filterTeam').value;
            const fA = document.getElementById('filterAgent').value;

            // Filtre sur displayProject et displayTeam
            const res = appData.tasks.filter(t =>
                (fP === "" || t.displayProject == fP) &&
                (fT === "" || (t.displayTeam && t.displayTeam == fT)) &&
                (fA === "" || t.Responsable == fA)
            );

            renderDashboard(res);
            renderList(res);
            renderGantt(res);
        }

        function renderDashboard(tasks) {
            const tot = tasks.length;
            const done = tasks.filter(t=>t.progress==100).length;
            const active = tasks.filter(t=>t.progress>0 && t.progress<100).length;
            const late = tasks.filter(t=>new Date(t.end)<new Date() && t.progress<100).length;
            const rate = tot ? Math.round((done/tot)*100) : 0;

            document.getElementById('kpi-total').innerText = tot;
            document.getElementById('kpi-cours').innerText = active;
            document.getElementById('kpi-done').innerText = done;
            document.getElementById('kpi-rate').innerText = rate + "%";
            document.getElementById('kpi-retard').innerText = late;

            // Stats Prio
            const pMap = {'Critique':0,'Haute':0,'Moyenne':0,'Basse':0};
            const pCols = {'Critique':'#EF4444','Haute':'#F97316','Moyenne':'#3B82F6','Basse':'#94A3B8'};
            tasks.forEach(t => { if(pMap[t.Priorite]!==undefined) pMap[t.Priorite]++; });
            let hP = "";
            for(const [k,v] of Object.entries(pMap)) {
                if(v>0) {
                    const pc = Math.round((v/tot)*100);
                    hP += `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${pc}%;background:${pCols[k]}"></div></div><div class="bar-val">${v}</div></div>`;
                }
            }
            document.getElementById('stats-prio').innerHTML = hP || "<div style='color:#999'>Rien</div>";

            // Stats Admin (Team) - Utilise displayTeam
            const tMap = {};
            tasks.forEach(t => { const tm = t.displayTeam||"Sans Admin"; tMap[tm]=(tMap[tm]||0)+1; });
            let hT = "";
            for(const [k,v] of Object.entries(tMap)) {
                const pc = Math.round((v/tot)*100);
                const col = strColor(k);
                hT += `<div class="bar-row"><div class="bar-lbl">${k}</div><div class="bar-track"><div class="bar-fill" style="width:${pc}%;background:${col}"></div></div><div class="bar-val">${v}</div></div>`;
            }
            document.getElementById('stats-team').innerHTML = hT || "<div style='color:#999'>Rien</div>";

            // Liste T√¢ches √† venir
            const upcoming = tasks.filter(t => t.progress<100 && new Date(t.end)>=new Date()).slice(0,5);
            const tb = document.getElementById('upcomingListBody');
            tb.innerHTML = "";
            upcoming.forEach(t => {
                const bdgT = t.displayTeam ? `<br><span class="badge badge-team" style="background:${strColor(t.displayTeam)}">${t.displayTeam}</span>` : '';
                tb.innerHTML += `<tr onclick="openModalById('${t.id}')"><td><div style="font-weight:600">${t.Titre}</div><span class="badge" style="background:${strColor(t.displayProject)}33;color:${strColor(t.displayProject)}">${t.displayProject}</span></td><td>${t.displayAgent}${bdgT}</td><td>${t.end}</td><td><span style="color:var(--c-blue);font-weight:700">${t.progress}%</span></td></tr>`;
            });
            if(!upcoming.length) tb.innerHTML = "<tr><td colspan='4' style='text-align:center;padding:15px;color:#999'>Aucune t√¢che √† venir</td></tr>";
        }

        function renderList(tasks) {
            const tb = document.getElementById('fullListBody');
            tb.innerHTML = "";
            tasks.forEach(t => {
                const bdgT = t.displayTeam ? `<br><span class="badge badge-team" style="background:${strColor(t.displayTeam)}">${t.displayTeam}</span>` : '';
                tb.innerHTML += `<tr onclick="openModalById('${t.id}')"><td><div style="font-weight:600">${t.Titre}</div><span class="badge" style="background:${strColor(t.displayProject)}33;color:${strColor(t.displayProject)}">${t.displayProject}</span></td><td><div class="agent-stack"><span style="font-weight:600">${t.displayAgent}</span>${bdgT}</div></td><td>${t.end}</td><td>${t.Priorite}</td><td>${t.progress}%</td></tr>`;
            });
        }

        function renderGantt(tasks) {
            const el = document.getElementById('gantt-chart');
            el.innerHTML = "";
            if(!tasks.length) { el.innerHTML="<p style='text-align:center;padding:20px;color:#999'>Rien √† afficher</p>"; return; }
           
            const gData = [...tasks].sort((a,b) => (a.displayProject > b.displayProject) ? 1 : -1);
            ganttChart = new Gantt("#gantt-chart", gData, {
                header_height: 50, column_width: 30, step: 24, view_modes: ['Day', 'Week', 'Month'],
                bar_height: 25, bar_corner_radius: 3, arrow_curve: 5, padding: 18, view_mode: 'Week',
                date_format: 'YYYY-MM-DD', language: 'fr',
                on_click: t => openModalById(t.id),
                on_date_change: (t,s,e) => saveAction('UpdateRecord', DB.TASKS, t.id, {Date_Debut:formatDateIso(s), Date_Fin:formatDateIso(e)}),
                on_progress_change: (t,p) => saveAction('UpdateRecord', DB.TASKS, t.id, {Avancement:p})
            });
        }

        // --- ACTIONS ---
        async function saveAction(action, table, rowId, fields) {
            updateSyncStatus("Sauvegarde...", "orange");
            const args = action === 'AddRecord' ? [null, fields] : [parseInt(rowId), fields];
            try { await grist.docApi.applyUserActions([[action, table, ...args]]); }
            catch (e) { alert("Erreur : " + e.message); updateSyncStatus("Erreur", "red"); }
        }

        function openQC(type) {
            document.getElementById('qcType').value = type;
            document.getElementById('qcName').value = '';
            document.getElementById('qcExtra').style.display = 'none';
            let t = "Nouveau";
            if(type=='Project') t="Nouveau Projet";
            if(type=='Team') t="Nouvelle Administration";
            if(type=='Agent') { t="Nouvel Agent"; document.getElementById('qcExtra').style.display = 'block'; populateSelectBox('#qcTeamSel', appData.teams); }
            document.getElementById('qcTitle').innerText = t;
            document.getElementById('qcModal').style.display='flex';
        }
        function closeQC() { document.getElementById('qcModal').style.display='none'; }

        async function saveQC() {
            const type = document.getElementById('qcType').value;
            const name = document.getElementById('qcName').value.trim();
            if(!name) return;
            let tab, fields;
            if (type === 'Project') { tab = DB.PROJECTS; fields = { Nom_Projet: name }; }
            else if (type === 'Team') { tab = DB.TEAMS; fields = { Nom: name }; } // FIX Couleur
            else if (type === 'Agent') { tab = DB.AGENTS; fields = { Nom_Complet: name, Equipe: parseInt(document.getElementById('qcTeamSel').value)||null }; }
            await saveAction('AddRecord', tab, null, fields);
            if(type === 'Project') await loadProjects();
            if(type === 'Team') { await loadTeams(); await loadAgents(); }
            if(type === 'Agent') await loadAgents();
            populateSelects(); closeQC(); updateSyncStatus("Cr√©√© !", "var(--c-green)");
        }

        document.getElementById('taskForm').onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('inpId').value;
            const data = {
                Titre: document.getElementById('inpTitle').value,
                Projet: parseInt(document.getElementById('inpProject').value),
                Responsable: parseInt(document.getElementById('inpAgent').value),
                Date_Debut: document.getElementById('inpStart').value,
                Date_Fin: document.getElementById('inpEnd').value,
                Avancement: parseInt(document.getElementById('inpProgress').value),
                Priorite: document.getElementById('inpPriority').value
            };
            saveAction(id ? 'UpdateRecord' : 'AddRecord', DB.TASKS, id, data);
            closeModal();
        };

        // --- UTILS ---
        function openModal(task = null) {
            const form = document.getElementById('taskForm');
            if(task) {
                document.getElementById('modalTitle').innerText = "Modifier";
                document.getElementById('inpId').value = task.id;
                document.getElementById('inpTitle').value = task.Titre;
                document.getElementById('inpProject').value = task.Projet;
                document.getElementById('inpAgent').value = task.Responsable;
                document.getElementById('inpStart').value = task.start;
                document.getElementById('inpEnd').value = task.end;
                document.getElementById('inpProgress').value = task.progress;
                document.getElementById('inpPriority').value = task.Priorite;
            } else {
                form.reset();
                document.getElementById('modalTitle').innerText = "Nouveau";
                document.getElementById('inpId').value = "";
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('inpStart').value = today;
                document.getElementById('inpEnd').value = today;
            }
            document.getElementById('taskModal').style.display = 'flex';
        }
        function openModalById(id) { openModal(appData.tasks.find(x=>x.id==id)); }
        function closeModal() { document.getElementById('taskModal').style.display='none'; }
       
        function populateSelects() {
            populateSelectBox('#filterProject', appData.projects, true); populateSelectBox('#inpProject', appData.projects);
            populateSelectBox('#filterTeam', appData.teams, true);
            populateSelectBox('#filterAgent', appData.agents); populateSelectBox('#inpAgent', appData.agents);
        }
        function populateSelectBox(sel, list, useName=false) {
            document.querySelectorAll(sel).forEach(el => {
                const v=el.value; const d=el.options[0]; el.innerHTML=""; el.appendChild(d);
                list.forEach(i => { const o = document.createElement('option'); o.value=useName?i.name:i.id; o.innerText=i.name; el.appendChild(o); });
                if(list.some(i=>(useName?i.name:i.id)==v)) el.value = v;
            });
        }
        function convertTable(t) { const k=Object.keys(t); if(!k.length)return[]; const len=t.id.length; const res=[]; for(let i=0;i<len;i++){ let o={}; k.forEach(key=>o[key]=t[key][i]); res.push(o); } return res; }
        function formatDateIso(v) { if(!v) return new Date().toISOString().split('T')[0]; const d = typeof v==='number'?new Date(v*1000):new Date(v); return d.toISOString().split('T')[0]; }
        function switchView(v, btn) { document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); btn.classList.add('active'); if(v=='gantt' && ganttChart) setTimeout(()=>ganttChart.refresh(appData.tasks), 50); }
        function zoomGantt(m) { ganttChart.change_view_mode(m); }
        function updateSyncStatus(msg, color) { const dot = document.getElementById('syncDot'); dot.style.background = color; document.getElementById('syncText').textContent = msg; }
        function strColor(s) { let h=0;for(let i=0;i<s.length;i++)h=s.charCodeAt(i)+((h<<5)-h);return `hsl(${h%360},70%,40%)`; }
        // Load helpers for QC re-fetching
        async function loadProjects() { const raw=await grist.docApi.fetchTable(DB.PROJECTS); appData.projects=convertTable(raw).map(r=>({id:r.id,name:r.Nom_Projet||r.Nom})); }
        async function loadTeams() { const raw=await grist.docApi.fetchTable(DB.TEAMS); appData.teams=convertTable(raw).map(r=>({id:r.id,name:r.Nom||r.Nom_Equipe||"√âquipe"})); }
        async function loadAgents() { const raw=await grist.docApi.fetchTable(DB.AGENTS); appData.agents=convertTable(raw).map(r=>({id:r.id,name:r.Nom_Complet||r.Nom,teamName:appData.teams.find(t=>t.id===r.Equipe)?.name})); }
    </script>
</body>
</html>
